<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventory Items</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Select2 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <style>
:root {
  font-size: 90%;
  --font-sans: 'Montserrat', sans-serif;
  --primary: hsl(222.2 47.4% 11.2%);
  --primary-foreground: hsl(210 40% 98%);
  --primary-accent: hsl(217.2 91.2% 59.8%);
  --primary-accent-hover: hsl(217.2 91.2% 65.8%);

  --background: hsl(0 0% 100%);
  --foreground: hsl(222.2 47.4% 11.2%);
  --muted: hsl(210 40% 96.1%);
  --muted-foreground: hsl(215.4 16.3% 46.9%);
  --border: hsl(214.3 31.8% 91.4%);
  --card: hsl(0 0% 100%);
  --card-foreground: hsl(222.2 47.4% 11.2%);
  --dark: var(--foreground);

  --success: hsl(142.1 76.2% 36.3%);
  --warning: hsl(47.9 95.8% 53.1%);
  --error: hsl(0 84.2% 60.2%);

  --radius: 0.5rem;
  --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-sans);
      background-color: var(--muted);
      color: var(--foreground);
      margin:0;
    }

    body, button, input, select, textarea, table, th, td, h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-sans);
    }

    #appShell{
      display:flex;
      min-height:100vh;
      width:100%;
    }
    .app-shell{
      display:flex;
      flex:1;
      min-height:100vh;
      transition:padding-left 0.3s ease;
    }
    .sidebar{
      width:240px;
      background:var(--primary);
      color:var(--primary-foreground);
      display:flex;
      flex-direction:column;
      padding: 1.5rem 1rem;
      gap: 1.5rem;
      position:sticky;
      top:0;
      height:100vh;
      transition:width 0.3s ease,padding 0.3s ease,opacity 0.3s ease;
      overflow-y:auto;
    }
    .sidebar h2{
      margin:0;
      font-family:'Montserrat',sans-serif;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sidebar-brand{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:6px;
    }
    .sidebar-logo{
      width:56px;
      height:56px;
      padding:6px;
      object-fit:contain;
      object-position:center;
      border-radius:12px;
      background:rgba(255,255,255,0.08);
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
      flex-shrink:0;
    }
    .sidebar-brand-text{
      display:flex;
      flex-direction:column;
      line-height:1.2;
    }
    .sidebar-brand-text .brand-title{
      font-family: var(--font-sans);
      font-size:1.2rem;
      font-weight:600;
      color: var(--primary-foreground);
    }
    .sidebar-brand-text .brand-subtitle{
      font-size:0.8rem;
      color: var(--muted-foreground);
      letter-spacing:1px;
    }
    .sidebar-header-actions{
      margin-top:0.4rem;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sidebar-header-actions a{
      width:36px;
      height:36px;
      border-radius:8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.08);
      color: var(--primary-foreground);
      border:1px solid transparent;
      transition:background 0.2s ease,border 0.2s ease;
      text-decoration:none;
    }
    .sidebar-header-actions a:hover{
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .nav a{
      color:var(--primary-foreground);
      text-decoration:none;
      padding:10px 12px;
      border-radius:8px;
      display:flex;
      align-items:center;
      gap:10px;
      transition:background .2s ease;
    }
    .nav a:hover,
    .nav a.active{
      background: hsla(217, 91%, 60%, 0.12);
    }
    .app-shell.sidebar-collapsed .sidebar{
      width:0;
      padding:24px 0;
      opacity:0;
      pointer-events:none;
    }
    .app-shell.sidebar-collapsed .main-content{
      width:100%;
    }
    .main-content{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    .sidebar-toggle{
      width:42px;
      height:42px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: transparent;
      color: var(--muted-foreground);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background 0.2s ease,border-color 0.2s ease,color 0.2s ease;
    }
    .sidebar-toggle:hover,
    .sidebar-toggle:focus{
      background: var(--muted);
      color: var(--foreground);
      outline:none;
    }
    .sidebar-toggle i{
      font-size:1.1rem;
    }
    .app-shell.sidebar-collapsed .sidebar-toggle{
      background:#d4af37;
      color:#1a1a1a;
    }
    .header-toggle{
      width:38px;
      min-width:38px;
      height:38px;
      border-radius:10px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--foreground);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
    }
    .app-shell.sidebar-collapsed .header-toggle{
      background:#d4af37;
      color:#1a1a1a;
      border-color:#d4af37;
    }
    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      padding: 1rem 1.5rem;
      width:100%;
    }
.content > div{
  display:none;
}
.content > div.active-view{
  display:block;
}
    #suppliersView{
      display:none;
    }
    .sup-container{
      font-family: var(--font-sans);
      padding:24px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .app-header{
      margin-bottom:20px;
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:14px;
      padding:1rem 1.25rem;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .app-header--with-actions {
      justify-content:flex-start;
      gap:8px;
    }
    .app-header .header-actions,
    .app-header .header-summary {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      flex:0 0 auto;
    }
    .app-header > div:first-child{
      flex:0 0 auto;
    }
    .app-header h1{
      font-family: var(--font-sans);
      font-weight:600;
      color: var(--card-foreground);
      margin:0;
      font-size:1.3rem;
      line-height:1.2;
    }
    .bulk-inline {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .bulk-inline label {
      font-size:0.9rem;
      font-weight:600;
      color:#1e293b;
      white-space:nowrap;
    }
    .inventory-summary {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .inventory-summary .summary-totals {
      margin-left:0;
      margin-top:4px;
    }
    .inventory-summary h1 {
      margin:0;
    }
    .header-summary {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .app-header p{
      color: var(--muted-foreground);
      font-size:0.95rem;
    }
    .sup-action-bar{
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:16px;
      margin-bottom:20px;
    }
    .sup-btn-group{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .sup-btn{
      padding:10px 16px;
      border:none;
      border-radius:6px;
      font-family:'Poppins',sans-serif;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .sup-btn-primary{
      background:#1abc9c;
      color:#fff;
    }
    .sup-btn-primary:hover{ background:#16a085; }
    .sup-btn-secondary{
      background:#3498db;
      color:#fff;
    }
    .sup-btn-secondary:hover{ background:#2980b9; }
    .sup-btn-outline{
      background:transparent;
      border:1px solid #bdc3c7;
      color:#2c3e50;
    }
    .sup-btn-outline:hover{ background:#ecf0f1; }
    .sup-search-group{
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      align-items:center;
      width:100%;
    }
    .sup-search-select,
    .sup-search-input{
      padding:10px;
      border:1px solid #bdc3c7;
      border-radius:6px;
      background:#fff;
    }
    .icon-action-btn{
      width:38px;
      height:38px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--foreground);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background 0.2s ease,border-color 0.2s ease,color 0.2s ease;
    }
    .icon-action-btn:hover,
    .icon-action-btn:focus{
      background: var(--muted);
      border-color: var(--primary-accent);
      color: var(--foreground);
    }
    .sup-search-select,
    .search-group .search-select{
      flex:0 0 150px;
      min-width:150px;
    }
    .sup-search-input,
    .search-group .search-input{
      flex:1 1 240px;
      min-width:220px;
      width:auto;
    }
    .sup-search-group button{
      white-space:nowrap;
      flex:0 0 auto;
    }
    .sup-table{
      width:100%;
      border-collapse:collapse;
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .sup-table th{
      background: var(--background);
      color: var(--foreground);
      padding:12px 14px;
      text-align:left;
      font-family: var(--font-sans);
      font-weight:600;
      border-bottom:1px solid var(--border);
    }
    .sup-table td{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      color: var(--foreground);
      font-size:0.95rem;
    }
    .sup-table tr:hover{
      background: var(--muted);
    }
    .sup-action-cell{
      display:flex;
      gap:8px;
    }
    .sup-action-btn{
      border:none;
      padding:6px 10px;
      border-radius:4px;
      color:#fff;
      cursor:pointer;
      font-size:0.85rem;
    }
    .sup-edit-btn{ background:#3498db; }
    .sup-update-btn{ background:#2ecc71; display:none; }
    .sup-cancel-btn{ background:#95a5a6; display:none; }
    .sup-delete-btn{ background:#e74c3c; }
    .sup-pagination{
      display:flex;
      justify-content:center;
      gap:6px;
      margin-top:18px;
    }
    .sup-page-btn{
      padding:8px 12px;
      border:1px solid #bdc3c7;
      border-radius:4px;
      background:#fff;
      cursor:pointer;
    }
    .sup-page-btn.active{
      background:#1abc9c;
      color:#fff;
      border-color:#1abc9c;
    }
    .sup-no-data{
      text-align:center;
      padding:40px;
      background:#fff;
      border-radius:8px;
      border:1px dashed #d5dce1;
      color:#7f8c8d;
    }
    .sup-status{
      margin-top:12px;
      color:#e67e22;
      font-size:0.95rem;
    }
    .summary-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:rgba(26,188,156,0.15);
      border-radius:20px;
      color:#13866a;
      font-size:0.85rem;
      font-weight:600;
      text-transform:uppercase;
    }
    #dashboardView{
      width:100%;
    }
    #dash-container{
      width:100%;
      margin:0 auto;
      padding:0;
    }
    .dash-header{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .dash-header h2{
      font-size:2rem;
      color:#021640;
      margin-bottom:4px;
    }
    .dash-header p{
      font-size:1rem;
      color:#021640;
      opacity:0.7;
      margin-top:2px;
    }
    .dash-kpi-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;
      margin:20px 0;
    }
    .dash-kpi-card{
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      padding:15px;
      min-height:110px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      color:#021640;
    }
    .dash-kpi-card.inline-kpi{
      flex-direction:row;
      align-items:center;
      gap:10px;
      min-height:auto;
    }
    .dash-kpi-card h3{
      font-size:0.9rem;
      font-weight:500;
      display:flex;
      align-items:center;
      color:#021640;
      gap:6px;
    }
    .dash-kpi-card h2{
      font-size:1.2rem;
      font-weight:600;
      color:#021640;
    }
    .dash-kpi-card.inline-kpi .kpi-label{
      font-weight:600;
      font-size:0.95rem;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .dash-kpi-card.inline-kpi .kpi-value{
      font-size:1.05rem;
      font-weight:700;
    }
    .dash-charts-row{
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      width:100%;
    }
    .dash-main-row{
      justify-content:space-between;
    }
    .dash-trend-card{
      flex:2 1 420px;
      min-width:320px;
      min-height:360px;
    }
    .dash-small-card{
      flex:1 1 250px;
      min-height:360px;
    }
    .dash-customers-row{
      justify-content:flex-start;
      width:100%;
    }
    .dash-customers-card{
      flex:1 1 100%;
      min-width:0;
      min-height:360px;
    }
    @media (max-width: 1100px) {
      .dash-main-row {
        flex-direction:column;
      }
      .dash-trend-card,
      .dash-small-card {
        min-width:100%;
      }
      .dash-customers-row {
        justify-content:flex-start;
      }
    }
    @media (max-width: 600px) {
      .dash-chart-card {
        padding:10px;
      }
      .dash-header h3{
        font-size:0.95rem;
      }
    }
    .dash-chart-card{
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      padding:15px;
      color:#021640;
      overflow:hidden;
    }
    .dash-chart-card h3{
      font-size:1rem;
      margin-bottom:10px;
    }
    .dash-row{
      display:flex;
      flex-wrap:wrap;
      gap:20px;
    }
    .dash-half{
      flex:1 1 200px;
    }
    .dash-full{
      width:100%;
    }
    #dash-chart1,
    #dash-chart2,
    #dash-chart3,
    #dash-chart4,
    #dash-chart5,
    #dash-chart6,
    #dash-chart7{
      min-height:300px;
    }
    #dash-chart4{
      min-height:360px;
    }
    #dashboardStatus{
      margin-top:10px;
      color:#7f8c8d;
      font-size:0.9rem;
    }
    
    .inventory-container {
      width: 100%;
      max-width: none;
      margin: 0;
      background-color: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
    }
    
    .action-bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 15px;
      border: 1px solid transparent;
      border-radius: var(--radius);
      font-family: var(--font-sans);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .btn-primary {
      background-color: var(--primary-accent);
      color: var(--primary-foreground);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-accent-hover);
    }
    
    .btn-secondary {
      background-color: var(--primary);
      color: var(--primary-foreground);
    }
    
    .btn-secondary:hover {
      background-color: hsl(222.2 47.4% 20%);
    }
    
    .btn-outline {
      background-color: var(--background);
      border: 1px solid var(--border);
      color: var(--foreground);
    }
    
    .btn-outline:hover {
      background-color: var(--muted);
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-left: 0;
      z-index: 1;
      flex: 1 1 260px;
      max-width: 520px;
    }
    /* Shipping top row layout */
    .shipping-top-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .shipping-top-row .shipping-total{
      margin:0;
      min-width:220px;
      flex:0 0 auto;
    }
    .shipping-top-row .shipping-refresh{
      white-space:nowrap;
      flex:0 0 auto;
    }
    .shipping-top-row .shipping-search{
      flex:1 1 260px;
      max-width:520px;
      display:flex;
      gap:10px;
      align-items:center;
      margin-left:0;
    }
    /* Align buttons and search on Inventory Details */
    .inventory-action-bar{
      justify-content:flex-start;
      gap:16px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .inventory-action-bar .search-group{
      margin-left:0;
      flex-wrap:nowrap;
      gap:10px;
      align-items:center;
      flex:1 1 auto;
      justify-content:flex-end;
    }
    .inventory-action-bar .search-select{
      flex:0 0 150px;
      min-width:140px;
    }
    .inventory-action-bar .search-input{
      flex:1 1 220px;
      min-width:160px;
      width:auto;
    }
    .inventory-action-bar .search-group button{
      white-space:nowrap;
    }
    /* Keep filters and search controls together on summary view */
    .summary-action-bar{
      justify-content:flex-start;
      gap:16px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .summary-totals{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      font-size:0.95rem;
      font-weight:600;
      color:var(--dark);
    }
    .summary-totals span{
      background:#f1f5f9;
      border:1px solid #dbe3ed;
      border-radius:8px;
      padding:6px 10px;
    }
    .summary-action-bar .search-group{
      margin-left:0;
      flex-wrap:nowrap;
      gap:10px;
      align-items:center;
      flex:1 1 auto;
      justify-content:flex-end;
    }
    .summary-action-bar .search-select{
      flex:0 0 150px;
      min-width:140px;
    }
    .summary-action-bar .search-input{
      flex:1 1 220px;
      min-width:160px;
      width:auto;
    }
    .summary-action-bar .filter-panel{
      flex-wrap:wrap;
    }

    @media (max-width: 900px) {
      .search-group {
        max-width: none;
        flex: 1 1 100%;
      }
    }

    .filter-panel {
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 2;
    }

    .filter-label {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--gray);
      margin-right: 8px;
    }

    .filter-dropdown {
      position: relative;
      min-width: 180px;
    }

    .filter-dropdown-button {
      width: 100%;
      background: #fff;
      border: 1px solid #d7ddec;
      border-radius: 10px;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--dark);
      cursor: pointer;
    }

    .filter-dropdown-arrow {
      border: solid var(--gray);
      border-width: 0 0 1.5px 1.5px;
      display: inline-block;
      padding: 3px;
      transform: rotate(45deg);
      transition: transform 0.2s ease;
    }

    .filter-dropdown.open .filter-dropdown-arrow {
      transform: rotate(-135deg);
    }

    .filter-dropdown-panel {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      width: 220px;
      max-height: 280px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #d7ddec;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      z-index: 10;
      flex-direction: column;
    }

    .filter-dropdown.open .filter-dropdown-panel {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--dark);
      width: 100%;
      justify-content: flex-start;
    }

    .filter-option-all {
      font-weight: 600;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
      width: 100%;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .filter-actions button {
      border: 1px solid #bdc3c7;
      background: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    .filter-actions .filter-apply {
      background: #1abc9c;
      border-color: #1abc9c;
      color: #fff;
    }

    .filter-summary {
      font-size: 0.85rem;
      color: var(--dark);
      min-width: 180px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #fff;
      margin-left: 10px;
      height: 42px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-option input {
      width: 16px;
      height: 16px;
    }

    .filter-none {
      margin: 0;
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .search-select {
      padding: 9px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      background-color: var(--white);
      min-width: 160px;
    }
    
    .search-input {
      padding: 10px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      width: 250px;
    }
    
    .inventory-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--white);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .inventory-table th {
      background-color: var(--background);
      color: var(--foreground);
      padding: 14px 16px;
      text-align: left;
      font-family: var(--font-sans);
      font-weight: 600;
      font-size: 0.95rem;
      border-bottom:1px solid var(--border);
    }
    
    .inventory-table td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--foreground);
      font-size: 0.92rem;
    }
    .inventory-table th.select-col,
    .inventory-table td.select-col {
      width: 60px;
      padding-left: 12px;
      text-align: center;
    }
    .inventory-table th.id-col,
    .inventory-table td.id-col {
      width: 140px;
      white-space: nowrap;
    }
    .inventory-table th.quantity-col,
    .inventory-table td.quantity-col {
      width: 80px;
      text-align: center;
    }
    
      .inventory-table tr:hover {
        background-color: rgba(26, 188, 156, 0.05);
      }
      .item-image-cell{
        position:relative;
      }
    .item-media-cell {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .image-thumb{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }
    .image-thumb span{
      font-weight:600;
      color:var(--secondary);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .image-thumb img{
      width:70px;
      height:70px;
      border-radius:10px;
      border:1px solid #dfe4ea;
      object-fit:cover;
      box-shadow:0 4px 8px rgba(0,0,0,0.12);
      transition:transform 0.2s ease;
    }
    .image-thumb:hover img{
      transform:scale(1.05);
    }
    .barcode-thumb{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-start;
    }
    .barcode-thumb img{
      width:110px;
      height:40px;
      object-fit:contain;
      border:1px solid #dfe4ea;
      border-radius:6px;
      padding:4px;
      background:#fff;
    }
    
    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-instock {
      background-color: rgba(46, 204, 113, 0.15);
      color: var(--success);
    }
    
    .status-preorder {
      background-color: rgba(243, 156, 18, 0.15);
      color: var(--warning);
    }
    
    .status-sold {
      background-color: rgba(231, 76, 60, 0.15);
      color: var(--error);
    }
    
    .status-out-of-stock {
      background-color: rgba(149, 165, 166, 0.2);
      color: var(--foreground);
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .edit-btn {
      background-color: #3498db;
      color: white;
      border: none;
    }
    
    .update-btn {
      background-color: var(--success);
      color: white;
      border: none;
    }
    
    .cancel-btn {
      background-color: var(--gray);
      color: white;
      border: none;
    }
    
    .editable {
      background-color: #fffde7;
      border: 1px solid #ffd54f;
      padding: 5px 8px;
      border-radius: 3px;
      width: 100%;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 520px;
      max-width: 92%;
      box-shadow: 0 18px 50px rgba(15,23,42,0.25);
    }
    .modal-large .modal-content{
      width:95%;
      max-width:1200px;
      margin:40px auto;
      max-height:90vh;
      overflow:auto;
      padding:32px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      background: var(--card);
      border-radius: 12px 12px 0 0;
    }
    
    .modal-header h2 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      font-size: 1.6rem;
      margin: 0;
    }
    
    .close-btn {
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--muted-foreground);
      transition: color 0.3s, background 0.3s;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      border: 1px solid transparent;
    }

    .close-btn:hover {
      color: var(--dark);
      background: rgba(15, 23, 42, 0.18);
    }
    
    .form-group {
      margin-bottom: 22px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.95rem;
    }
    
    .form-control {
      width: 100%;
      padding: 11px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: var(--font-sans);
      font-size: 0.95rem;
    }
    
    .form-control:focus {
      border-color: var(--primary-accent);
      outline: none;
      box-shadow: 0 0 0 2px hsla(217,91%,60%,0.25);
    }
    
    .required:after {
      content: " *";
      color: var(--error);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }
    
    .processing-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 6px solid rgba(212, 175, 55, 0.25);
      border-top: 6px solid #d4af37;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .processing-overlay p{
      font-family:'Montserrat',sans-serif;
      font-size:1.1rem;
      color:#5e3370;
      letter-spacing:0.5px;
      margin:0;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .select2-container {
      width: 100% !important;
    }
    
    .id-generate {
      display: flex;
      gap: 10px;
    }
    
    .id-field {
      flex: 1;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 25px;
      gap: 6px;
    }
    
    .page-btn {
      padding: 8px 14px;
      background-color: var(--white);
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      transition: all 0.3s;
    }
    
    .page-btn:hover:not(.active) {
      background-color: var(--light-gray);
    }
    
    .page-btn.active {
      background-color: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }
    
    .no-data-container {
      text-align: center;
      padding: 50px 20px;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-top: 20px;
    }
    
    .no-data-icon {
      font-size: 3.5rem;
      color: #bdc3c7;
      margin-bottom: 20px;
    }
    
    .no-data-title {
      color: var(--gray);
      margin-bottom: 10px;
      font-family: 'Montserrat', sans-serif;
    }
    
    @media (max-width: 900px) {
      .action-bar {
        flex-direction: column;
      }
      
      .btn-group {
        width: 100%;
        justify-content: center;
      }
      
      .search-group {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 600px) {
      .search-group {
        flex-wrap: wrap;
      }
      
      .search-input {
        width: auto;
        min-width: 140px;
        flex: 1 1 160px;
      }

      .inventory-action-bar .search-group {
        flex-wrap: wrap;
        gap: 8px;
      }

      .summary-action-bar .search-group {
        flex-wrap: wrap;
        gap: 8px;
      }

      .sup-search-group {
        flex-wrap: wrap;
        gap: 8px;
      }

      .inventory-container {
        padding: 15px;
      }
    }

    /* Capture modal styling */
    .capture-layout{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
      gap:32px;
      margin-bottom:24px;
    }
    .capture-panel{
      background:#f6f8fc;
      border:1px solid #e4e7f0;
      border-radius:18px;
      padding:20px;
      min-height:360px;
      box-shadow:0 12px 25px rgba(15,23,42,0.05);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .capture-panel label{
      font-family:'Montserrat',sans-serif;
      font-weight:600;
      font-size:0.95rem;
      color:#1f2a37;
    }
    .capture-panel video,
    .capture-panel img,
    .capture-panel canvas{
      width:100%;
      border-radius:14px;
      border:1px dashed #cfd7e6;
      background:#dfe4ef;
      min-height:260px;
      object-fit:cover;
    }
    .capture-controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .capture-controls button{
      flex:1;
      min-width:140px;
      padding:12px 14px;
      border-radius:10px;
      font-weight:600;
    }
    .capture-controls .btn-primary{
      background:#1abc9c;
      border:none;
      color:#fff;
    }
    .capture-controls .btn-outline{
      border:1px solid #d1d9e5;
      background:#fff;
      color:#475569;
    }
    .pill-stack{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .pill{
      padding:4px 12px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      font-size:.78rem;
    }
    .capture-form{
      background:#fff;
      border-radius:18px;
      padding:24px;
      box-shadow:0 18px 45px rgba(15,23,42,0.08);
    }
    .capture-form h3{
      margin:0 0 16px 0;
      font-family:'Montserrat',sans-serif;
      color:#111827;
    }
    .capture-grid-form{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:18px;
    }
    .capture-grid-form label{
      font-weight:600;
      font-size:.85rem;
      margin-bottom:4px;
      color:#4b5563;
    }
    .capture-grid-form input,
    .capture-grid-form select{
      width:100%;
      padding:11px;
      border-radius:10px;
      border:1px solid #d7ddec;
      font-size:0.95rem;
    }
    .capture-grid-form input:focus,
    .capture-grid-form select:focus{
      border-color:#1abc9c;
      outline:none;
      box-shadow:0 0 0 2px rgba(26,188,156,0.2);
    }
    .size-options{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .size-options label{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border:1px solid #d0d7e9;
      border-radius:10px;
      background:#fff;
      font-weight:500;
    }
    .capture-actions{
      margin-top:20px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .capture-alert{
      margin-top:12px;
      padding:12px;
      border-radius:10px;
      background:#f1f5f9;
      color:#475569;
    }
    .capture-status{
      font-size:.9rem;
      color:#6b7280;
    }
    .barcode-layout{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:24px;
    }
    .barcode-panel,
    .barcode-result{
      background:#fff;
      border-radius:18px;
      padding:22px;
      box-shadow:0 15px 40px rgba(15,23,42,0.07);
      border:1px solid #e5e7ef;
    }
    .barcode-panel video{
      width:100%;
      min-height:280px;
      border-radius:16px;
      border:1px dashed #cdd5e7;
      background:#dfe4ef;
      object-fit:cover;
      margin-bottom:14px;
    }
    .barcode-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .barcode-actions button{
      flex:1;
      min-width:120px;
      border-radius:10px;
      padding:10px 0;
      font-weight:600;
    }
    .barcode-actions .btn-primary{
      background:#1abc9c;
      color:#fff;
      border:none;
    }
    .barcode-actions .btn-outline{
      border:1px solid #d1d9e5;
      background:#fff;
      color:#475569;
    }
    .barcode-result h3{
      font-family:'Montserrat',sans-serif;
      margin-top:0;
      color:#1f2937;
    }
    .barcode-result pre{
      background:#f6f8fc;
      border-radius:12px;
      padding:12px;
      max-height:260px;
      overflow:auto;
      border:1px solid #e5e7ef;
    }
    .modal-panel {
      background: var(--card);
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }

    .modal-panel .form-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .modal-panel .form-group {
      flex: 1 1 220px;
    }

    .modal-panel label {
      font-weight: 600;
      color: var(--muted-foreground);
    }

    .barcode-layout.modal-panel {
      padding: 24px;
      margin-bottom: 0;
      border-radius: 18px;
      box-shadow: var(--shadow);
    }

</style>
</head>
<body>
  <div id="appShell">
  <div class="app-shell">
    <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="sidebar-brand-text">
            <span class="brand-title">ZARIMANDIR</span>
            <span class="brand-subtitle">Inventory</span>
          </div>
        </div>
        <div class="sidebar-header-actions">
          <a href="#" aria-label="Notifications"><i class="fas fa-bell"></i></a>
          <a href="#" aria-label="Profile"><i class="fas fa-user-circle"></i></a>
        </div>
        <nav class="nav">
          <a href="#" id="navInventory" class="active"><i class="fas fa-boxes"></i>Inventory Details</a>
          <a href="#" id="navInventorySummary"><i class="fas fa-table-list"></i>Inventory Summary</a>
          <a href="#" id="navDashboard"><i class="fas fa-chart-line"></i>Dashboard</a>
          <a href="#" id="navSuppliers"><i class="fas fa-truck-loading"></i>Suppliers</a>
          <a href="#" id="navExpenses"><i class="fas fa-money-check-dollar"></i>Expenses</a>
          <a href="#" id="navSales"><i class="fas fa-dollar-sign"></i>Sales</a>
          <a href="#" id="navShipping"><i class="fas fa-shipping-fast"></i>Shipping</a>
        </nav>
  </aside>
    <div class="main-content">
        <div class="content">
          <div id="dashboardView" style="display:none;">
            <div id="dash-container">
              <div class="dash-header">
                <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
                  <i class="fas fa-bars"></i>
                </button>
                <h2>Dashboard</h2>
              </div>
              <div class="dash-kpi-row">
                <div class="dash-kpi-card"><h3><i class="fas fa-chart-line"></i>Total Sales</h3><h2 id="dash-total-sales">$0</h2></div>
                <div class="dash-kpi-card"><h3><i class="fas fa-shopping-cart"></i>Total Expenses</h3><h2 id="dash-total-expenses">$0</h2></div>
                <div class="dash-kpi-card"><h3><i class="fas fa-dollar-sign"></i>Net Profit</h3><h2 id="dash-net-profit">$0</h2></div>
              </div>
              <div class="dash-charts-row dash-main-row">
                <div class="dash-chart-card dash-trend-card">
                  <h3>Sales Trend</h3>
                  <div id="dash-chart1"></div>
                </div>
                <div class="dash-chart-card dash-small-card">
                  <h3>Sales By Location</h3>
                  <div id="dash-chart2"></div>
                </div>
                <div class="dash-chart-card dash-small-card">
                  <h3>Sales By Item Type</h3>
                  <div id="dash-chart7"></div>
                </div>
                <div class="dash-chart-card dash-small-card">
                  <h3>Expenses By Type</h3>
                  <div id="dash-chart6"></div>
                </div>
              </div>
              <div class="dash-charts-row dash-customers-row">
                <div class="dash-chart-card dash-customers-card">
                  <h3>Top 25 Customers</h3>
                  <div id="dash-chart4"></div>
                </div>
              </div>
              <div id="dashboardStatus"></div>
            </div>
          </div>
          <div id="suppliersView" style="display:none;">
            <div class="sup-container">
              <div class="app-header app-header--with-actions">
                <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
                  <i class="fas fa-bars"></i>
                </button>
                <div>
                  <h1>Suppliers</h1>
                </div>
                <div class="header-actions">
                  <button class="sup-btn sup-btn-primary" id="supBtnNewSupplier"><i class="fas fa-plus"></i> New Supplier</button>
                </div>
              </div>
              <div class="sup-action-bar">
                <div class="sup-search-group search-group">
                  <select id="supSearchCriteria" class="sup-search-select">
                    <option value="all">All</option>
                    <option value="Supplier Name">Supplier Name</option>
                    <option value="State">State</option>
                    <option value="City">City</option>
                  </select>
                  <input id="supSearchInput" class="sup-search-input" placeholder="Search suppliers...">
                  <button class="icon-action-btn" id="supBtnSearch" type="button" aria-label="Search suppliers">
                    <i class="fas fa-search"></i>
                  </button>
                  <button class="icon-action-btn" id="supBtnClear" type="button" aria-label="Clear supplier search">
                    <i class="fas fa-xmark"></i>
                  </button>
                </div>
              </div>
              <div id="supTableContainer">
                <table class="sup-table">
                  <thead>
                    <tr>
                      <th>Supplier ID</th>
                      <th>Supplier Name</th>
                      <th>Contact</th>
                      <th>Email</th>
                      <th>State</th>
                      <th>City</th>
                      <th>Address</th>
                      <th>Purchases</th>
                      <th>Payments</th>
                      <th>Balance</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="supTableBody"></tbody>
                </table>
                <div class="sup-pagination" id="supPagination"></div>
              </div>
              <div id="supNoData" class="sup-no-data" style="display:none;">
                <i class="fas fa-inbox" style="font-size:3rem;margin-bottom:10px;"></i>
                <h3>No suppliers found</h3>
                <p>Click "New Supplier" to add your first record.</p>
              </div>
              <div id="supStatus" class="sup-status"></div>
            </div>
          </div>
          <div id="expensesView" style="display:none;">
            <div class="sup-container">
          <div class="app-header app-header--with-summary app-header--with-actions">
            <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
              <i class="fas fa-bars"></i>
            </button>
            <div>
              <h1>Expenses</h1>
            </div>
            <div class="header-actions">
              <div class="sup-btn-group">
                <button class="sup-btn sup-btn-primary" onclick="openExpenseModal()"><i class="fas fa-plus"></i> Add Expense</button>
                <button class="sup-btn sup-btn-outline" onclick="loadExpenses()"><i class="fas fa-sync"></i> Refresh</button>
              </div>
              <div class="header-summary">
                <div class="dash-kpi-card expenses-total inline-kpi">
                  <span class="kpi-label"><i class="fas fa-wallet"></i> Total Expenses</span>
                  <span class="kpi-value" id="expensesTotalAmount">$0.00</span>
                </div>
              </div>
            </div>
          </div>
            <div class="sup-action-bar">
              <div class="sup-search-group search-group">
                <input id="expensesSearchInput" class="sup-search-input" placeholder="Search expenses...">
                <button class="icon-action-btn" type="button" onclick="searchExpenses()" aria-label="Search expenses">
                  <i class="fas fa-search"></i>
                </button>
                <button class="icon-action-btn" type="button" onclick="clearExpensesSearch()" aria-label="Clear expenses search">
                  <i class="fas fa-xmark"></i>
                </button>
              </div>
            </div>
              <div id="expensesTableContainer">
                <table class="sup-table">
                  <thead id="expensesTableHead"></thead>
                  <tbody id="expensesTableBody"></tbody>
                </table>
                <div class="sup-pagination" id="expensesPagination"></div>
              </div>
              <div id="expensesNoData" class="sup-no-data" style="display:none;">
                <i class="fas fa-wallet" style="font-size:3rem;margin-bottom:10px;"></i>
                <h3>No expenses found</h3>
                <p>Log expenses in the sheet to display them here.</p>
              </div>
              <div id="expensesStatus" class="sup-status"></div>
            </div>
          </div>
      <div id="salesView" style="display:none;">
            <div class="inventory-container">
              <div class="app-header app-header--with-actions">
                <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
                  <i class="fas fa-bars"></i>
                </button>
                <div>
                  <h1>Sales Details</h1>
                  <!-- Removed supporting text per request -->
                </div>
                <div class="header-actions">
                  <div class="btn-group">
                    <button class="btn btn-primary" onclick="openSalesModal()">
                      <i class="fas fa-file-invoice"></i> Add Sale
                    </button>
                    <button class="btn btn-outline" onclick="loadSalesRecords()">
                      <i class="fas fa-sync"></i> Refresh
                    </button>
                  </div>
                </div>
                <div class="header-summary">
                  <div class="dash-kpi-card inline-kpi">
                    <span class="kpi-label"><i class="fas fa-chart-line"></i> Total Sales</span>
                    <span class="kpi-value" id="salesTotalAmount">$0.00</span>
                  </div>
                </div>
              </div>
              <div class="action-bar">
                <div class="search-group">
                  <input type="text" id="salesSearchInput" class="search-input" placeholder="Search sales...">
                  <button class="icon-action-btn" type="button" onclick="searchSales()" aria-label="Search sales">
                    <i class="fas fa-search"></i>
                  </button>
                  <button class="icon-action-btn" type="button" onclick="clearSalesSearch()" aria-label="Clear sales search">
                    <i class="fas fa-xmark"></i>
                  </button>
                </div>
              </div>
              <div id="salesStatus" class="sup-status" style="display:none;"></div>
              <div id="salesTableWrapper">
                <table class="inventory-table">
                  <thead>
                    <tr>
                      <th>Sale Date</th>
                      <th>Amount</th>
                      <th>Customer Name</th>
                      <th>Comments</th>
                      <th>Reference</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="salesTableBody"></tbody>
                </table>
                <div id="salesNoData" class="no-data-container" style="display:none;">
                  <i class="fas fa-receipt no-data-icon"></i>
                  <h3>No sales transactions</h3>
                  <p>Click "Add Sale" to create your first record.</p>
                </div>
              </div>
              <div class="pagination" id="salesPagination"></div>
            </div>
          </div>
          <div id="shippingView" style="display:none;">
            <div class="inventory-container">
              <div class="app-header app-header--with-summary app-header--with-actions">
                <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
                  <i class="fas fa-bars"></i>
                </button>
                <div>
                  <h1>Shipping Details</h1>
                </div>
                <div class="header-actions">
                  <button class="btn btn-outline shipping-refresh" onclick="loadShippingRecords()">
                    <i class="fas fa-sync"></i> Refresh
                  </button>
                  <div class="header-summary">
                    <div class="dash-kpi-card shipping-total inline-kpi">
                      <span class="kpi-label"><i class="fas fa-ship"></i> Total Shipping Cost</span>
                      <span class="kpi-value" id="shippingTotalCost">$0.00</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="shipping-top-row">
              <div class="search-group shipping-search">
                  <input type="text" id="shippingSearchInput" class="search-input" placeholder="Search shipping records...">
                  <button class="icon-action-btn" type="button" onclick="searchShipping()" aria-label="Search shipping">
                    <i class="fas fa-search"></i>
                  </button>
                  <button class="icon-action-btn" type="button" onclick="clearShippingSearch()" aria-label="Clear shipping search">
                    <i class="fas fa-xmark"></i>
                  </button>
                </div>
              </div>
              <div id="shippingStatus" class="sup-status" style="display:none;"></div>
              <div id="shippingTableWrapper">
                <table class="inventory-table">
                  <thead>
                    <tr id="shippingTableHead"></tr>
                  </thead>
                  <tbody id="shippingTableBody"></tbody>
                </table>
                <div id="shippingNoData" class="no-data-container" style="display:none;">
                  <i class="fas fa-shipping-fast no-data-icon"></i>
                  <h3>No shipping records</h3>
                  <p>Click Refresh to pull the latest data.</p>
                </div>
              </div>
              <div class="pagination" id="shippingPagination"></div>
            </div>
          </div>
          <div id="inventoryView">
      <div class="inventory-container">
    <!-- Header Section -->
      <div class="app-header app-header--with-actions">
        <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
          <i class="fas fa-bars"></i>
        </button>
        <div>
          <h1>Inventory Details</h1>
        </div>
        <div class="header-actions">
          <div class="btn-group">
            <button class="btn btn-primary" id="btnOpenCapture">
              <i class="fas fa-box-open"></i> Add Inventory Item
            </button>
            <button class="btn btn-outline" id="btnOpenBarcode">
              <i class="fas fa-barcode"></i> Scan Barcode
            </button>
            <button class="btn btn-outline" id="btnPrintBarcodes">
              <i class="fas fa-print"></i> Print Barcodes
            </button>
          </div>
          <div class="bulk-inline">
            <label for="bulkStatusSelect">Bulk Status</label>
            <select id="bulkStatusSelect" class="bulk-status-select">
              <option value="">Select status</option>
            </select>
            <input type="date" id="bulkSoldDateInput" class="bulk-sold-date" aria-label="Sold date for bulk update" disabled>
            <button class="btn btn-outline" id="bulkUpdateButton">
              <i class="fas fa-check"></i> Update Selected
            </button>
          </div>
        </div>
      </div>
    
    <div class="action-bar inventory-action-bar">
      <div class="search-group">
        <select id="searchCriteria" class="search-select">
          <option value="all">All</option>
          <option value="Item ID">Item ID (UID)</option>
          <option value="Item Type">Item Type</option>
          <option value="Fabric">Fabric</option>
          <option value="Workstyle">Workstyle</option>
          <option value="Status">Status</option>
          <option value="Sold Date">Sold Date</option>
        </select>
        <input type="text" id="searchInput" class="search-input" placeholder="Search...">
        <button class="icon-action-btn" type="button" onclick="searchItems()" aria-label="Search inventory">
          <i class="fas fa-search"></i>
        </button>
        <button class="icon-action-btn" type="button" onclick="clearSearch()" aria-label="Clear inventory search">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Print Barcodes Modal -->
  <div id="printModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Print Barcodes</h2>
        <span class="close-btn" onclick="closeBarcodePrintModal()">&times;</span>
      </div>
      <div class="modal-body modal-panel">
        <div class="form-row">
          <div class="form-group">
            <label for="printItemType">Item Type</label>
            <select id="printItemType" class="form-control">
              <option value="">Any</option>
            </select>
          </div>
          <div class="form-group">
            <label for="printStatus">Status</label>
            <select id="printStatus" class="form-control">
              <option value="">Any</option>
            </select>
          </div>
          <div class="form-group">
            <label for="printSize">Size</label>
            <input type="text" id="printSize" class="form-control" placeholder="Any">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="printDateFrom">Date Ordered From</label>
            <input type="date" id="printDateFrom" class="form-control">
          </div>
          <div class="form-group">
            <label for="printDateTo">Date Ordered To</label>
            <input type="date" id="printDateTo" class="form-control">
          </div>
          <div class="form-group">
            <label for="printTemplate">Label Template</label>
            <select id="printTemplate" class="form-control">
              <option value="avery-5160">Avery 5160 (3x10, Letter)</option>
            </select>
          </div>
        </div>
        <div id="printMatchCount" class="capture-alert" style="background:transparent;color:#334155;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeBarcodePrintModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyBarcodePrintFilters()">Preview &amp; Print</button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Preview</h2>
        <span class="close-btn" onclick="closePreviewModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="previewInfo" style="margin-bottom:12px;font-weight:600;color:#334155;"></div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;">
          <div style="flex:1;min-width:260px;">
            <h4 style="margin:0 0 8px 0;">Image</h4>
            <img id="previewImage" alt="Item image" style="max-width:100%;border:1px solid #e2e8f0;border-radius:8px;display:none;">
            <div><a id="previewImageLink" href="#" target="_blank" rel="noopener">Open image</a></div>
          </div>
          <div style="flex:1;min-width:260px;">
            <h4 style="margin:0 0 8px 0;">Barcode</h4>
            <img id="previewBarcode" alt="Barcode" style="max-width:100%;border:1px solid #e2e8f0;border-radius:8px;display:none;">
            <div><a id="previewBarcodeLink" href="#" target="_blank" rel="noopener">Open barcode</a></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closePreviewModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add Inventory Item Modal -->
  <div id="captureModal" class="modal modal-large">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Inventory Item</h2>
        <span class="close-btn" onclick="closeCaptureModal()">&times;</span>
      </div>
      <div class="capture-layout">
        <div class="capture-panel">
          <label>Camera Preview</label>
          <video id="capVid" autoplay playsinline muted></video>
          <canvas id="capSnapCanvas" style="display:none;"></canvas>
          <div class="capture-controls">
            <button class="btn btn-primary" id="capBtnSnap">Snap</button>
            <button class="btn btn-outline" id="capBtnUpload">Upload Photo</button>
            <button class="btn btn-outline" id="capBtnRetake" style="display:none;">Retake</button>
            <button class="btn btn-secondary" id="capBtnUse" style="display:none;">Use Photo</button>
            <input type="file" id="capUploadInput" accept="image/*" style="display:none;">
          </div>
          <div class="capture-alert" id="capErr" style="color:var(--error);background:transparent;"></div>
        </div>
        <div class="capture-panel">
          <label>Captured Photo</label>
          <img id="capPreview" alt="Captured preview" />
          <div class="pill-stack">
            <span class="pill" id="capUidPill"></span>
            <span class="pill" id="capMd5Pill"></span>
          </div>
          <div class="capture-alert" id="capMsg">Use the camera or upload an existing photo to add garments and upload to Sheets.</div>
        </div>
      </div>
      <div class="capture-form">
        <h3 style="font-family:'Montserrat',sans-serif;margin-bottom:12px;">Item Attributes</h3>
        <div class="capture-grid-form">
          <div>
            <label>ITEM TYPE</label>
            <select id="CAP_ITEM_TYPE">
            <option value="SAREE">SAREE</option>
            <option value="LEHENGA">LEHENGA</option>
            <option value="KURTI">KURTI</option>
            <option value="3 PIECE">3 PIECE</option>
            <option value="FANCY SAREE">FANCY SAREE</option>
            <option value="FROCK">FROCK</option>
            <option value="DRESS">DRESS</option>
            <option value="TOPS">TOPS</option>
            <option value="COORD">COORD</option>
            </select>
          </div>
          <div>
            <label>FABRIC</label>
            <input id="CAP_FABRIC" list="capFabricList" placeholder="Type or pick fabric" />
          </div>
          <div>
            <label>WORK STYLE</label>
            <input id="CAP_WORKSTYLE" list="capWorkstyleList" placeholder="Type to search" />
          </div>
          <div>
            <label>COLOR</label>
            <input id="CAP_COLOR_VISIBLE" list="capColorList" placeholder="Type or pick color" autocomplete="off" />
            <input type="hidden" id="CAP_COLOR" />
            <div id="CAP_COLOR_OTHER_WRAP" style="display:none;margin-top:6px;">
              <input id="CAP_COLOR_OTHER" placeholder="Enter other color" />
            </div>
          </div>
          <div>
            <label>SUPPLIERS</label>
            <input id="CAP_VENDOR_VISIBLE" list="capVendorList" placeholder="Type or pick supplier" autocomplete="off" />
            <input type="hidden" id="CAP_VENDOR" />
            <div id="CAP_VENDOR_OTHER_WRAP" style="display:none;margin-top:6px;">
              <input id="CAP_VENDOR_OTHER" placeholder="Enter other supplier" />
            </div>
          </div>
          <div>
            <label>WHOLESALE PRICE</label>
            <input id="CAP_WHOLESALE" type="number" step="0.01" />
          </div>
          <div>
            <label>QTY</label>
            <input id="CAP_QTY" type="number" min="1" value="1" />
          </div>
          <div>
            <label>Retail Price (USD)</label>
            <input id="CAP_RETAIL_PREVIEW" type="text" readonly placeholder="Auto-calculated" />
          </div>
          <div>
            <label>Total Sale Price (USD)</label>
            <input id="CAP_TOTAL_PREVIEW" type="text" readonly placeholder="Auto-calculated" />
          </div>
          <div>
            <label>DATE ORDERED</label>
            <input id="CAP_DATE_ORDERED" type="date" />
          </div>
          <div>
            <label>SOLD DATE</label>
            <input id="CAP_SOLD_DATE" type="date" />
            <small id="CAP_SOLD_DATE_HINT" style="display:block;margin-top:4px;color:#64748b;">Required when status is SOLD</small>
          </div>
          <div>
            <label>STATUS</label>
            <select id="CAP_STATUS"></select>
          </div>
        </div>
        <div style="margin-top:18px;">
          <label>SIZE (select all that apply)</label>
          <div class="size-options" id="CAP_SIZE_OPTIONS"></div>
          <div style="margin-top:8px;">
            <label>Other Sizes</label>
            <input id="CAP_SIZE_OTHER" placeholder="Comma separated sizes" />
          </div>
          <small id="CAP_SIZE_HINT" style="display:block;margin-top:4px;color:#64748b;">Leave blank for Saree types.</small>
          <input type="hidden" id="CAP_SIZE" />
        </div>
        <div class="capture-actions">
          <button class="btn btn-primary" id="capBtnSubmit" disabled>Generate Barcode & Upload</button>
          <button class="btn btn-outline" id="capBtnReset">Reset</button>
        </div>
        <div class="capture-alert" id="capResultCard" style="display:none;">
          <strong>Upload complete.</strong> <span id="capResultText"></span>
          <div style="margin-top:6px;display:flex;gap:10px;flex-wrap:wrap;">
            <a id="capRowUrl" target="_blank">Open row</a>
            <a id="capImageLink" target="_blank">Image</a>
            <a id="capBarcodeLink" target="_blank">Barcode</a>
            <a id="capQrLink" target="_blank">QR</a>
          </div>
        </div>
        <canvas id="capBarcodeCanvas" width="600" height="180" style="display:none;"></canvas>
        <canvas id="capQrCanvas" width="256" height="256" style="display:none;"></canvas>
      </div>
    </div>
  </div>

  <!-- Barcode Scanner Modal -->
  <div id="barcodeModal" class="modal modal-large">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Scan Barcode</h2>
        <span class="close-btn" onclick="closeBarcodeModal()">&times;</span>
      </div>
      <div class="barcode-layout modal-panel">
        <div class="barcode-panel">
          <label>Scanner</label>
          <video id="barcodeVideo" playsinline></video>
          <div class="barcode-actions">
            <button class="btn btn-primary" id="barcodeStartBtn">Start Scanning</button>
            <button class="btn btn-outline" id="barcodeStopBtn" disabled>Stop</button>
          </div>
          <div id="barcodeScanStatus" class="capture-alert" style="margin-top:10px;">Aim the camera at a barcode to search the inventory.</div>
        </div>
        <div class="barcode-result">
          <div id="barcodeResultTable" style="display:none;">
            <h3>Matching Item</h3>
            <table class="inventory-table"></table>
          </div>
          <div><strong>Detected Value:</strong> <span id="barcodeValue" style="color:var(--primary);"></span></div>
          <div id="barcodeResultMessage" style="margin-top:10px;color:#475569;">No scan yet.</div>
          <pre id="barcodeRowData" style="display:none;margin-top:12px;"></pre>
        </div>
      </div>
    </div>
  </div>

    <!-- Inventory Table -->
    <div id="tableContainer">
      <table class="inventory-table">
        <thead>
          <tr>
            <th class="select-col" width="4%">Select</th>
            <th class="id-col" width="8%">Item ID</th>
            <th width="10%">Item Type</th>
            <th width="10%">Fabric</th>
            <th width="10%">Color</th>
            <th width="10%">Size</th>
            <th width="14%">Workstyle</th>
            <th width="12%">Preview</th>
            <th class="quantity-col" width="6%">Quantity</th>
            <th width="8%">Retail Price</th>
            <th width="6%">Status</th>
            <th width="6%">Date Ordered</th>
            <th width="6%">Sold Date</th>
            <th width="4%">Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be populated by JavaScript -->
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination">
        <!-- Pagination buttons will be added here -->
      </div>
    </div>
    
    <!-- No Data Message -->
    <div id="noData" class="no-data-container" style="display:none;">
      <i class="fas fa-inbox no-data-icon"></i>
      <h3 class="no-data-title">No inventory details found</h3>
      <p>Click "Add Inventory Item" to add your first item</p>
    </div>
  </div> <!-- /inventory-container -->
</div> <!-- /inventoryView -->

          <div id="inventorySummaryView" style="display:none;">
            <div class="inventory-container">
          <div class="app-header app-header--with-summary inventory-summary">
            <button class="sidebar-toggle header-toggle" aria-label="Toggle navigation" aria-expanded="true">
              <i class="fas fa-bars"></i>
            </button>
            <h1>Inventory Summary</h1>
            <div class="summary-totals" id="summaryTotals">
              <span>Sold: 0</span>
              <span>In Stock: 0</span>
            </div>
          </div>
              <div class="action-bar summary-action-bar">
                <div class="filter-panel">
                  <div class="filter-label">Filters</div>
                  <div class="filter-dropdown" data-filter="color">
                      <button type="button" class="filter-dropdown-button">
                        <span>Color</span>
                        <span class="filter-dropdown-arrow"></span>
                      </button>
                      <div class="filter-dropdown-panel" id="summaryColorFilter"></div>
                    </div>
                    <div class="filter-dropdown" data-filter="size">
                      <button type="button" class="filter-dropdown-button">
                        <span>Size</span>
                        <span class="filter-dropdown-arrow"></span>
                      </button>
                      <div class="filter-dropdown-panel" id="summarySizeFilter"></div>
                    </div>
                </div>
                <div class="filter-summary" id="summaryFilterSummary">No filters applied.</div>
                <div class="search-group">
                  <select id="summarySearchCriteria" class="search-select">
                    <option value="all">All</option>
                    <option value="FABRIC">Fabric</option>
                    <option value="COLOR">Color</option>
                    <option value="SIZE">Size</option>
                    <option value="WORK STYLE">Work Style</option>
                    <option value="ITEM TYPE">Item Type</option>
                    <option value="STATUS">Status</option>
                  </select>
                  <input type="text" id="summarySearchInput" class="search-input" placeholder="Search summary records...">
                  <button class="icon-action-btn" type="button" onclick="searchSummaryItems()" aria-label="Search summary">
                    <i class="fas fa-search"></i>
                  </button>
                  <button class="icon-action-btn" type="button" onclick="clearSummarySearch()" aria-label="Clear summary search">
                    <i class="fas fa-xmark"></i>
                  </button>
                </div>
            </div>
            <div id="summaryTableContainer" class="table-container">
              <table class="inventory-table">
                <thead id="summaryTableHead"></thead>
                <tbody id="summaryTableBody"></tbody>
                  </table>
                  <div class="pagination" id="summaryPagination"></div>
                </div>
                <div id="summaryNoData" class="no-data-container" style="display:none;">
                  <i class="fas fa-database no-data-icon"></i>
                  <h3 class="no-data-title">No summary data available</h3>
                  <p>Adjust filters or capture inventory to populate this view.</p>
                </div>
              </div>
            </div>

        </div> <!-- /content -->
      </div> <!-- /main-content -->
    </div> <!-- /app-shell -->
  </div> <!-- /appShell -->

  <!-- New Item Type Modal -->
  <div id="typeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Item Type</h2>
        <span class="close-btn" onclick="closeTypeModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Item Type</label>
        <input type="text" id="newType" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeTypeModal()">Close</button>
        <button class="btn btn-primary" onclick="saveNewType()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- New Fabric Modal -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Fabric</h2>
        <span class="close-btn" onclick="closeCategoryModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Fabric</label>
        <input type="text" id="newCategory" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeCategoryModal()">Close</button>
        <button class="btn btn-primary" onclick="saveNewCategory()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- New Workstyle Modal -->
  <div id="subcategoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Workstyle</h2>
        <span class="close-btn" onclick="closeSubcategoryModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Workstyle</label>
        <input type="text" id="newSubcategory" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSubcategoryModal()">Close</button>
        <button class="btn btn-primary" onclick="saveNewSubcategory()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- New Inventory Item Modal -->
  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Inventory Item</h2>
        <span class="close-btn" onclick="closeInventoryModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Item ID</label>
        <div class="id-generate">
          <input type="text" id="inventoryId" class="form-control id-field" readonly>
          <button class="btn btn-secondary" onclick="generateInventoryId()">Generate</button>
        </div>
      </div>
      <div class="form-group">
        <label class="required">Item Type</label>
        <select id="itemType" class="form-control" style="width:100%"></select>
      </div>
      <div class="form-group">
        <label class="required">Fabric</label>
        <select id="itemCategory" class="form-control" style="width:100%"></select>
      </div>
      <div class="form-group">
        <label class="required">Workstyle</label>
        <select id="itemSubcategory" class="form-control" style="width:100%"></select>
      </div>
      <div class="form-group">
        <label class="required">Item Name</label>
        <input type="text" id="itemName" class="form-control" required>
      </div>
      <div class="form-group">
        <label class="required">Status</label>
        <select id="inventoryStatus" class="form-control"></select>
      </div>
      <div class="form-group">
        <label>Sold Date</label>
        <input type="date" id="inventorySoldDate" class="form-control">
        <small id="inventorySoldDateHint" style="display:block;margin-top:4px;color:#64748b;">Required when status is SOLD</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeInventoryModal()">Close</button>
        <button class="btn btn-primary" onclick="saveNewInventoryItem()">Save</button>
      </div>
    </div>
  </div>
  <div id="salesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="salesModalTitle">Add Sale</h2>
        <span class="close-btn" onclick="closeSalesModal()">&times;</span>
      </div>
      <div class="modal-body modal-panel">
        <div class="form-group">
          <label class="required">Sale Date</label>
          <input type="date" id="saleDate" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="required">Amount</label>
          <input type="number" id="saleAmount" min="0" step="0.01" class="form-control">
        </div>
        <div class="form-group">
          <label class="required">Customer Name</label>
          <input type="text" id="saleCustomer" class="form-control" placeholder="Customer or channel">
        </div>
        <div class="form-group">
          <label>Reference</label>
          <input type="text" id="saleReference" class="form-control" placeholder="Invoice, order number, etc.">
        </div>
        <div class="form-group">
          <label>Comments</label>
          <textarea id="saleNotes" class="form-control" rows="3" placeholder="Optional comments"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" type="button" onclick="closeSalesModal()">Close</button>
        <button class="btn btn-primary" type="button" onclick="saveSaleRecord()">Save</button>
      </div>
    </div>
  </div>
  <div id="expensesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="expensesModalTitle">Add Expense</h2>
        <span class="close-btn" onclick="closeExpenseModal()">&times;</span>
      </div>
      <div class="modal-body modal-panel">
        <div class="form-group">
          <label class="required">Expense Date</label>
          <input type="date" id="expenseDate" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="required">Spent Amount</label>
          <input type="number" id="expenseAmount" min="0" step="0.01" class="form-control">
        </div>
        <div class="form-group">
          <label class="required">Vendor</label>
          <input list="capVendorList" id="expenseVendor" class="form-control" placeholder="Vendor name">
        </div>
        <div class="form-group">
          <label class="required">Type</label>
          <input type="text" id="expenseType" class="form-control" placeholder="Expense category">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" type="button" onclick="closeExpenseModal()">Close</button>
        <button class="btn btn-primary" type="button" onclick="saveExpenseRecord()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Processing Overlay -->
  <div id="processingOverlay" class="processing-overlay">
    <div class="spinner"></div>
    <p id="processingOverlayText">Processing...</p>
  </div>

  <!-- Supplier Modals -->
  <div id="supSupplierModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Supplier</h2>
        <span class="close-btn" onclick="supCloseSupplierModal()">&times;</span>
      </div>
      <div class="modal-body modal-panel">
        <div class="form-group">
          <label class="required">Supplier ID</label>
          <div style="display:flex;gap:8px;">
            <input id="supSupplierId" class="form-control" readonly>
            <button class="btn btn-secondary" type="button" onclick="supGenerateSupplierId()">Generate</button>
          </div>
        </div>
        <div class="form-group">
          <label class="required">Supplier Name</label>
          <input id="supSupplierName" class="form-control" type="text" required>
        </div>
        <div class="form-group">
          <label>Contact</label>
          <input id="supSupplierContact" class="form-control" type="text">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input id="supSupplierEmail" class="form-control" type="email">
        </div>
        <div class="form-group">
          <label class="required">State</label>
          <select id="supSupplierState" class="form-control"></select>
        </div>
        <div class="form-group">
          <label class="required">City</label>
          <select id="supSupplierCity" class="form-control"></select>
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="supSupplierAddress" class="form-control" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="supCloseSupplierModal()">Close</button>
        <button class="btn btn-primary" onclick="supSaveNewSupplier()">Save</button>
      </div>
    </div>
  </div>

  <datalist id="capFabricList">
    <option value="CHINON"><option value="COTTON"><option value="DOLA SILK"><option value="MUL COTTON"><option value="MUSLIN"><option value="ROMAN SILK"><option value="RUSSIAN SILK"><option value="TISSUE"><option value="ZAKARD SILK"><option value="GEORGETTE SILK"><option value="CHIFFON SILK"><option value="JUTE FABRIC"><option value="CREPE FABRIC"><option value="VELVET FABRIC"><option value="LENIN"><option value="BENGALI COTTON"><option value="GLASS TISSUE"><option value="TUSSER"><option value="MULBERRY SILK"><option value="VICHITRA SILK TUSSER"><option value="ASSAM SILK"><option value="COSA SILK"><option value="CANDY CRUSH"><option value="BHAGALPUR"><option value="MUL CHANDERI"><option value="DIGITAL CHINON"><option value="RUSSIAN JAQUARD"><option value="VATICAN SILK"><option value="RYAN COTTON"><option value="COTTON SILK"><option value="KOTA TISSUE"><option value="KOTA TISSUE EMBROIDERY"><option value="CRUSHED TISSUE"><option value="SOFT SILK PAITHANI"><option value="BANARASI PATOLA"><option value="BANARASI JAAL WEAVING"><option value="CREPE"><option value="CHANDERI"><option value="MANGALAGIRI"><option value="MANGALAGIRI WITH KALAMKARI"><option value="ZARI KOTA"><option value="GEORGETTE"><option value="RANGKAT"><option value="BANARAS SILK"><option value="PATOLA"><option value="BANARAS MASHRU SILK"><option value="BANARAS"><option value="VISCOSE ORGANZA"><option value="KOTA">
  </datalist>
  <datalist id="capWorkstyleList">
    <option value="AQUA BLUE DUPATTA"><option value="A-LINE"><option value="BANDINI"><option value="FLORAL DUPATTA"><option value="FLORAL"><option value="JAMDANI"><option value="MIRROR"><option value="OMBRE"><option value="PLAIN"><option value="PAINTED"><option value="PURPLE DUPATTA"><option value="PEARL"><option value="ROUND & V NECK"><option value="THREAD WORK"><option value="COORD">
  </datalist>
  <datalist id="capColorList">
    <option value="GREEN"><option value="MUSTARD YELLOW"><option value="PEACH"><option value="LIGHT PINK"><option value="PINK"><option value="YELLOW"><option value="SEA GREEN"><option value="MAROON"><option value="LIGHT GREEN"><option value="RUST COLOR"><option value="WHITE BLACK"><option value="BROWN"><option value="CREAM"><option value="LAVENDER"><option value="PISTA GREEN"><option value="WHITE"><option value="MAROON BLACK"><option value="WHITE PINK"><option value="BLUE INDIGO"><option value="NAVY BLUE"><option value="MEHENDI"><option value="POWDER BLUE"><option value="BLACK"><option value="ROYAL BLUE"><option value="PALE YELLOW"><option value="RANI PINK"><option value="ONION"><option value="BLUE"><option value="PURPLE"><option value="GRAY"><option value="LIGHT BLUE"><option value="SEA BLUE"><option value="ORANGE"><option value="RED"><option value="RAMABLUE"><option value="BABY PINK"><option value="IVORY"><option value="LIME GREEN"><option value="PEACOCK BLUE"><option value="WINE"><option value="ASH"><option value="SKY BLUE"><option value="HALF-WHITE"><option value="MUSTARD"><option value="COPPER"><option value="BURN PEACH"><option value="PISTA LIGHT"><option value="BLACK & GREEN"><option value="BISCUIT"><option value="OTHER">
  </datalist>
  <datalist id="capVendorList">
    <option value="TRADITIONAL MANUFACTURERS"><option value="NAMAN CREATIONS"><option value="GANGH BROTHERS"><option value="HAFEEZ"><option value="FASHION WARE"><option value="KAPOOR CREATIONS"><option value="JAIPUR KURTI HUB"><option value="SELECT STYLE"><option value="OTHER">
  </datalist>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
  <script src="https://unpkg.com/bwip-js/dist/bwip-js-min.js"></script>
<script>
const navEls = { inventory: null, summary: null, dashboard: null, suppliers: null, sales: null, shipping: null, expenses: null };
const dashboardState = { loaded: false, charts: [] };
let activeView = 'inventory';
const supplierState = { loaded: false };
const salesState = { loaded: false, records: [], filtered: [], currentPage: 1, pageSize: 20, editingIndex: null };
const shippingState = { loaded: false, headers: [], records: [], filtered: [], currentPage: 1, pageSize: 20, totalCost: 0 };

let supAllSuppliers = [];
let supFilteredSuppliers = [];
let supStates = [];
let supCities = [];
let supCurrentPage = 1;
const supPageSize = 20;

let allItems = [];
let filteredItems = [];
let summaryPivotRows = [];
let summaryFilteredPivotRows = [];
let summaryGroupHeaders = [];
let summaryStatusColumns = [];
let summaryCurrentPage = 1;

let currentPage = 1;
const pageSize = 25;
let types = [];
let categories = [];
let subcategories = [];
const STATUS_CHOICES = [
  { value: 'INSTOCK', label: 'In Stock' },
  { value: 'SOLD', label: 'Sold' },
  { value: 'PREORDER', label: 'Preorder' },
  { value: 'OUT OF STOCK', label: 'Out of Stock' }
];
const SALES_COLUMNS = [
  { key: 'SALE_DATE', label: 'Sale Date' },
  { key: 'AMOUNT', label: 'Amount' },
  { key: 'CUSTOMER_NAME', label: 'Customer Name' },
  { key: 'COMMENTS', label: 'Comments' },
  { key: 'REFERENCE', label: 'Reference' }
];

let salesRows = [];
let salesFilteredRows = [];
const summaryPageSize = 25;

const COLOR_OTHER_TOKEN = 'OTHER';
const CAP_SIZE_OPTIONS = ['36','38','40','42','44','46','48'];
const captureState = { stream: null, photoDataUrl: null, resizedDataUrl: null, uid: null, md5: null };
const capEls = {};
const barcodeEls = {};
let barcodeReader = null;
let barcodeControls = null;


function showProcessing(message) {
  const overlay = document.getElementById('processingOverlay');
  if (!overlay) return;
  const textEl = document.getElementById('processingOverlayText');
  if (textEl) textEl.textContent = message || 'Processing...';
  overlay.style.display = 'flex';
}

function hideProcessing() {
  const overlay = document.getElementById('processingOverlay');
  if (!overlay) return;
  overlay.style.display = 'none';
}

function normalizeColumnHeader(label) {
  return String(label || '')
    .toUpperCase()
    .replace(/[^A-Z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '');
}

function buildTableHeaderIndexMap(selector) {
  const headers = document.querySelectorAll(selector);
  const map = {};
  headers.forEach((cell, index) => {
    if (!cell) return;
    const key = normalizeColumnHeader(cell.textContent || cell.innerText || '');
    if (key) {
      map[key] = index;
    }
  });
  return map;
}

function resolveColumnIndex(headerMap, names, fallback = -1) {
  if (headerMap) {
    const candidates = Array.isArray(names) ? names : [names];
    for (const name of candidates) {
      if (!name) continue;
      const key = normalizeColumnHeader(name);
      if (!key) continue;
      if (Object.prototype.hasOwnProperty.call(headerMap, key)) {
        return headerMap[key];
      }
    }
  }
  return fallback;
}

function renderPaginationButtons(containerId, totalPages, currentPage, onChange) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  if (!onChange || totalPages <= 1) return;
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
    btn.textContent = i;
    btn.addEventListener('click', () => {
      if (i === currentPage) return;
      onChange(i);
    });
    container.appendChild(btn);
  }
}

function normalizeDateValue(value) {
  if (value === null || value === undefined || value === '') return null;
  if (value instanceof Date && !isNaN(value.getTime())) return value;
  if (typeof value === 'number') {
    const asMillis = value > 10000000000 ? value : Math.round((Number(value) - 25569) * 86400000);
    const fromNumber = new Date(asMillis);
    return Number.isNaN(fromNumber.getTime()) ? null : fromNumber;
  }
  const str = String(value).trim();
  if (!str) return null;
  const parsed = new Date(str);
  return Number.isNaN(parsed.getTime()) ? null : parsed;
}

function formatDateForInput(value) {
  const date = normalizeDateValue(value);
  return date ? date.toISOString().slice(0, 10) : '';
}

function formatDisplayDate(value) {
  const date = normalizeDateValue(value);
  if (!date) {
    return value || '';
  }
  return date.toLocaleDateString();
}

function formatCurrencyDisplay(value) {
  if (value === null || value === undefined || value === '') return '';
  const cleaned = typeof value === 'string' ? value.replace(/[^0-9.\-]/g, '') : value;
  const num = Number(cleaned);
  if (Number.isNaN(num)) {
    return value;
  }
  return '$' + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}


function dashFmt(value){
  const num = Number(value) || 0;
  return '$' + Math.round(num).toLocaleString('en-US');
}

function loadDashboardData(){
  const status = document.getElementById('dashboardStatus');
  if (status) status.textContent = 'Loading dashboard...';
  google.script.run
    .withSuccessHandler(function(data){
      dashboardState.loaded = true;
      if (status) status.textContent = '';
      renderDashboard(data || {});
    })
    .withFailureHandler(function(err){
      if (status) status.textContent = err.message || 'Unable to load dashboard.';
    })
    .dashGetDashboardData();
}

function destroyDashboardCharts(){
  dashboardState.charts.forEach(chart=>{
    if (chart && typeof chart.destroy === 'function'){
      chart.destroy();
    }
  });
  dashboardState.charts = [];
}

function renderDashboard(data){
  const assign = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  };
  assign('dash-total-sales', dashFmt(data.totalSales));
  assign('dash-total-expenses', dashFmt(data.totalExpenses));
  assign('dash-net-profit', dashFmt(data.netProfit));

  destroyDashboardCharts();

  const trend = data.salesTrend || { dates: [], values: [] };
  const formatCurrency = value => {
    const num = Number(value) || 0;
    return '$' + Math.round(num).toLocaleString('en-US');
  };
  const chart1 = new ApexCharts(document.querySelector('#dash-chart1'), {
    chart:{ type:'area', height:300, fontFamily:'Poppins, sans-serif', toolbar:{ show:false } },
    series:[{ name:'Sales', data: trend.values }],
    dataLabels:{ enabled:false },
    stroke:{ curve:'smooth', width:2, colors:['#021640'] },
    fill:{
      type:'gradient',
      gradient:{ shade:'light', type:'vertical', shadeIntensity:0.8, opacityFrom:0.7, opacityTo:0.2, stops:[0,100] },
      colors:['#021640']
    },
    markers:{ size:2, colors:['#021640'], strokeColors:['#021640'], strokeWidth:2 },
    xaxis:{ type:'datetime', categories: trend.dates, labels:{ format:'MMM-yy', style:{ colors:'#021640', fontSize:'12px' } } },
    yaxis:{ labels:{ formatter:formatCurrency, style:{ colors:'#021640', fontSize:'12px' } } },
    tooltip:{ x:{ format:'MMM yyyy' }, y:{ formatter:formatCurrency } },
    colors:['#021640'],
    grid:{ borderColor:'#e0e0e0', strokeDashArray:4 }
  });
  chart1.render();
  dashboardState.charts.push(chart1);

  const loc = data.salesByLocation || { labels: [], values: [] };
  const chart2 = new ApexCharts(document.querySelector('#dash-chart2'), {
    chart:{ type:'bar', height:300, toolbar:{ show:false } },
    series:[{ data: loc.values }],
    dataLabels:{ enabled:false },
    plotOptions:{ bar:{ columnWidth:'80%', borderRadius:4 } },
    xaxis:{ categories: loc.labels, labels:{ style:{ colors:'#021640' } } },
    yaxis:{ labels:{ show:false }, axisTicks:{ show:false }, axisBorder:{ show:false } },
    tooltip:{ y:{ formatter:v=> (Number(v) || 0).toLocaleString() } },
    colors:['#0066CC'],
    grid:{ strokeDashArray:4 }
  });
  chart2.render();
  dashboardState.charts.push(chart2);

  const itemTypeData = data.salesByCategory || { labels: [], values: [] };
  const itemTypeLabels = itemTypeData.labels || [];
  const itemTypeValues = itemTypeData.values || [];
  const itemTypeSeries = [];
  const itemTypeCategories = [];
  itemTypeLabels.forEach((label, index) => {
    const value = itemTypeValues[index] || 0;
    itemTypeSeries.push(value);
    itemTypeCategories.push(label);
  });
  const chart7 = new ApexCharts(document.querySelector('#dash-chart7'), {
    chart:{ type:'donut', height:300 },
    series: itemTypeSeries,
    labels: itemTypeCategories,
    plotOptions:{ pie:{ donut:{ size:'55%' } } },
    dataLabels:{ enabled:true },
    colors:['#021640','#1F4E79','#0066CC','#0099CC','#4572C4','#008080','#CC5500'],
    tooltip:{ y:{ formatter:formatCurrency } },
    legend:{ position:'bottom' }
  });
  chart7.render();
  dashboardState.charts.push(chart7);

  const rawTopCust = data.topCustomers || { labels: [], values: [] };
  const topCust = {
    labels: (rawTopCust.labels || []).slice(0, 25),
    values: (rawTopCust.values || []).slice(0, 25)
  };
  const chart4 = new ApexCharts(document.querySelector('#dash-chart4'), {
    chart:{ type:'bar', height:360, toolbar:{ show:false } },
    series:[{ data: topCust.values }],
    dataLabels:{ enabled:false },
    plotOptions:{ bar:{ columnWidth:'60%', borderRadius:4 } },
    xaxis:{
      categories: topCust.labels,
      labels:{ style:{ colors:'#021640' } }
    },
    colors:['#0099CC'],
    tooltip:{
      y:{ formatter:function(v){ const num=Number(v)||0; return '$'+Math.round(num).toLocaleString('en-US'); } }
    },
    grid:{ strokeDashArray:4 }
  });
  chart4.render();
  dashboardState.charts.push(chart4);

  const expenseCat = data.expenseByCategory || { labels: [], values: [] };
  const chart6 = new ApexCharts(document.querySelector('#dash-chart6'), {
    chart:{ type:'bar', height:300, toolbar:{ show:false } },
    series:[{ data: expenseCat.values }],
    dataLabels:{ enabled:false },
    plotOptions:{ bar:{ borderRadius:4, columnWidth:'70%' } },
    xaxis:{ categories: expenseCat.labels, labels:{ style:{ colors:'#021640' } } },
    yaxis:{ labels:{ formatter:formatCurrency, style:{ colors:'#021640' } } },
    colors:['#021640'],
    legend:{ show:false },
    grid:{ strokeDashArray:4 }
  });
  chart6.render();
  dashboardState.charts.push(chart6);

}


function collectSaleFormData(){
  return {
    rowIndex: salesState.editingIndex !== null ? salesState.editingIndex : null,
    saleDate: (document.getElementById('saleDate')?.value || '').trim(),
    amount: Number(document.getElementById('saleAmount')?.value) || 0,
    customerName: (document.getElementById('saleCustomer')?.value || '').trim(),
    reference: (document.getElementById('saleReference')?.value || '').trim(),
    comments: (document.getElementById('saleNotes')?.value || '').trim()
  };
}

function mapSalesRecord(raw = {}) {
  const record = {};
  SALES_COLUMNS.forEach(col => {
    const value = raw[col.key];
    record[col.key] = value === undefined || value === null ? '' : value;
  });
  record.ROW_INDEX = raw.ROW_INDEX !== undefined ? raw.ROW_INDEX : raw.rowIndex || null;
  return record;
}

function openSalesModal(isEdit = false, rowIndex = null) {
  const modal = document.getElementById('salesModal');
  if (!modal) return;

  salesState.editingIndex = isEdit && rowIndex !== null ? rowIndex : null;
  const titleEl = document.getElementById('salesModalTitle');
  if (titleEl) {
    titleEl.textContent = isEdit ? 'Edit Sale' : 'Add Sale';
  }

  const dateField = document.getElementById('saleDate');
  const amountField = document.getElementById('saleAmount');
  const customerField = document.getElementById('saleCustomer');
  const referenceField = document.getElementById('saleReference');
  const notesField = document.getElementById('saleNotes');

  if (isEdit && rowIndex !== null) {
    const record = salesState.records.find(r => r.ROW_INDEX === rowIndex);
    if (record) {
      if (dateField) dateField.value = formatDateForInput(record.SALE_DATE);
      if (amountField) amountField.value = record.AMOUNT || '';
      if (customerField) customerField.value = record.CUSTOMER_NAME || '';
      if (referenceField) referenceField.value = record.REFERENCE || '';
      if (notesField) notesField.value = record.COMMENTS || '';
    }
  } else {
    if (dateField) dateField.value = formatDateForInput(new Date());
    if (amountField) amountField.value = '';
    if (customerField) customerField.value = '';
    if (referenceField) referenceField.value = '';
    if (notesField) notesField.value = '';
  }

  modal.style.display = 'block';
}

function closeSalesModal() {
  const modal = document.getElementById('salesModal');
  if (modal) {
    modal.style.display = 'none';
  }
  salesState.editingIndex = null;
}

function deleteSaleRecord(rowIndex) {
  if (!rowIndex) return;
  if (!confirm('Delete this sale record?')) return;
  showProcessing('Deleting sale record...');
  google.script.run
    .withSuccessHandler(function(){
      hideProcessing();
      alert('Sale record deleted');
      loadSalesRecords();
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err && err.message ? err.message : 'Unable to delete sale record');
    })
    .salesDeleteTransaction(rowIndex);
}

function saveSaleRecord(){
  const data = collectSaleFormData();
  if (!data.saleDate){
    alert('Select a sale date');
    return;
  }
  if (!data.customerName){
    alert('Enter customer name');
    return;
  }
  if (!data.amount || data.amount <= 0){
    alert('Enter the total sale amount');
    return;
  }
  showProcessing('Saving sale record...');
  google.script.run
    .withSuccessHandler(function(){
      hideProcessing();
      alert('Sale record saved');
      closeSalesModal();
      loadSalesRecords();
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err && err.message ? err.message : 'Unable to save sale record');
    })
    .salesUpsertTransaction(data);
}
function renderSalesSummary() {
  const totalEl = document.getElementById('salesTotalAmount');
  if (!totalEl) return;
  const sum = (salesState.filtered || []).reduce((acc, record) => {
    return acc + (Number(record.AMOUNT) || 0);
  }, 0);
  totalEl.textContent = formatCurrencyDisplay(sum);
}

function searchSales() {
  const searchInput = (document.getElementById('salesSearchInput').value || '').toLowerCase();
  salesState.filtered = salesState.records.filter(record => {
    return Object.values(record).some(value => {
      return String(value).toLowerCase().includes(searchInput);
    });
  });
  salesState.currentPage = 1;
  renderSalesTable();
  renderSalesSummary();
}

function clearSalesSearch() {
  const searchInput = document.getElementById('salesSearchInput');
  if (searchInput) searchInput.value = '';
  salesState.filtered = salesState.records;
  renderSalesTable();
  renderSalesSummary();
}

function renderSalesTable() {
  const tableBody = document.getElementById('salesTableBody');
  const noDataEl = document.getElementById('salesNoData');
  const tableWrapper = document.getElementById('salesTableWrapper');

  tableBody.innerHTML = '';

  if (!salesState.filtered.length) {
    noDataEl.style.display = 'block';
    tableWrapper.style.display = 'none';
    renderSalesPagination();
    return;
  }

  noDataEl.style.display = 'none';
  tableWrapper.style.display = 'block';

  const startIndex = (salesState.currentPage - 1) * salesState.pageSize;
  const endIndex = startIndex + salesState.pageSize;
  const paginatedRecords = salesState.filtered.slice(startIndex, endIndex);

  paginatedRecords.forEach(record => {
    const row = document.createElement('tr');
    SALES_COLUMNS.forEach(col => {
      const td = document.createElement('td');
      let value = record[col.key] || '';
      if (col.key === 'SALE_DATE') value = formatDisplayDate(value);
      if (col.key === 'AMOUNT') value = formatCurrencyDisplay(value);
      td.textContent = value;
      row.appendChild(td);
    });
    const actionTd = document.createElement('td');
    actionTd.className = 'action-cell';
    actionTd.innerHTML = `
      <button class="action-btn edit-btn" onclick="openSalesModal(true, ${record.ROW_INDEX})">
        <i class="fas fa-edit"></i>
      </button>
      <button class="action-btn sup-delete-btn" onclick="deleteSaleRecord(${record.ROW_INDEX})">
        <i class="fas fa-trash"></i>
      </button>
    `;
    row.appendChild(actionTd);
    tableBody.appendChild(row);
  });
  renderSalesPagination();
}

function renderSalesPagination() {
  const paginationEl = document.getElementById('salesPagination');
  if (!paginationEl) return;
  paginationEl.innerHTML = '';
  const pageCount = Math.ceil(salesState.filtered.length / salesState.pageSize);
  if (pageCount <= 1) return;

  for (let i = 1; i <= pageCount; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.className = 'page-btn' + (i === salesState.currentPage ? ' active' : '');
    pageBtn.textContent = i;
    pageBtn.onclick = () => {
      salesState.currentPage = i;
      renderSalesTable();
    };
    paginationEl.appendChild(pageBtn);
  }
}
function initSales(){
  salesState.loaded = true;
  loadSalesRecords();
}

function loadSalesRecords() {
  const statusEl = document.getElementById('salesStatus');
  showProcessing('Loading sales records...');
  google.script.run.withSuccessHandler(response => {
    hideProcessing();
    if (response.error) {
      if (statusEl) {
        statusEl.textContent = 'Error: ' + response.error;
        statusEl.style.display = 'block';
      }
      return;
    }
    const records = (response.records || []).map(mapSalesRecord);
    records.sort((left, right) => {
      const leftDate = normalizeDateValue(left.SALE_DATE);
      const rightDate = normalizeDateValue(right.SALE_DATE);
      if (leftDate && rightDate) return rightDate.getTime() - leftDate.getTime();
      if (leftDate) return -1;
      if (rightDate) return 1;
      return 0;
    });
    salesState.records = records;
    salesState.filtered = salesState.records;
    renderSalesTable();
    renderSalesSummary();
  }).withFailureHandler(err => {
    hideProcessing();
    if (statusEl) {
      statusEl.style.display = 'block';
      statusEl.textContent = 'Error: ' + err.message;
    }
  }).salesGetDetails();
}


function initShipping() {
  shippingState.loaded = true;
  loadShippingRecords();
}

function loadShippingRecords() {
  const statusEl = document.getElementById('shippingStatus');
  if (statusEl) {
    statusEl.style.display = 'none';
    statusEl.textContent = '';
  }
  showProcessing('Loading shipping records...');
  google.script.run
    .withSuccessHandler(function(response) {
      hideProcessing();
      const payload = response || {};
      if (payload.error) {
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.textContent = 'Error: ' + payload.error;
        }
        shippingState.headers = Array.isArray(payload.headers) ? payload.headers : [];
        shippingState.records = [];
        shippingState.filtered = [];
        shippingState.totalCost = 0;
        renderShippingTotal();
        renderShippingTable();
        return;
      }
      shippingState.headers = Array.isArray(payload.headers) ? payload.headers : [];
      shippingState.records = Array.isArray(payload.records) ? payload.records : [];
      shippingState.filtered = shippingState.records;
      shippingState.totalCost = Number(payload.totalCost) || 0;
      shippingState.currentPage = 1;
      renderShippingTotal();
      renderShippingTable();
    })
    .withFailureHandler(function(err) {
      hideProcessing();
      if (statusEl) {
        statusEl.style.display = 'block';
        statusEl.textContent = 'Error: ' + (err && err.message ? err.message : 'Unable to load shipping records.');
      }
    })
    .shippingGetDetails();
}

function renderShippingTotal() {
  const totalEl = document.getElementById('shippingTotalCost');
  if (!totalEl) return;
  totalEl.textContent = formatShippingCurrency(shippingState.totalCost);
}

function getShippingDisplayHeaders() {
  if (Array.isArray(shippingState.headers) && shippingState.headers.length) {
    return shippingState.headers;
  }
  const sample = shippingState.records[0];
  if (sample) {
    return Object.keys(sample).filter(key => key !== 'ROW_INDEX');
  }
  return [];
}

function renderShippingTable() {
  const tableHead = document.getElementById('shippingTableHead');
  const tableBody = document.getElementById('shippingTableBody');
  const tableWrapper = document.getElementById('shippingTableWrapper');
  const noDataEl = document.getElementById('shippingNoData');
  if (!tableHead || !tableBody) return;

  const headers = getShippingDisplayHeaders();
  const normalizedHeaderMap = headers.map(label => ({
    label,
    normalized: normalizeColumnHeader(label)
  }));

  tableHead.innerHTML = '';
  if (headers.length) {
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      tableHead.appendChild(th);
    });
  } else {
    const th = document.createElement('th');
    th.textContent = 'Details';
    tableHead.appendChild(th);
  }

  tableBody.innerHTML = '';

  if (!shippingState.filtered.length) {
    if (tableWrapper) tableWrapper.style.display = 'block';
    if (noDataEl) noDataEl.style.display = 'block';
    renderShippingPagination();
    return;
  }

  if (noDataEl) noDataEl.style.display = 'none';

  const startIndex = (shippingState.currentPage - 1) * shippingState.pageSize;
  const endIndex = startIndex + shippingState.pageSize;
  const paginated = shippingState.filtered.slice(startIndex, endIndex);

  paginated.forEach(record => {
    const row = document.createElement('tr');
    if (!headers.length) {
      const td = document.createElement('td');
      const dataKeys = Object.keys(record).filter(key => key !== 'ROW_INDEX');
      td.textContent = dataKeys.map(key => record[key]).join(' | ');
      row.appendChild(td);
    } else {
      normalizedHeaderMap.forEach(headerInfo => {
        const td = document.createElement('td');
        const value = record[headerInfo.label];
        td.textContent = formatShippingCellValue(headerInfo.normalized, value);
        row.appendChild(td);
      });
    }
    tableBody.appendChild(row);
  });

  renderShippingPagination();
}

function renderShippingPagination() {
  const paginationEl = document.getElementById('shippingPagination');
  if (!paginationEl) return;
  paginationEl.innerHTML = '';
  const total = shippingState.filtered.length;
  const pages = Math.ceil(total / shippingState.pageSize);
  if (pages <= 1) return;
  for (let i = 1; i <= pages; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === shippingState.currentPage ? ' active' : '');
    btn.textContent = i;
    btn.onclick = function() {
      shippingState.currentPage = i;
      renderShippingTable();
    };
    paginationEl.appendChild(btn);
  }
}

function searchShipping() {
  const input = document.getElementById('shippingSearchInput');
  const term = input ? input.value.trim().toLowerCase() : '';
  if (!term) {
    shippingState.filtered = shippingState.records;
  } else {
    shippingState.filtered = shippingState.records.filter(record => {
      return Object.keys(record).some(key => {
        if (key === 'ROW_INDEX') return false;
        const value = record[key];
        if (value === null || value === undefined) return false;
        return String(value).toLowerCase().includes(term);
      });
    });
  }
  shippingState.currentPage = 1;
  renderShippingTable();
}

function clearShippingSearch() {
  const input = document.getElementById('shippingSearchInput');
  if (input) input.value = '';
  shippingState.filtered = shippingState.records;
  shippingState.currentPage = 1;
  renderShippingTable();
}

function formatShippingCurrency(value) {
  if (value === null || value === undefined || value === '') return '$0.00';
  const num = Number(value);
  if (isNaN(num)) return value;
  return '$' + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatShippingCellValue(normalizedHeader, value) {
  if (value === null || value === undefined) return '';
  if (normalizedHeader.includes('DATE')) {
    return formatDisplayDate(value);
  }
  if (normalizedHeader.includes('COST') || normalizedHeader.includes('AMOUNT') || normalizedHeader.includes('TOTAL') || normalizedHeader.includes('PRICE')) {
    const formatted = formatShippingCurrency(value);
    return formatted === '$0.00' && (value === '' || value === null) ? '' : formatted;
  }
  return String(value);
}


function initSuppliersUI(){
  const btnNewSupplier = document.getElementById('supBtnNewSupplier');
  if (btnNewSupplier) btnNewSupplier.addEventListener('click', supOpenNewSupplierModal);
  const btnSearch = document.getElementById('supBtnSearch');
  if (btnSearch) btnSearch.addEventListener('click', supSearchSuppliers);
  const btnClear = document.getElementById('supBtnClear');
  if (btnClear) btnClear.addEventListener('click', supClearSearch);
  const searchInput = document.getElementById('supSearchInput');
  if (searchInput){
    searchInput.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        e.preventDefault();
        supSearchSuppliers();
      } else if (e.key === 'Escape'){
        e.preventDefault();
        supClearSearch();
      }
    });
  }
}

function supEnsureLoaded(){
  if (supplierState.loaded) return;
  supplierState.loaded = true;
  supLoadStates();
  supLoadCities();
  supLoadSuppliers();
}

function supLoadSuppliers(){
  showProcessing();
  google.script.run
    .withSuccessHandler(function(result){
      hideProcessing();
      supSetStatus('');
      supAllSuppliers = Array.isArray(result) ? result : [];
      supFilteredSuppliers = [...supAllSuppliers];
      supCurrentPage = 1;
      supRenderSupplierTable();
    })
    .withFailureHandler(function(err){
      hideProcessing();
      supAllSuppliers = [];
      supFilteredSuppliers = [];
      supRenderSupplierTable();
      const message = 'Suppliers data not found. Create a "Suppliers" sheet with the named range RANGESUPPLIERS (or SUPPLIERRANGE).';
      supSetStatus(message);
    })
    .supGetSuppliers();
}

function supLoadStates(){
  google.script.run
    .withSuccessHandler(function(result){
      supStates = Array.isArray(result) ? result.filter(Boolean) : [];
      supPopulateSelect('supSupplierState', supStates, 'Select state');
    })
    .withFailureHandler(function(err){
      console.error(err);
    })
    .supGetStates();
}

function supLoadCities(){
  google.script.run
    .withSuccessHandler(function(result){
      supCities = Array.isArray(result) ? result.filter(Boolean) : [];
      supPopulateSelect('supSupplierCity', supCities, 'Select city');
    })
    .withFailureHandler(function(err){
      console.error(err);
    })
    .supGetCities();
}

function supSetStatus(message){
  const status = document.getElementById('supStatus');
  if (!status) return;
  status.textContent = message || '';
  status.style.display = message ? 'block' : 'none';
}

function supPopulateSelect(id, items, placeholder){
  const select = document.getElementById(id);
  if (!select) return;
  select.innerHTML = '';
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.textContent = placeholder || 'Select';
  select.appendChild(defaultOpt);
  items.forEach(item=>{
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    select.appendChild(opt);
  });
}

let supplierHeaderIndexMap = null;
const SUPPLIER_COLUMN_KEYS = {
  id: ['Supplier ID', 'SUPPLIER_ID'],
  name: ['Supplier Name', 'SUPPLIER'],
  contact: ['Contact', 'Supplier Contact'],
  email: ['Email', 'Supplier Email'],
  state: ['State'],
  city: ['City'],
  address: ['Address', 'Supplier Address'],
  actions: ['Actions']
};

function ensureSupplierHeaderIndexMap() {
  if (!supplierHeaderIndexMap) {
    supplierHeaderIndexMap = buildTableHeaderIndexMap('#supTableContainer thead th');
  }
  return supplierHeaderIndexMap;
}

function getSupplierColumnIndex(names, fallback) {
  const headerMap = ensureSupplierHeaderIndexMap();
  return resolveColumnIndex(headerMap, names, fallback);
}

function supRenderSupplierTable(){
  const tbody = document.getElementById('supTableBody');
  const noData = document.getElementById('supNoData');
  const tableContainer = document.getElementById('supTableContainer');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!supFilteredSuppliers.length){
    if (tableContainer) tableContainer.style.display = 'none';
    if (noData) noData.style.display = 'block';
    supRenderSupplierPagination();
    return;
  }
  if (tableContainer) tableContainer.style.display = 'block';
  if (noData) noData.style.display = 'none';
  const start = (supCurrentPage - 1) * supPageSize;
  const end = start + supPageSize;
  const pageItems = supFilteredSuppliers.slice(start, end);
  pageItems.forEach((supplier, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${supplier.id || ''}</td>
      <td>${supplier.name || ''}</td>
      <td>${supplier.contact || ''}</td>
      <td>${supplier.email || ''}</td>
      <td>${supplier.state || ''}</td>
      <td>${supplier.city || ''}</td>
      <td>${supplier.address || ''}</td>
      <td>${supFormatCurrency(supplier.purchases)}</td>
      <td>${supFormatCurrency(supplier.payments)}</td>
      <td>${supFormatCurrency(supplier.balance)}</td>
      <td class="sup-action-cell">
        <button class="sup-action-btn sup-edit-btn" onclick="supEditSupplier(${idx})">Edit</button>
        <button class="sup-action-btn sup-delete-btn" onclick="supDeleteSupplier('${supplier.id || ''}')">Delete</button>
        <button class="sup-action-btn sup-update-btn" onclick="supUpdateSupplier(${idx})">Save</button>
        <button class="sup-action-btn sup-cancel-btn" onclick="supCancelEdit(${idx})">Cancel</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  supRenderSupplierPagination();
}

function supRenderSupplierPagination(){
  const pagination = document.getElementById('supPagination');
  if (!pagination) return;
  pagination.innerHTML = '';
  const totalPages = Math.ceil(supFilteredSuppliers.length / supPageSize);
  if (totalPages <= 1) return;
  for (let i = 1; i <= totalPages; i++){
    const btn = document.createElement('button');
    btn.className = `sup-page-btn ${i === supCurrentPage ? 'active' : ''}`;
    btn.textContent = i;
    btn.addEventListener('click', function(){
      supCurrentPage = i;
      supRenderSupplierTable();
    });
    pagination.appendChild(btn);
  }
}

function supFormatCurrency(value){
  const num = Number(value) || 0;
  return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function supOpenNewSupplierModal(){
  supResetSupplierForm();
  supPopulateSelect('supSupplierState', supStates, 'Select state');
  supPopulateSelect('supSupplierCity', supCities, 'Select city');
  const modal = document.getElementById('supSupplierModal');
  if (modal) modal.style.display = 'block';
}

function supCloseSupplierModal(){
  const modal = document.getElementById('supSupplierModal');
  if (modal) modal.style.display = 'none';
}

function supResetSupplierForm(){
  document.getElementById('supSupplierId').value = '';
  document.getElementById('supSupplierName').value = '';
  document.getElementById('supSupplierContact').value = '';
  document.getElementById('supSupplierEmail').value = '';
  document.getElementById('supSupplierAddress').value = '';
  const stateSelect = document.getElementById('supSupplierState');
  if (stateSelect) stateSelect.value = '';
  const citySelect = document.getElementById('supSupplierCity');
  if (citySelect) citySelect.value = '';
}

function supGenerateSupplierId(){
  showProcessing();
  google.script.run
    .withSuccessHandler(function(id){
      hideProcessing();
      document.getElementById('supSupplierId').value = id;
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err.message || 'Unable to generate ID');
    })
    .supGenerateSupplierId();
}

function supSaveNewSupplier(){
  const supplier = {
    id: document.getElementById('supSupplierId').value.trim(),
    name: document.getElementById('supSupplierName').value.trim(),
    contact: document.getElementById('supSupplierContact').value.trim(),
    email: document.getElementById('supSupplierEmail').value.trim(),
    state: document.getElementById('supSupplierState').value,
    city: document.getElementById('supSupplierCity').value,
    address: document.getElementById('supSupplierAddress').value.trim()
  };
  if (!supplier.id){
    alert('Generate Supplier ID first');
    return;
  }
  if (!supplier.name){
    alert('Supplier name is required');
    return;
  }
  if (!supplier.state || !supplier.city){
    alert('Select state and city');
    return;
  }
  showProcessing();
  google.script.run
    .withSuccessHandler(function(){
      hideProcessing();
      alert('Supplier added');
      supCloseSupplierModal();
      supLoadSuppliers();
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err.message || 'Unable to save supplier');
    })
    .supAddNewSupplier(supplier);
}

function supEditSupplier(rowIndex){
  const tbody = document.getElementById('supTableBody');
  if (!tbody) return;
  const row = tbody.rows[rowIndex];
  if (!row) return;
  const nameIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.name, 1);
  const contactIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.contact, 2);
  const emailIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.email, 3);
  const stateIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.state, 4);
  const cityIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.city, 5);
  const addressIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.address, 6);
  const actionIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.actions, row.cells.length - 1);
  const nameCell = row.cells[nameIdx] || row.cells[1];
  const contactCell = row.cells[contactIdx] || row.cells[2];
  const emailCell = row.cells[emailIdx] || row.cells[3];
  const stateCell = row.cells[stateIdx] || row.cells[4];
  const cityCell = row.cells[cityIdx] || row.cells[5];
  const addressCell = row.cells[addressIdx] || row.cells[6];
  nameCell.innerHTML = `<input class="form-control" value="${nameCell.textContent.trim()}">`;
  contactCell.innerHTML = `<input class="form-control" value="${contactCell.textContent.trim()}">`;
  emailCell.innerHTML = `<input class="form-control" value="${emailCell.textContent.trim()}">`;
  stateCell.innerHTML = supBuildSelectHtml(supStates, stateCell.textContent.trim());
  cityCell.innerHTML = supBuildSelectHtml(supCities, cityCell.textContent.trim());
  addressCell.innerHTML = `<textarea class="form-control">${addressCell.textContent.trim()}</textarea>`;
  const actionCell = row.cells[actionIdx] || row.cells[row.cells.length - 1];
  actionCell.querySelector('.sup-edit-btn').style.display = 'none';
  actionCell.querySelector('.sup-delete-btn').style.display = 'none';
  actionCell.querySelector('.sup-update-btn').style.display = 'inline-block';
  actionCell.querySelector('.sup-cancel-btn').style.display = 'inline-block';
}

function supBuildSelectHtml(options, selected){
  const opts = options.map(opt => `<option value="${opt}" ${opt === selected ? 'selected' : ''}>${opt}</option>`).join('');
  return `<select class="form-control"><option value="">Select</option>${opts}</select>`;
}

function supCancelEdit(){
  supRenderSupplierTable();
}

function supUpdateSupplier(rowIndex){
  const tbody = document.getElementById('supTableBody');
  if (!tbody) return;
  const row = tbody.rows[rowIndex];
  if (!row) return;
  const idIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.id, 0);
  const nameIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.name, 1);
  const contactIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.contact, 2);
  const emailIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.email, 3);
  const stateIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.state, 4);
  const cityIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.city, 5);
  const addressIdx = getSupplierColumnIndex(SUPPLIER_COLUMN_KEYS.address, 6);
  const supplier = {
    id: (row.cells[idIdx] || row.cells[0]).textContent.trim(),
    name: (row.cells[nameIdx] || row.cells[1]).querySelector('input').value.trim(),
    contact: (row.cells[contactIdx] || row.cells[2]).querySelector('input').value.trim(),
    email: (row.cells[emailIdx] || row.cells[3]).querySelector('input').value.trim(),
    state: (row.cells[stateIdx] || row.cells[4]).querySelector('select').value,
    city: (row.cells[cityIdx] || row.cells[5]).querySelector('select').value,
    address: (row.cells[addressIdx] || row.cells[6]).querySelector('textarea').value.trim()
  };
  showProcessing();
  google.script.run
    .withSuccessHandler(function(){
      hideProcessing();
      alert('Supplier updated');
      supLoadSuppliers();
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err.message || 'Unable to update supplier');
    })
    .supUpdateSupplier(supplier);
}

function supDeleteSupplier(id){
  if (!id) return;
  if (!confirm('Delete this supplier?')) return;
  showProcessing();
  google.script.run
    .withSuccessHandler(function(result){
      hideProcessing();
      if (result === 'success'){
        supLoadSuppliers();
      } else if (result === 'balance_error'){
        alert('Supplier has outstanding balance');
      } else {
        alert('Unable to delete supplier');
      }
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err.message || 'Unable to delete supplier');
    })
    .supDeleteSupplier(id);
}

function supSearchSuppliers(){
  const criteria = document.getElementById('supSearchCriteria').value;
  const query = (document.getElementById('supSearchInput').value || '').toLowerCase().trim();
  if (!query){
    supFilteredSuppliers = [...supAllSuppliers];
  } else {
    supFilteredSuppliers = supAllSuppliers.filter(supplier=>{
      if (criteria === 'Supplier Name'){
        return (supplier.name || '').toLowerCase().includes(query);
      }
      if (criteria === 'State'){
        return (supplier.state || '').toLowerCase().includes(query);
      }
      if (criteria === 'City'){
        return (supplier.city || '').toLowerCase().includes(query);
      }
      return (
        (supplier.name || '').toLowerCase().includes(query) ||
        (supplier.state || '').toLowerCase().includes(query) ||
        (supplier.city || '').toLowerCase().includes(query)
      );
    });
  }
  supCurrentPage = 1;
  supRenderSupplierTable();
  if (!supFilteredSuppliers.length){
    alert('No matching data found');
  }
}

function supClearSearch(){
  const criteriaEl = document.getElementById('supSearchCriteria');
  const inputEl = document.getElementById('supSearchInput');
  if (criteriaEl) criteriaEl.value = 'All';
  if (inputEl) inputEl.value = '';
  supFilteredSuppliers = [...supAllSuppliers];
  supCurrentPage = 1;
  supRenderSupplierTable();
}


const expensesState = { loaded: false, headers: [], records: [], filtered: [], currentPage: 1, pageSize: 20, totalAmount: 0 };
const expenseFormState = { editingRow: null };

function initExpenses() {
  expensesState.loaded = true;
  loadExpenses();
}

function extractExpenseDateValue(record) {
  if (!record || typeof record !== 'object') return null;
  const targetKeys = Object.keys(record);
  for (const key of targetKeys) {
    const normalized = normalizeColumnHeader(key);
    if (normalized === 'EXPENSE_DATE' || normalized === 'DATE') {
      return normalizeDateValue(record[key]);
    }
  }
  return null;
}

function sortExpensesByDate(records) {
  if (!Array.isArray(records)) return [];
  return [...records].sort((left, right) => {
    const leftDate = extractExpenseDateValue(left);
    const rightDate = extractExpenseDateValue(right);
    if (leftDate && rightDate) return rightDate.getTime() - leftDate.getTime();
    if (leftDate) return -1;
    if (rightDate) return 1;
    return 0;
  });
}

function extractExpenseAmountValue(record) {
  if (!record || typeof record !== 'object') return null;
  const keys = Object.keys(record);
  for (const key of keys) {
    const normalized = normalizeColumnHeader(key);
    if (normalized === 'ROW_INDEX') continue;
    if (!normalized) continue;
    if (normalized.includes('SPENT') || normalized === 'AMOUNT') {
      const value = record[key];
      if (value === '' || value === null || value === undefined) continue;
      if (typeof value === 'number') return value;
      const match = String(value).replace(/[^0-9.\-]/g, '');
      const asNumber = Number(match);
      if (!Number.isNaN(asNumber)) return asNumber;
    }
  }
  return null;
}

function calculateExpensesTotal(records) {
  if (!Array.isArray(records)) return 0;
  return records.reduce((total, record) => {
    const amount = extractExpenseAmountValue(record);
    if (amount === null || amount === undefined || Number.isNaN(amount)) {
      return total;
    }
    return total + amount;
  }, 0);
}

function renderExpensesSummary() {
  const totalEl = document.getElementById('expensesTotalAmount');
  if (!totalEl) return;
  totalEl.textContent = formatCurrencyDisplay(expensesState.totalAmount);
}

function updateFilteredExpenses(records) {
  expensesState.filtered = records;
  expensesState.totalAmount = calculateExpensesTotal(records);
  renderExpensesSummary();
}

function collectExpenseFormData() {
  const amountField = document.getElementById('expenseAmount');
  const amountValue = amountField ? amountField.value : '';
  return {
    rowIndex: expenseFormState.editingRow,
    expenseDate: (document.getElementById('expenseDate')?.value || '').trim(),
    spentAmount: amountValue === '' ? null : Number(amountValue),
    vendor: (document.getElementById('expenseVendor')?.value || '').trim(),
    type: (document.getElementById('expenseType')?.value || '').trim()
  };
}

function openExpenseModal() {
  expenseFormState.editingRow = null;
  const dateField = document.getElementById('expenseDate');
  const amountField = document.getElementById('expenseAmount');
  const vendorField = document.getElementById('expenseVendor');
  const typeField = document.getElementById('expenseType');
  if (dateField) dateField.value = formatDateForInput(new Date());
  if (amountField) amountField.value = '';
  if (vendorField) vendorField.value = '';
  if (typeField) typeField.value = '';
  const modal = document.getElementById('expensesModal');
  if (modal) {
    modal.style.display = 'block';
  }
}

function closeExpenseModal() {
  const modal = document.getElementById('expensesModal');
  if (modal) {
    modal.style.display = 'none';
  }
  expenseFormState.editingRow = null;
}

function saveExpenseRecord() {
  const data = collectExpenseFormData();
  if (!data.expenseDate) {
    alert('Select an expense date');
    return;
  }
  if (data.spentAmount === null || Number.isNaN(data.spentAmount) || data.spentAmount <= 0) {
    alert('Enter the spent amount');
    return;
  }
  if (!data.vendor) {
    alert('Enter the vendor');
    return;
  }
  if (!data.type) {
    alert('Enter the expense type');
    return;
  }
  showProcessing('Saving expense record...');
  google.script.run
    .withSuccessHandler(function () {
      hideProcessing();
      alert('Expense record saved');
      closeExpenseModal();
      loadExpenses();
    })
    .withFailureHandler(function (err) {
      hideProcessing();
      alert(err && err.message ? err.message : 'Unable to save expense record');
    })
    .expenseUpsertTransaction(data);
}

function loadExpenses() {
  const statusEl = document.getElementById('expensesStatus');
  if (statusEl) {
    statusEl.style.display = 'none';
    statusEl.textContent = '';
  }
  showProcessing('Loading expenses...');
  google.script.run
    .withSuccessHandler(response => {
      hideProcessing();
      const payload = response || {};
      if (payload.error) {
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.textContent = 'Error: ' + payload.error;
        }
        expensesState.headers = Array.isArray(payload.headers) ? payload.headers : [];
        expensesState.records = [];
        expensesState.filtered = [];
        expensesState.totalAmount = 0;
        renderExpensesSummary();
        renderExpensesTable();
        return;
      }
      expensesState.headers = Array.isArray(payload.headers) ? payload.headers : [];
      const fetchedRecords = Array.isArray(payload.records) ? payload.records : [];
      expensesState.records = sortExpensesByDate(fetchedRecords);
      updateFilteredExpenses(expensesState.records);
      expensesState.currentPage = 1;
      renderExpensesTable();
    })
    .withFailureHandler(err => {
      hideProcessing();
      if (statusEl) {
        statusEl.style.display = 'block';
        statusEl.textContent = 'Error: ' + (err && err.message ? err.message : 'Unable to load expenses.');
      }
      expensesState.totalAmount = 0;
      renderExpensesSummary();
    })
    .expenseGetDetails();
}

function renderExpensesTable() {
  const tableHead = document.getElementById('expensesTableHead');
  const tableBody = document.getElementById('expensesTableBody');
  const pagination = document.getElementById('expensesPagination');
  const noData = document.getElementById('expensesNoData');
  if (!tableHead || !tableBody || !pagination) return;

  const headers = Array.isArray(expensesState.headers) ? expensesState.headers : [];
  tableHead.innerHTML = '';
  if (headers.length) {
    tableHead.innerHTML = '<tr>' + headers.map(header => `<th>${header || 'Column'}</th>`).join('') + '</tr>';
  } else {
    tableHead.innerHTML = '<tr><th>Details</th></tr>';
  }

  tableBody.innerHTML = '';
  if (!expensesState.filtered.length) {
    if (noData) {
      noData.style.display = 'flex';
      noData.querySelector('.no-data-title').textContent = 'No expenses recorded';
    }
    renderExpensesPagination();
    return;
  }
  if (noData) noData.style.display = 'none';

  const start = (expensesState.currentPage - 1) * expensesState.pageSize;
  const end = start + expensesState.pageSize;
  const pageItems = expensesState.filtered.slice(start, end);

  pageItems.forEach(record => {
    const row = document.createElement('tr');
    if (!headers.length) {
      const td = document.createElement('td');
      const values = Object.values(record).filter((_, idx) => (!('ROW_INDEX' in record) || idx !== 0));
      td.textContent = values.join(' | ');
      row.appendChild(td);
    } else {
      headers.forEach(header => {
        const td = document.createElement('td');
        const normalized = normalizeColumnHeader(header);
        let value = record[header] || '';
        if (normalized.includes('DATE')) {
          value = formatDisplayDate(value);
        } else if (typeof value === 'number') {
          value = formatCurrencyDisplay(value);
        }
        td.textContent = value;
        row.appendChild(td);
      });
    }
    tableBody.appendChild(row);
  });

  renderExpensesPagination();
}

function renderExpensesPagination() {
  const pagination = document.getElementById('expensesPagination');
  if (!pagination) return;
  pagination.innerHTML = '';
  const total = expensesState.filtered.length;
  const pages = Math.ceil(total / expensesState.pageSize);
  if (pages <= 1) return;
  for (let i = 1; i <= pages; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === expensesState.currentPage ? ' active' : '');
    btn.textContent = i;
    btn.onclick = () => {
      expensesState.currentPage = i;
      renderExpensesTable();
    };
    pagination.appendChild(btn);
  }
}

function searchExpenses() {
  const input = document.getElementById('expensesSearchInput');
  const term = input ? input.value.trim().toLowerCase() : '';
  if (!term) {
    updateFilteredExpenses(expensesState.records);
  } else {
    const filtered = expensesState.records.filter(record => {
      return Object.values(record).some(value => {
        if (value === null || value === undefined) return false;
        return String(value).toLowerCase().includes(term);
      });
    });
    updateFilteredExpenses(filtered);
  }
  expensesState.currentPage = 1;
  renderExpensesTable();
}

function clearExpensesSearch() {
  const input = document.getElementById('expensesSearchInput');
  if (input) input.value = '';
  updateFilteredExpenses(expensesState.records);
  expensesState.currentPage = 1;
  renderExpensesTable();
}


function loadTypes() {
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('itemGetTypes result ->', result);
      types = Array.isArray(result) ? result.slice() : [];
      if (!types.map(t => String(t || '').toUpperCase()).includes('DRESS')) {
        types.push('DRESS');
        console.log('Added fallback type: DRESS');
      }
      populateTypeDropdown();
    })
    .itemGetTypes();
}

// Load item categories from Dimensions sheet
function loadCategories() {
  google.script.run
    .withSuccessHandler(function(result) {
      categories = result;
      populateCategoryDropdown();
    })
    .itemGetCategories();
}

// Load item subcategories from Dimensions sheet
function loadSubcategories() {
  google.script.run
    .withSuccessHandler(function(result) {
      subcategories = result;
      populateSubcategoryDropdown();
    })
    .itemGetSubcategories();
}

// Populate type dropdown
function populateTypeDropdown() {
  const typeSelect = $('#itemType');
  typeSelect.empty();
  
  types.forEach(type => {
    if (type) {
      typeSelect.append(new Option(type, type));
    }
  });
  
  typeSelect.trigger('change');
}

// Populate category dropdown
function populateCategoryDropdown() {
  const categorySelect = $('#itemCategory');
  categorySelect.empty();
  
  categories.forEach(category => {
    if (category) {
      categorySelect.append(new Option(category, category));
    }
  });
  
  categorySelect.trigger('change');
}

// Populate subcategory dropdown
function populateSubcategoryDropdown() {
  const subcategorySelect = $('#itemSubcategory');
  subcategorySelect.empty();
  
  subcategories.forEach(subcategory => {
    if (subcategory) {
      subcategorySelect.append(new Option(subcategory, subcategory));
    }
  });
  
  subcategorySelect.trigger('change');
}

let inventoryHeaderIndexMap = null;
const INVENTORY_COLUMN_KEYS = {
  id: ['Item ID', 'UID'],
  status: ['Status'],
  soldDate: ['Sold Date', 'SOLD_DATE'],
  actions: ['Actions']
};

const LABEL_TEMPLATES = {
  'avery-5160': {
    id: 'avery-5160',
    name: 'Avery 5160 (3x10, Letter)',
    pageWidth: '8.5in',
    pageHeight: '11in',
    labelWidth: '2.625in',
    labelHeight: '1in',
    marginTop: '0.5in',
    marginLeft: '0.1875in',
    columns: 3,
    rows: 10,
    horizontalPitch: '2.75in',
    verticalPitch: '1in'
  }
};

const selectedBarcodeIds = new Set();
const printFilters = {
  itemType: '',
  status: '',
  size: '',
  dateFrom: '',
  dateTo: '',
  template: 'avery-5160'
};
let printFilterListenersAttached = false;
const previewState = {
  modal: null,
  image: null,
  barcode: null,
  info: null,
  linkImage: null,
  linkBarcode: null
};

function ensureInventoryHeaderIndexMap() {
  if (!inventoryHeaderIndexMap) {
    inventoryHeaderIndexMap = buildTableHeaderIndexMap('#tableContainer thead th');
  }
  return inventoryHeaderIndexMap;
}

function getInventoryColumnIndex(names, fallback) {
  const headerMap = ensureInventoryHeaderIndexMap();
  const idx = resolveColumnIndex(headerMap, names, fallback);
  return idx;
}

function populateStatusSelect(selectEl, selectedValue = '', includePlaceholder = true) {
  if (!selectEl) return;
  selectEl.innerHTML = '';
  if (includePlaceholder) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'Select status';
    selectEl.appendChild(opt);
  }
  STATUS_CHOICES.forEach(choice => {
    const opt = document.createElement('option');
    opt.value = choice.value;
    opt.textContent = choice.label;
    if (choice.value === selectedValue) {
      opt.selected = true;
    }
    selectEl.appendChild(opt);
  });
}

function formatStatusLabel(value) {
  const upper = (value || '').toUpperCase();
  const match = STATUS_CHOICES.find(choice => choice.value === upper);
  return match ? match.label : value || '';
}

function formatDrivePreviewUrl(fileId, fallback) {
  if (fileId) return `https://drive.google.com/uc?export=download&id=${fileId}`;
  return fallback || '';
}

function formatBarcodeDisplayUrl(item) {
  if (!item) return '';
  const direct = item.barcodeUrl || '';
  const fileId = item.barcodeFileId || extractDriveId(direct);
  if (fileId) return `https://drive.google.com/uc?export=view&id=${fileId}`;
  return direct;
}

function extractDriveId(url) {
  if (!url) return '';
  const match = url.match(/[-\w]{25,}/);
  return match ? match[0] : '';
}

function escapeHtml(value) {
  return (value || '').toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

const barcodeDataUrlCache = new Map();
function getBarcodeDataUrl(text, width = 260, height = 90) {
  const cleanText = (text || '').toString().trim();
  if (!cleanText) return '';
  const cacheKey = `${cleanText}|${width}|${height}`;
  if (barcodeDataUrlCache.has(cacheKey)) {
    return barcodeDataUrlCache.get(cacheKey);
  }
  if (!window.bwipjs) {
    console.warn('bwipjs not loaded; skipping barcode render for', cleanText);
    return '';
  }
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  try {
    bwipjs.toCanvas(canvas, {
      bcid: 'code128',
      text: cleanText,
      includetext: true,
      textxalign: 'center',
      textsize: 9,
      scale: 3,
      height: 15,
      paddingwidth: 6,
      paddingheight: 6,
      backgroundcolor: 'FFFFFF'
    });
    const url = canvas.toDataURL('image/png');
    barcodeDataUrlCache.set(cacheKey, url);
    return url;
  } catch (err) {
    console.error('Failed to render barcode for', cleanText, err);
    return '';
  }
}

function isSoldStatus(value) {
  return (value || '').toUpperCase() === 'SOLD';
}

function getStatusClass(value) {
  const slug = (value || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
  return slug ? `status-${slug}` : '';
}

function applySoldDateRules(statusValue, inputEl, hintEl, options = {}) {
  if (!inputEl) return;
  const requireSoldDate = isSoldStatus(statusValue);
  inputEl.required = requireSoldDate;
  if (options.disableWhenNotSold) {
    inputEl.disabled = !requireSoldDate;
  }
  if (!requireSoldDate && options.clearWhenNotSold !== false) {
    inputEl.value = '';
  }
  if (hintEl) {
    const soldMsg = options.soldMessage || 'Enter the sold date to continue';
    const defaultMsg = options.defaultMessage || 'Required when status is SOLD';
    hintEl.style.color = requireSoldDate ? '#e74c3c' : '#64748b';
    hintEl.textContent = requireSoldDate ? soldMsg : defaultMsg;
  }
  return requireSoldDate;
}

function formatSoldDateDisplay(value) {
  if (!value) return '-';
  const date = new Date(value);
  if (!Number.isNaN(date.getTime())) {
    return date.toLocaleDateString();
  }
  return value;
}

// Load inventory items from sheet
function loadInventoryItems() {
  showProcessing();
  google.script.run
    .withSuccessHandler(function(result) {
      const payload = Array.isArray(result) ? { items: result, headers: [] } : (result || {});
      console.log('inventory payload', payload);
      const incomingItems = Array.isArray(payload.items) ? payload.items : [];
      allItems = incomingItems.map(item => ({
        ...item,
        summaryFields: item.summaryFields || item.fields || {}
      }));
      filteredItems = [...allItems];
      currentPage = 1;
      renderItemTable();
      loadSummaryFiltersAndData();
      hideProcessing();
    })
    .withFailureHandler(function(err){
      hideProcessing();
      alert(err && err.message ? err.message : 'Unable to load inventory.');
    })
    .itemGetInventoryItems();
}

// Render inventory table with pagination
function renderItemTable() {
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const pageItems = filteredItems.slice(startIndex, endIndex);
  const tableBody = document.getElementById('tableBody');
  
  tableBody.innerHTML = '';
  
  if (pageItems.length === 0) {
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('noData').style.display = 'block';
    document.getElementById('pagination').innerHTML = '';
    return;
  }
  
  document.getElementById('tableContainer').style.display = 'block';
  document.getElementById('noData').style.display = 'none';
  
  pageItems.forEach((item, index) => {
    const row = document.createElement('tr');
    const imageSrc = formatDrivePreviewUrl(item.imageFileId, item.imageUrl);
    const barcodeSrc = formatBarcodeDisplayUrl(item);
    const statusLabel = formatStatusLabel(item.status);
    const statusClass = getStatusClass(item.status);
    const dateOrderedDisplay = formatDisplayDate(item.dateOrdered);
    const soldDateDisplay = formatSoldDateDisplay(item.soldDate);
    const priceDisplay = typeof formatCurrencyDisplay === 'function'
      ? formatCurrencyDisplay(item.totalSalePrice)
      : (item.totalSalePrice || '');

    row.innerHTML = `
      <td class="select-cell select-col">
        <input type="checkbox" class="barcode-select" data-id="${item.id || ''}" ${selectedBarcodeIds.has(item.id) ? 'checked' : ''}>
      </td>
      <td class="id-col">${item.id}</td>
      <td>${item.type}</td>
      <td>${item.fabric || ''}</td>
      <td>${item.color || ''}</td>
      <td>${item.size || ''}</td>
      <td>${item.workstyle || ''}</td>
      <td class="item-image-cell">
        <button class="action-btn preview-btn" data-idx="${startIndex + index}">
          <i class="fas fa-eye"></i> Preview
        </button>
      </td>
      <td class="quantity-col">${item.quantity || ''}</td>
      <td>${priceDisplay || ''}</td>
      <td>
        ${statusLabel ? `<span class="status-pill ${statusClass}">${statusLabel}</span>` : '-'}
      </td>
      <td>${dateOrderedDisplay}</td>
      <td>${soldDateDisplay}</td>
      <td class="action-cell">
        <button class="action-btn edit-btn" onclick="editItem(${index})">
          <i class="fas fa-edit"></i>
        </button>
        <button class="action-btn update-btn" style="display:none;" 
          onclick="updateItem(${index})">
          <i class="fas fa-save"></i>
        </button>
        <button class="action-btn cancel-btn" style="display:none;" 
          onclick="cancelEdit(${index})">
          <i class="fas fa-times"></i>
        </button>
      </td>
    `;
    tableBody.appendChild(row);
    const cb = row.querySelector('.barcode-select');
    if (cb) {
      cb.addEventListener('change', function (e) {
        const id = this.getAttribute('data-id');
        if (!id) return;
        if (e.target.checked) selectedBarcodeIds.add(id);
        else selectedBarcodeIds.delete(id);
      });
    }
    const previewBtn = row.querySelector('.preview-btn');
    if (previewBtn) {
      previewBtn.addEventListener('click', function () {
        const idx = Number(this.getAttribute('data-idx'));
        const target = filteredItems[idx];
        if (!target) return;
        openPreviewModal(target);
      });
    }
  });
  
  // Render pagination
  renderPagination();
}

// Render pagination controls
function renderPagination() {
  const totalPages = Math.ceil(filteredItems.length / pageSize);
  renderPaginationButtons('pagination', totalPages, currentPage, page => {
    currentPage = page;
    renderItemTable();
  });
}

function initInventoryBulkUpdateControls() {
  const statusSelect = document.getElementById('bulkStatusSelect');
  if (statusSelect) {
    populateBulkStatusOptions(statusSelect);
    statusSelect.addEventListener('change', syncBulkSoldDateInputState);
  }
  const updateButton = document.getElementById('bulkUpdateButton');
  if (updateButton) {
    updateButton.addEventListener('click', applyBulkInventoryUpdate);
  }
  syncBulkSoldDateInputState();
}

function populateBulkStatusOptions(selectEl) {
  if (!selectEl) return;
  selectEl.innerHTML = '<option value="">Select status</option>' +
    STATUS_CHOICES.map(choice => `<option value="${choice.value}">${choice.label}</option>`).join('');
}

function syncBulkSoldDateInputState() {
  const statusSelect = document.getElementById('bulkStatusSelect');
  const soldDateInput = document.getElementById('bulkSoldDateInput');
  if (!statusSelect || !soldDateInput) return;
  const shouldEnable = statusSelect.value === 'SOLD';
  soldDateInput.disabled = !shouldEnable;
  if (!shouldEnable) {
    soldDateInput.value = '';
  }
}

function applyBulkInventoryUpdate() {
  const statusSelect = document.getElementById('bulkStatusSelect');
  const soldDateInput = document.getElementById('bulkSoldDateInput');
  if (!statusSelect) return;
  const selectedIds = Array.from(selectedBarcodeIds).filter(Boolean);
  if (!selectedIds.length) {
    alert('Select at least one item to update');
    return;
  }
  const status = (statusSelect.value || '').trim();
  if (!status) {
    alert('Select a status to apply');
    return;
  }
  const soldDateValue = soldDateInput ? soldDateInput.value : '';
  if (status === 'SOLD' && !soldDateValue) {
    alert('Enter a sold date when marking items as sold');
    return;
  }
  const payload = selectedIds.map(id => ({
    id,
    status,
    soldDate: soldDateValue
  }));
  showProcessing('Updating selected items...');
  google.script.run
    .withSuccessHandler(() => {
      hideProcessing();
      alert(`${payload.length} item(s) updated`);
      loadInventoryItems();
    })
    .withFailureHandler(err => {
      hideProcessing();
      alert(err && err.message ? err.message : 'Unable to update selected inventory items.');
    })
    .itemUpdateInventoryItems(payload);
}


// Open new type modal
function openNewTypeModal() {
  document.getElementById('typeModal').style.display = 'block';
  document.getElementById('newType').value = '';
}

// Close new type modal
function closeTypeModal() {
  document.getElementById('typeModal').style.display = 'none';
}

// Save new type
function saveNewType() {
  const typeName = document.getElementById('newType').value.trim();
  
  if (!typeName) {
    alert('Please enter an item type');
    return;
  }
  
  showProcessing();
  google.script.run
    .withSuccessHandler(function() {
      hideProcessing();
      alert('New Item Type Added');
      closeTypeModal();
      loadTypes();
    })
    .itemAddNewType(typeName);
}

// Open new category modal
function openNewCategoryModal() {
  document.getElementById('categoryModal').style.display = 'block';
  document.getElementById('newCategory').value = '';
}

function openBarcodePrintModal() {
  populatePrintFilterOptions();
  attachPrintFilterListeners();
  updatePrintMatchCount();
  const modal = document.getElementById('printModal');
  if (modal) modal.style.display = 'block';
}

function closeBarcodePrintModal() {
  const modal = document.getElementById('printModal');
  if (modal) modal.style.display = 'none';
}

function cachePreviewElements() {
  if (previewState.modal) return;
  previewState.modal = document.getElementById('previewModal');
  previewState.image = document.getElementById('previewImage');
  previewState.barcode = document.getElementById('previewBarcode');
  previewState.info = document.getElementById('previewInfo');
  previewState.linkImage = document.getElementById('previewImageLink');
  previewState.linkBarcode = document.getElementById('previewBarcodeLink');
}

function openPreviewModal(item) {
  cachePreviewElements();
  if (!previewState.modal) return;
  const imageSrc = formatDrivePreviewUrl(item.imageFileId, item.imageUrl);
  const barcodeSrc = formatBarcodeDisplayUrl(item);
  if (previewState.info) {
    previewState.info.textContent = `${item.id || ''}${item.size ? '  Size: ' + item.size : ''}${item.type ? '  ' + item.type : ''}`;
  }
  if (previewState.image) {
    if (imageSrc) {
      previewState.image.src = imageSrc;
      previewState.image.style.display = 'block';
    } else {
      previewState.image.style.display = 'none';
    }
  }
  if (previewState.barcode) {
    if (barcodeSrc) {
      previewState.barcode.src = barcodeSrc;
      previewState.barcode.style.display = 'block';
    } else {
      previewState.barcode.style.display = 'none';
    }
  }
  if (previewState.linkImage) {
    previewState.linkImage.href = imageSrc || '#';
    previewState.linkImage.style.display = imageSrc ? 'inline' : 'none';
  }
  if (previewState.linkBarcode) {
    previewState.linkBarcode.href = barcodeSrc || '#';
    previewState.linkBarcode.style.display = barcodeSrc ? 'inline' : 'none';
  }
  previewState.modal.style.display = 'block';
}

function closePreviewModal() {
  cachePreviewElements();
  if (previewState.modal) previewState.modal.style.display = 'none';
}

function populatePrintFilterOptions() {
  const typeSelect = document.getElementById('printItemType');
  const statusSelect = document.getElementById('printStatus');
  const templateSelect = document.getElementById('printTemplate');
  if (typeSelect) {
    const uniqueTypes = Array.from(new Set(allItems.map(i => i.type).filter(Boolean))).sort();
    typeSelect.innerHTML = '<option value=\"\">Any</option>' + uniqueTypes.map(t => `<option value=\"${t}\">${t}</option>`).join('');
    typeSelect.value = printFilters.itemType || '';
  }
  if (statusSelect) {
    statusSelect.innerHTML = '<option value=\"\">Any</option>' +
      STATUS_CHOICES.map(s => `<option value=\"${s.value}\">${s.label}</option>`).join('');
    statusSelect.value = printFilters.status || '';
  }
  if (templateSelect) {
    templateSelect.value = printFilters.template || 'avery-5160';
  }
  const sizeInput = document.getElementById('printSize');
  if (sizeInput) sizeInput.value = printFilters.size || '';
  const fromInput = document.getElementById('printDateFrom');
  const toInput = document.getElementById('printDateTo');
  if (fromInput) fromInput.value = printFilters.dateFrom || '';
  if (toInput) toInput.value = printFilters.dateTo || '';
}

function attachPrintFilterListeners() {
  if (printFilterListenersAttached) return;
  const ids = ['printItemType','printStatus','printSize','printDateFrom','printDateTo','printTemplate'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', updatePrintMatchCount);
      el.addEventListener('input', updatePrintMatchCount);
    }
  });
  printFilterListenersAttached = true;
}

function readPrintFilters() {
  const typeSelect = document.getElementById('printItemType');
  const statusSelect = document.getElementById('printStatus');
  const templateSelect = document.getElementById('printTemplate');
  const sizeInput = document.getElementById('printSize');
  const fromInput = document.getElementById('printDateFrom');
  const toInput = document.getElementById('printDateTo');
  return {
    itemType: typeSelect ? typeSelect.value : '',
    status: statusSelect ? statusSelect.value : '',
    size: sizeInput ? sizeInput.value.trim() : '',
    dateFrom: fromInput ? fromInput.value : '',
    dateTo: toInput ? toInput.value : '',
    template: (templateSelect && templateSelect.value) || 'avery-5160'
  };
}

function applyBarcodePrintFilters() {
  const filters = readPrintFilters();
  Object.assign(printFilters, filters);
  const matches = filterItemsForPrint(filters);
  if (!matches.length) {
    alert('No items match these filters.');
    return;
  }
  const template = LABEL_TEMPLATES[filters.template] || LABEL_TEMPLATES['avery-5160'];
  renderBarcodePrintWindow(matches, template);
  closeBarcodePrintModal();
}

function filterItemsForPrint(filters) {
  const from = filters.dateFrom ? new Date(filters.dateFrom) : null;
  const to = filters.dateTo ? new Date(filters.dateTo) : null;
  if (to) to.setHours(23, 59, 59, 999);
  const sizeQuery = (filters.size || '').toUpperCase();
  return allItems.filter(item => {
    if (filters.itemType && (item.type || '').toUpperCase() !== filters.itemType.toUpperCase()) return false;
    if (filters.status && (item.status || '').toUpperCase() !== filters.status.toUpperCase()) return false;
    if (sizeQuery) {
      const sizeVal = (item.size || '').toUpperCase();
      if (!sizeVal.includes(sizeQuery)) return false;
    }
    if (from || to) {
      const ord = item.dateOrdered ? new Date(item.dateOrdered) : null;
      if (!ord || isNaN(ord.getTime())) return false;
      if (from && ord < from) return false;
      if (to && ord > to) return false;
    }
    return true;
  });
}

function updatePrintMatchCount() {
  const filters = readPrintFilters();
  const matches = filterItemsForPrint(filters);
  const el = document.getElementById('printMatchCount');
  if (el) {
    el.textContent = `${matches.length} item(s) will be printed.`;
  }
}

function renderBarcodePrintWindow(items, template) {
  if (!window.bwipjs) {
    alert('Barcode generator did not load. Please refresh and try again.');
    return;
  }
  const perPage = template.columns * template.rows;
  const pages = [];
  for (let i = 0; i < items.length; i += perPage) {
    pages.push(items.slice(i, i + perPage));
  }

  const gapX = `calc(${template.horizontalPitch} - ${template.labelWidth})`;
  const gapY = `calc(${template.verticalPitch} - ${template.labelHeight})`;
  const pageHtml = pages.map((pageItems, pageIdx) => {
    const labels = pageItems.map(item => {
      const priceText = typeof formatCurrencyDisplay === 'function'
        ? formatCurrencyDisplay(item.totalSalePrice)
        : (item.totalSalePrice || '');
      const itemId = item.id || '';
      const safeId = escapeHtml(itemId);
      const barcodeImgSrc = getBarcodeDataUrl(itemId, 260, 90) || formatBarcodeDisplayUrl(item);
      const barcodeSection = barcodeImgSrc
        ? `<img class="barcode-img" src="${barcodeImgSrc}" alt="Barcode for ${safeId}">`
        : `<div class="label-text label-error">Barcode unavailable</div>`;
      const typeLine = item.type ? `<div class="label-sub type-line">${escapeHtml(item.type)}</div>` : '';
      const priceSizeLine = priceText || item.size
        ? `<div class="label-sub">${priceText ? `Price: ${priceText}` : ''}${priceText && item.size ? '  ' : ''}${item.size ? `Size: ${escapeHtml(item.size)}` : ''}</div>`
        : '';
      return `<div class="label">
        ${barcodeSection}
        <div class="label-text">${safeId}</div>
        ${typeLine}
        ${priceSizeLine}
      </div>`;
    }).join('');
    const pageClass = pageIdx === 0 ? 'page' : 'page page-break';
    return `<div class="${pageClass}">${labels}</div>`;
  }).join('');

  const html = `<!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>Print Barcodes</title>
    <style>
      @page { size: ${template.pageWidth} ${template.pageHeight}; margin: 0; }
      * { box-sizing: border-box; }
      body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
      .page {
        width: ${template.pageWidth};
        height: ${template.pageHeight};
        padding-top: ${template.marginTop};
        padding-left: ${template.marginLeft};
        display: grid;
        grid-template-columns: repeat(${template.columns}, ${template.labelWidth});
        grid-auto-rows: ${template.labelHeight};
        column-gap: ${gapX};
        row-gap: ${gapY};
      }
      .page-break { page-break-before: always; }
      .label {
        width: ${template.labelWidth};
        height: ${template.labelHeight};
        padding: 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .barcode-img {
        width: 100%;
        height: auto;
        max-height: 70%;
        object-fit: contain;
      }
      .label-text {
        font-size: 12px;
        font-weight: 700;
        text-align: center;
        margin-top: 2px;
      }
      .label-sub {
        font-size: 10px;
        text-align: center;
        line-height: 1.2;
      }
      .label-sub.type-line {
        font-weight: 600;
      }
      .label-error {
        font-size: 10px;
        color: #e11d48;
        text-align: center;
      }
    </style>
  </head>
  <body>
    ${pageHtml}
  </body>
  </html>`;

  const printWin = window.open('', '_blank');
  if (!printWin) {
    alert('Pop-up blocked. Please allow pop-ups to print.');
    return;
  }
  printWin.document.open();
  printWin.document.write(html);
  printWin.document.close();
  printWin.focus();
  printWin.onload = function () {
    printWin.print();
  };
}
// Close new category modal
function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
}

// Save new category
function saveNewCategory() {
  const categoryName = document.getElementById('newCategory').value.trim();
  
  if (!categoryName) {
    alert('Please enter a fabric');
    return;
  }
  
  showProcessing();
  google.script.run
    .withSuccessHandler(function() {
      hideProcessing();
      alert('New Fabric Added');
      closeCategoryModal();
      loadCategories();
    })
    .itemAddNewCategory(categoryName);
}

// Open new subcategory modal
function openNewSubcategoryModal() {
  document.getElementById('subcategoryModal').style.display = 'block';
  document.getElementById('newSubcategory').value = '';
}

// Close new subcategory modal
function closeSubcategoryModal() {
  document.getElementById('subcategoryModal').style.display = 'none';
}

// Save new subcategory
function saveNewSubcategory() {
  const subcategoryName = document.getElementById('newSubcategory').value.trim();
  
  if (!subcategoryName) {
    alert('Please enter a workstyle');
    return;
  }
  
  showProcessing();
  google.script.run
    .withSuccessHandler(function() {
      hideProcessing();
      alert('New Workstyle Added');
      closeSubcategoryModal();
      loadSubcategories();
    })
    .itemAddNewSubcategory(subcategoryName);
}

// Open new inventory item modal
function openNewItemModal() {
  document.getElementById('inventoryModal').style.display = 'block';
  document.getElementById('inventoryId').value = '';
  document.getElementById('itemName').value = '';
  const statusSelect = document.getElementById('inventoryStatus');
  const soldDateInput = document.getElementById('inventorySoldDate');
  if (statusSelect) statusSelect.value = 'INSTOCK';
  if (soldDateInput) soldDateInput.value = '';
  handleInventoryModalStatusChange();
  $('#itemType').val(null).trigger('change');
  $('#itemCategory').val(null).trigger('change');
  $('#itemSubcategory').val(null).trigger('change');
}

// Close new inventory item modal
function closeInventoryModal() {
  document.getElementById('inventoryModal').style.display = 'none';
}

// Generate unique item ID
function generateInventoryId() {
  showProcessing();
  google.script.run
    .withSuccessHandler(function(newId) {
      document.getElementById('inventoryId').value = newId;
      hideProcessing();
    })
    .itemGenerateInventoryId();
}

// Save new inventory item
function saveNewInventoryItem() {
    const item = {
      id: document.getElementById('inventoryId').value,
      type: $('#itemType').val(),
      fabric: $('#itemCategory').val(),
      workstyle: $('#itemSubcategory').val(),
      name: document.getElementById('itemName').value.trim(),
      status: document.getElementById('inventoryStatus').value,
      soldDate: document.getElementById('inventorySoldDate').value || ''
    };
  
  // Validate required fields
  if (!item.id) {
    alert('Please generate an Item ID');
    return;
  }
  
  if (!item.type) {
    alert('Please select Item Type');
    return;
  }
  
    if (!item.fabric) {
      alert('Please select Fabric');
      return;
    }
    
    if (!item.workstyle) {
      alert('Please select Workstyle');
      return;
    }
  
  if (!item.name) {
    alert('Please enter Item Name');
    return;
  }
  
  if (!item.status) {
    alert('Please select a Status');
    return;
  }
  
  if (item.status === 'SOLD' && !item.soldDate) {
    alert('Please provide Sold Date for sold items');
    return;
  }
  
  showProcessing();
  google.script.run
    .withSuccessHandler(function() {
      hideProcessing();
      alert('New Item Added');
      closeInventoryModal();
      loadInventoryItems();
    })
    .itemAddNewInventoryItem(item);
}

// Edit item row
function editItem(index) {
  const tableBody = document.getElementById('tableBody');
  const row = tableBody.rows[index];
  const cells = row.cells;
  const item = filteredItems[(currentPage - 1) * pageSize + index];
  
  const statusSelect = document.createElement('select');
  statusSelect.className = 'editable';
  const normalizedStatus = (item.status || '').toUpperCase();
  populateStatusSelect(statusSelect, normalizedStatus, false);
  const statusIdx = getInventoryColumnIndex(INVENTORY_COLUMN_KEYS.status, 6);
  const statusCell = cells[statusIdx] || cells[6];
  if (statusCell) {
    statusCell.innerHTML = '';
    statusCell.appendChild(statusSelect);
  }
  
  const soldDateInput = document.createElement('input');
  soldDateInput.type = 'date';
  soldDateInput.className = 'editable';
  soldDateInput.value = formatDateForInput(item.soldDate);
  const soldDateIdx = getInventoryColumnIndex(INVENTORY_COLUMN_KEYS.soldDate, 7);
  const soldDateCell = cells[soldDateIdx] || cells[7];
  if (soldDateCell) {
    soldDateCell.innerHTML = '';
    soldDateCell.appendChild(soldDateInput);
  }
  const syncSoldState = () => {
    applySoldDateRules(statusSelect.value, soldDateInput, null, {
      clearWhenNotSold: false
    });
  };
  statusSelect.addEventListener('change', syncSoldState);
  syncSoldState();
  
  // Show update/cancel buttons
  const actionIdx = getInventoryColumnIndex(INVENTORY_COLUMN_KEYS.actions, cells.length - 1);
  const actionCell = cells[actionIdx] || cells[cells.length - 1];
  actionCell.querySelector('.edit-btn').style.display = 'none';
  actionCell.querySelector('.update-btn').style.display = 'inline-block';
  actionCell.querySelector('.cancel-btn').style.display = 'inline-block';
}

// Cancel edit
function cancelEdit(index) {
  renderItemTable(); // Simply re-render the table to reset
}

// Update item
function updateItem(index) {
  const tableBody = document.getElementById('tableBody');
  const row = tableBody.rows[index];
  const cells = row.cells;
  const originalItem = filteredItems[(currentPage - 1) * pageSize + index];
  const idIdx = getInventoryColumnIndex(INVENTORY_COLUMN_KEYS.id, 0);
  const statusIdx = getInventoryColumnIndex(INVENTORY_COLUMN_KEYS.status, 6);
  const soldDateIdx = getInventoryColumnIndex(INVENTORY_COLUMN_KEYS.soldDate, 7);

  const item = {
    id: (cells[idIdx] || cells[0]).textContent,
    name: originalItem.name,
    type: originalItem.type,
    fabric: originalItem.fabric,
    workstyle: originalItem.workstyle,
    status: (cells[statusIdx] || cells[6]).querySelector('select').value,
    soldDate: (cells[soldDateIdx] || cells[7]).querySelector('input').value || ''
  };
  
  // Validate required fields
  if (!item.status) {
    alert('Please select Status');
    return;
  }
  
  if (item.status === 'SOLD' && !item.soldDate) {
    alert('Please provide Sold Date for sold items');
    return;
  }
  
  showProcessing();
  google.script.run
    .withSuccessHandler(function() {
      hideProcessing();
      alert('Inventory Item Updated');
      loadInventoryItems();
    })
    .itemUpdateInventoryItem(item);
}

// Search items
function searchItems() {
  const criteria = document.getElementById('searchCriteria').value;
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  
  if (!query) {
    filteredItems = [...allItems];
  } else {
  filteredItems = allItems.filter(item => {
    const match = (val) => String(val || '').toLowerCase().includes(query);
    if (criteria === 'all') {
      return (
        match(item.id) ||
        match(item.type) ||
        match(item.fabric) ||
        match(item.workstyle) ||
        match(item.name) ||
        match(item.status) ||
        match(item.soldDate)
      );
    } else if (criteria === 'Item ID') {
      return match(item.id);
    } else if (criteria === 'Item Type') {
      return match(item.type);
    } else if (criteria === 'Fabric') {
      return match(item.fabric);
    } else if (criteria === 'Workstyle') {
      return match(item.workstyle);
    } else if (criteria === 'Status') {
      return match(item.status);
    } else if (criteria === 'Sold Date') {
      return match(item.soldDate);
    }
    return true;
  });
  }
  
  currentPage = 1;
  renderItemTable();
  
  if (filteredItems.length === 0) {
    alert('No matching data found');
  }
}

// Clear search
function clearSearch() {
  document.getElementById('searchInput').value = '';
  document.getElementById('searchCriteria').value = 'all';
  filteredItems = [...allItems];
  currentPage = 1;
  renderItemTable();
}

function handleInventoryModalStatusChange(){
  const statusEl = document.getElementById('inventoryStatus');
  const soldDateInput = document.getElementById('inventorySoldDate');
  const soldHint = document.getElementById('inventorySoldDateHint');
  if (!statusEl || !soldDateInput) return;
  applySoldDateRules(statusEl.value, soldDateInput, soldHint, {
    soldMessage: 'Enter the sold date to save this item',
    defaultMessage: 'Required when status is SOLD',
    disableWhenNotSold: true
  });
}


let summarySelectedColors = [];
let summarySelectedSizes = [];
let summaryColorOptions = [];
let summarySizeOptions = [];

function normalizeSummaryKey(header) {
  return String(header || '').toLowerCase().replace(/[^a-z0-9]+/g, '_');
}

function getSummaryColorHeader() {
  return summaryGroupHeaders.find(header => normalizeSummaryKey(header) === 'color');
}

function getSummarySizeHeader() {
  return summaryGroupHeaders.find(header => normalizeSummaryKey(header) === 'size');
}

function getTableGroupHeaders() {
  const filtered = summaryGroupHeaders.filter(header => {
    const key = normalizeSummaryKey(header);
    return key !== 'color' && key !== 'size';
  });
  return prioritizeHeader(filtered, 'item_type');
}

function prioritizeHeader(headers, priorityKey) {
  const normalized = headers.map(header => ({
    header,
    key: normalizeSummaryKey(header)
  }));
  const prioritized = normalized.filter(item => item.key === priorityKey).map(item => item.header);
  const rest = normalized.filter(item => item.key !== priorityKey).map(item => item.header);
  return [...prioritized, ...rest];
}

function loadSummaryFiltersAndData(selectedColors = [], selectedSizes = []) {
  google.script.run
    .withSuccessHandler(opts => {
      console.log('summary filters', opts);
      summaryColorOptions = Array.isArray(opts.colors) ? opts.colors : [];
      summarySizeOptions = Array.isArray(opts.sizes) ? opts.sizes : [];
      loadInventorySummary(selectedColors, selectedSizes);
    })
    .withFailureHandler(function(err) {
      const message = err && err.message ? err.message : 'Unable to load summary filters.';
      alert(message);
    })
    .itemGetSummaryFilterOptions();
}

function loadInventorySummary(selectedColors = [], selectedSizes = []) {
  google.script.run
    .withSuccessHandler(payload => handleInventorySummaryResponse(payload, selectedColors, selectedSizes))
    .withFailureHandler(function(err) {
      const message = err && err.message ? err.message : 'Unable to load inventory summary.';
      alert(message);
    })
    .itemGetInventorySummary(selectedColors, selectedSizes);
}

function handleInventorySummaryResponse(payload, selectedColors = [], selectedSizes = []) {
  summaryGroupHeaders = Array.isArray(payload.groupHeaders) ? payload.groupHeaders : [];
  summaryStatusColumns = Array.isArray(payload.statuses) ? payload.statuses : [];
  summaryPivotRows = Array.isArray(payload.rows) ? payload.rows : [];
  summaryColorOptions = Array.isArray(payload.colorOptions) ? payload.colorOptions : [];
  summarySizeOptions = Array.isArray(payload.sizeOptions) ? payload.sizeOptions : [];
  summarySelectedColors = Array.isArray(selectedColors) ? selectedColors : [];
  summarySelectedSizes = Array.isArray(selectedSizes) ? selectedSizes : [];
  summaryFilteredPivotRows = [...summaryPivotRows];
  summaryCurrentPage = 1;
  populateSummaryFilters();
  applyCurrentFilterState();
  updateSummaryFilterSummary();
  updateSummaryTotals();
}

function populateSummaryFilters() {
  renderFilterCheckboxes('summaryColorFilter', summaryColorOptions, summarySelectedColors, values => {
    summarySelectedColors = values;
    updateSummaryFilterSummary();
    requestSummaryWithFilters();
  });
  renderFilterCheckboxes('summarySizeFilter', summarySizeOptions, summarySelectedSizes, values => {
    summarySelectedSizes = values;
    updateSummaryFilterSummary();
    requestSummaryWithFilters();
  });
}

function renderFilterCheckboxes(containerId, options, currentSelection, onSelectionChange) {
  const container = document.getElementById(containerId);
  if (!container) return;
  let uniqueValues = Array.isArray(options)
    ? Array.from(new Set(options.map(val => String(val || '').trim()).filter(Boolean)))
    : [];
  // Fallback: derive from current rows if options are empty
  if (!uniqueValues.length && Array.isArray(summaryPivotRows) && summaryPivotRows.length) {
    const fromRows = new Set();
    const isColor = containerId === 'summaryColorFilter';
    const isSize = containerId === 'summarySizeFilter';
    summaryPivotRows.forEach(row => {
      const list = isColor ? row.colors : isSize ? row.sizes : [];
      if (Array.isArray(list)) {
        list.forEach(v => {
          const trimmed = String(v || '').trim();
          if (trimmed) fromRows.add(trimmed);
        });
      }
    });
    uniqueValues = Array.from(fromRows);
  }
  const appliedSelection = currentSelection.filter(value => uniqueValues.includes(value));
  summarySelectedColors = containerId === 'summaryColorFilter' ? appliedSelection : summarySelectedColors;
  summarySelectedSizes = containerId === 'summarySizeFilter' ? appliedSelection : summarySelectedSizes;
  if (!uniqueValues.length) {
    container.innerHTML = '<p class="filter-none">No options available</p>';
    setupFilterDropdowns();
    return;
  }

  const allId = `${containerId}-all`;
  const allChecked =
    appliedSelection.length === 0 || appliedSelection.length === uniqueValues.length;
  const itemsHtml = uniqueValues
    .map(value => {
      const id = `${containerId}-${value.replace(/\s+/g, '-')}`;
      const checked = appliedSelection.includes(value) ? 'checked' : '';
      return `
        <label class="filter-option" for="${id}">
          <input type="checkbox" id="${id}" value="${value}" ${checked}>
          <span>${value}</span>
        </label>
      `;
    })
    .join('');

  container.innerHTML = `
    <label class="filter-option filter-option-all" for="${allId}">
      <input type="checkbox" id="${allId}" ${allChecked ? 'checked' : ''}>
      <span>All</span>
    </label>
    ${itemsHtml}
    <div class="filter-actions">
      <button type="button" class="filter-apply">Apply</button>
      <button type="button" class="filter-cancel">Cancel</button>
    </div>
  `;

  const allInput = container.querySelector(`#${allId}`);
  const updateAllInputState = (selectedValues) => {
    if (!allInput) return;
    const selectedCount = selectedValues.length;
    const total = uniqueValues.length;
    allInput.checked = selectedCount === total || selectedCount === 0;
  };
  const appliedValues = appliedSelection.slice();
  container.dataset.lastApplied = JSON.stringify(appliedValues);

  const checkboxList = container.querySelectorAll('.filter-option input[type="checkbox"]');
  const collectSelected = () =>
    Array.from(checkboxList)
      .filter(ch => ch !== allInput && ch.checked)
      .map(ch => ch.value);

  if (allInput) {
    allInput.addEventListener('click', event => event.stopPropagation());
    allInput.addEventListener('change', () => {
      const shouldSelectAll = allInput.checked;
      checkboxList.forEach(input => {
        if (input === allInput) return;
        input.checked = shouldSelectAll;
      });
    });
  }

  checkboxList.forEach(input => {
    input.addEventListener('click', event => event.stopPropagation());
    if (input === allInput) return;
    input.addEventListener('change', () => {
      const values = collectSelected();
      updateAllInputState(values);
    });
  });

  container.querySelectorAll('label').forEach(label => {
    label.addEventListener('click', event => event.stopPropagation());
  });

  const dropdown = container.closest('.filter-dropdown');
  const applyButton = container.querySelector('.filter-apply');
  const cancelButton = container.querySelector('.filter-cancel');

  if (applyButton) {
    applyButton.addEventListener('click', () => {
      const values = collectSelected();
      container.dataset.lastApplied = JSON.stringify(values);
      updateAllInputState(values);
      onSelectionChange(values);
      if (dropdown) dropdown.classList.remove('open');
    });
  }

  if (cancelButton) {
    cancelButton.addEventListener('click', () => {
      const lastApplied = JSON.parse(container.dataset.lastApplied || '[]');
      checkboxList.forEach(input => {
        if (input === allInput) return;
        input.checked = lastApplied.includes(input.value);
      });
      updateAllInputState(lastApplied);
      if (dropdown) dropdown.classList.remove('open');
    });
  }

  setupFilterDropdowns();
  updateSummaryFilterSummary();
}

function applyCurrentFilterState() {
  const criteriaSelect = document.getElementById('summarySearchCriteria');
  const searchInput = document.getElementById('summarySearchInput');
  const criteria = criteriaSelect ? criteriaSelect.value : 'all';
  const query = searchInput ? searchInput.value.trim() : '';
  applySummaryFilters(criteria, query);
}

function requestSummaryWithFilters() {
  loadSummaryFiltersAndData(summarySelectedColors, summarySelectedSizes);
}

function renderSummaryTable() {
  const container = document.getElementById('summaryTableContainer');
  const noData = document.getElementById('summaryNoData');
  const head = document.getElementById('summaryTableHead');
  const body = document.getElementById('summaryTableBody');
  const pagination = document.getElementById('summaryPagination');
  if (!container || !noData || !head || !body || !pagination) return;
  const tableGroupHeaders = getTableGroupHeaders();
  const columns = [].concat(tableGroupHeaders, summaryStatusColumns, ['Total Qty']);
  if (!columns.length) {
    head.innerHTML = '';
    body.innerHTML = '';
    pagination.innerHTML = '';
    container.style.display = 'none';
    noData.style.display = 'flex';
    return;
  }
  head.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
  const startIndex = (summaryCurrentPage - 1) * summaryPageSize;
  const pageItems = summaryFilteredPivotRows.slice(startIndex, startIndex + summaryPageSize);
  if (!pageItems.length) {
    body.innerHTML = '';
    pagination.innerHTML = '';
    container.style.display = 'none';
    noData.style.display = 'flex';
    return;
  }
  container.style.display = 'block';
  noData.style.display = 'none';
  body.innerHTML = pageItems
    .map(row => {
      const groupCells = tableGroupHeaders
        .map(header => `<td>${formatSummaryValue(row.group ? row.group[header] : '')}</td>`)
        .join('');
      const statusCells = summaryStatusColumns
        .map(status => `<td>${formatSummaryValue(row.statusTotals ? row.statusTotals[status] : 0)}</td>`)
        .join('');
      const totalCell = `<td>${formatSummaryValue(row.totalQty || 0)}</td>`;
      return `<tr>${groupCells}${statusCells}${totalCell}</tr>`;
    })
    .join('');
  renderSummaryPagination();
}

function renderSummaryPagination() {
  const totalPages = Math.ceil(summaryFilteredPivotRows.length / summaryPageSize);
  renderPaginationButtons('summaryPagination', totalPages, summaryCurrentPage, page => {
    summaryCurrentPage = page;
    renderSummaryTable();
  });
}

function searchSummaryItems() {
  const criteriaSelect = document.getElementById('summarySearchCriteria');
  const searchInput = document.getElementById('summarySearchInput');
  const criteria = criteriaSelect ? criteriaSelect.value : 'all';
  const query = searchInput ? searchInput.value.trim() : '';
  applySummaryFilters(criteria, query);
}

function clearSummarySearch() {
  const criteriaSelect = document.getElementById('summarySearchCriteria');
  const searchInput = document.getElementById('summarySearchInput');
  if (criteriaSelect) criteriaSelect.value = 'all';
  if (searchInput) searchInput.value = '';
  summarySelectedColors = [];
  summarySelectedSizes = [];
  document.querySelectorAll('#summaryColorFilter input[type="checkbox"], #summarySizeFilter input[type="checkbox"]').forEach(ch => {
    ch.checked = false;
  });
  applySummaryFilters('all', '');
  requestSummaryWithFilters();
}

function applySummaryFilters(criteria, query) {
  const normalizedCriteria = normalizeSummaryKey(criteria || 'all');
  const queryNormalized = (query || '').toLowerCase();
  let rows = summaryPivotRows;
  if (!queryNormalized) {
    summaryFilteredPivotRows = rows;
    summaryCurrentPage = 1;
    updateSummaryTotals();
    renderSummaryTable();
    return;
  }
  const targetHeader = summaryGroupHeaders.find(header => normalizeSummaryKey(header) === normalizedCriteria);
  const statusSearch = normalizedCriteria === 'status';
  const colorSearch = normalizedCriteria === 'color';
  const sizeSearch = normalizedCriteria === 'size';
  summaryFilteredPivotRows = rows.filter(row => {
    const colors = Array.isArray(row.colors) ? row.colors : [];
    const sizes = Array.isArray(row.sizes) ? row.sizes : [];
    if (targetHeader) {
      const value = String(row.group ? row.group[targetHeader] : '').toLowerCase();
      return value.includes(queryNormalized);
    }
    if (colorSearch) {
      return colors.some(c => String(c || '').toLowerCase().includes(queryNormalized));
    }
    if (sizeSearch) {
      return sizes.some(s => String(s || '').toLowerCase().includes(queryNormalized));
    }
    if (statusSearch) {
      return summaryStatusColumns.some(status => {
        const nameMatch = normalizeSummaryKey(status).includes(queryNormalized);
        const countMatch = String(row.statusTotals ? row.statusTotals[status] : '').includes(queryNormalized);
        return nameMatch || countMatch;
      });
    }
    const groupMatch = summaryGroupHeaders.some(header => {
      return String(row.group ? row.group[header] : '').toLowerCase().includes(queryNormalized);
    });
    const colorMatch = colors.some(c => String(c || '').toLowerCase().includes(queryNormalized));
    const sizeMatch = sizes.some(s => String(s || '').toLowerCase().includes(queryNormalized));
    const statusMatch = summaryStatusColumns.some(status => {
      const nameMatch = normalizeSummaryKey(status).includes(queryNormalized);
      const countMatch = String(row.statusTotals ? row.statusTotals[status] : '').includes(queryNormalized);
      return nameMatch || countMatch;
    });
    return groupMatch || colorMatch || sizeMatch || statusMatch;
  });
  summaryCurrentPage = 1;
  if (!summaryFilteredPivotRows.length) {
    alert('No matching summary data found');
  }
  updateSummaryTotals();
  renderSummaryTable();
}

function formatSummaryValue(value) {
  if (value === null || value === undefined || value === '') return '-';
  if (value instanceof Date && !isNaN(value)) {
    return value.toISOString().split('T')[0];
  }
  if (typeof value === 'number' && !Number.isNaN(value)) {
    return value.toLocaleString('en-US');
  }
  return String(value);
}

function updateSummaryFilterSummary() {
  const summaryEl = document.getElementById('summaryFilterSummary');
  if (!summaryEl) return;
  const parts = [];
  if (summarySelectedColors.length) {
    parts.push(`Color: ${summarySelectedColors.join(', ')}`);
  }
  if (summarySelectedSizes.length) {
    parts.push(`Size: ${summarySelectedSizes.join(', ')}`);
  }
  summaryEl.textContent = parts.length ? parts.join(' | ') : 'No filters applied.';
}

function updateSummaryTotals() {
  const totalsEl = document.getElementById('summaryTotals');
  if (!totalsEl) return;
  let sold = 0;
  let instock = 0;
  summaryFilteredPivotRows.forEach(row => {
    const st = row && row.statusTotals ? row.statusTotals : {};
    sold += Number(st.SOLD || 0);
    instock += Number(st.INSTOCK || 0);
  });
  totalsEl.innerHTML = `
    <span>Sold: ${formatSummaryValue(sold)}</span>
    <span>In Stock: ${formatSummaryValue(instock)}</span>
  `;
}

function toggleFilterDropdown(button) {
  const dropdown = button.closest('.filter-dropdown');
  if (!dropdown) return;
  document.querySelectorAll('.filter-dropdown').forEach(dd => {
    if (dd !== dropdown) dd.classList.remove('open');
  });
  dropdown.classList.toggle('open');
}

function toggleFilterDropdownButton(event) {
  event.stopPropagation();
  if (event.currentTarget) {
    toggleFilterDropdown(event.currentTarget);
  }
}

function setupFilterDropdowns() {
  document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
    const panel = dropdown.querySelector('.filter-dropdown-panel');
    if (panel) {
      panel.addEventListener('click', event => event.stopPropagation());
    }
    const button = dropdown.querySelector('.filter-dropdown-button');
    if (button) {
      button.removeEventListener('click', toggleFilterDropdownButton);
      button.addEventListener('click', toggleFilterDropdownButton);
    }
  });
}

document.addEventListener('click', () => {
  document.querySelectorAll('.filter-dropdown').forEach(dropdown => dropdown.classList.remove('open'));
});


function cacheCaptureElements(){
  Object.assign(capEls, {
    modal: document.getElementById('captureModal'),
    vid: document.getElementById('capVid'),
    snapCanvas: document.getElementById('capSnapCanvas'),
    preview: document.getElementById('capPreview'),
    btnSnap: document.getElementById('capBtnSnap'),
    btnUpload: document.getElementById('capBtnUpload'),
    btnRetake: document.getElementById('capBtnRetake'),
    btnUse: document.getElementById('capBtnUse'),
    uploadInput: document.getElementById('capUploadInput'),
    btnSubmit: document.getElementById('capBtnSubmit'),
    btnReset: document.getElementById('capBtnReset'),
    msg: document.getElementById('capMsg'),
    err: document.getElementById('capErr'),
    pillUid: document.getElementById('capUidPill'),
    pillMd5: document.getElementById('capMd5Pill'),
    barcodeCanvas: document.getElementById('capBarcodeCanvas'),
    qrCanvas: document.getElementById('capQrCanvas'),
    resultCard: document.getElementById('capResultCard'),
    resultText: document.getElementById('capResultText'),
    rowLink: document.getElementById('capRowUrl'),
    imageLink: document.getElementById('capImageLink'),
    barcodeLink: document.getElementById('capBarcodeLink'),
    qrLink: document.getElementById('capQrLink')
  });
}

// Folder to store generated barcode/QR images in Drive (shared for public view access)
const BARCODE_FOLDER_URL = 'https://drive.google.com/drive/folders/1JZRga-FI5ntiBNIxezBkrjqJJoF2Ohjq';
const BARCODE_FOLDER_ID = (typeof extractDriveId === 'function')
  ? extractDriveId(BARCODE_FOLDER_URL)
  : '1JZRga-FI5ntiBNIxezBkrjqJJoF2Ohjq';

function initCaptureUI(){
  cacheCaptureElements();
  buildSizeOptions();
  document.getElementById('CAP_SIZE_OTHER').addEventListener('input', readSizes);
  document.getElementById('CAP_ITEM_TYPE').addEventListener('change', handleTypeChange);
  document.querySelectorAll('.cap-size-cb').forEach(cb=> cb.addEventListener('change', readSizes));
  setupOtherInput('CAP_COLOR_VISIBLE','CAP_COLOR','CAP_COLOR_OTHER_WRAP','CAP_COLOR_OTHER');
  setupOtherInput('CAP_VENDOR_VISIBLE','CAP_VENDOR','CAP_VENDOR_OTHER_WRAP','CAP_VENDOR_OTHER');
  if (capEls.btnSnap) capEls.btnSnap.addEventListener('click', snapCapturePhoto);
  if (capEls.btnUpload) capEls.btnUpload.addEventListener('click', triggerUploadPhoto);
  if (capEls.btnRetake) capEls.btnRetake.addEventListener('click', retakeCapture);
  if (capEls.btnUse) capEls.btnUse.addEventListener('click', useCapturePhoto);
  if (capEls.uploadInput) capEls.uploadInput.addEventListener('change', handleUploadedPhoto);
  if (capEls.btnReset) capEls.btnReset.addEventListener('click', resetCaptureForm);
  if (capEls.btnSubmit) capEls.btnSubmit.addEventListener('click', submitCapture);
  const wholesaleInput = document.getElementById('CAP_WHOLESALE');
  if (wholesaleInput) wholesaleInput.addEventListener('input', updatePricePreview);
  const capStatusSelect = document.getElementById('CAP_STATUS');
  if (capStatusSelect){
    populateStatusSelect(capStatusSelect, 'INSTOCK');
    capStatusSelect.addEventListener('change', handleCaptureStatusChange);
  }
  loadCaptureLookups();
  readSizes();
  handleTypeChange();
  resetCaptureForm();
}

function setDatalistOptions(listId, values, preserveIfEmpty){
  const dl = document.getElementById(listId);
  if (!dl) return;
  const unique = Array.from(new Set((values || []).filter(Boolean)));
  if (preserveIfEmpty && !unique.length) return;
  dl.innerHTML = unique.map(v => `<option value="${v}">`).join('');
}

function loadCaptureLookups(){
  if (typeof google !== 'undefined' && google.script && google.script.run){
    google.script.run
      .withSuccessHandler(opts => {
        const colors = (opts && Array.isArray(opts.colors)) ? opts.colors : [];
        console.log('Loaded colors from itemGetSummaryFilterOptions ->', colors);
        setDatalistOptions('capColorList', colors);
      })
      .withFailureHandler(() => {})
      .itemGetSummaryFilterOptions();

    google.script.run
      .withSuccessHandler(list => {
        console.log('Loaded workstyles from itemGetSubcategories ->', list);
        const opts = Array.isArray(list) ? list : [];
        setDatalistOptions('capWorkstyleList', opts, true);
      })
      .withFailureHandler(() => {})
      .itemGetSubcategories();
  }
}

function buildSizeOptions(){
  const wrap = document.getElementById('CAP_SIZE_OPTIONS');
  wrap.innerHTML='';
  CAP_SIZE_OPTIONS.forEach(size=>{
    const label=document.createElement('label');
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.value=size;
    cb.className='cap-size-cb';
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' '+size));
    wrap.appendChild(label);
  });
}

function readSizes(){
  const base=Array.from(document.querySelectorAll('.cap-size-cb:checked')).map(cb=>cb.value);
  const extra=(document.getElementById('CAP_SIZE_OTHER').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const combined=[...base,...extra];
  document.getElementById('CAP_SIZE').value = combined.join(',').toUpperCase();
  return combined;
}

function handleTypeChange(){
  const type=document.getElementById('CAP_ITEM_TYPE').value;
  const disable = type==='SAREE';
  document.querySelectorAll('.cap-size-cb').forEach(cb=>{
    cb.disabled=disable;
    if(disable) cb.checked=false;
  });
  document.getElementById('CAP_SIZE_OTHER').value = disable ? '' : document.getElementById('CAP_SIZE_OTHER').value;
  document.getElementById('CAP_SIZE').value = disable ? '' : document.getElementById('CAP_SIZE').value;
  document.getElementById('CAP_SIZE_HINT').textContent = disable ? 'Size is optional for Saree.' : 'Select at least one size or provide custom entries.';
}

function handleCaptureStatusChange(){
  const statusEl = document.getElementById('CAP_STATUS');
  const soldDateInput = document.getElementById('CAP_SOLD_DATE');
  const soldHint = document.getElementById('CAP_SOLD_DATE_HINT');
  if (!statusEl || !soldDateInput) return;
  applySoldDateRules(statusEl.value, soldDateInput, soldHint, {
    soldMessage: 'Enter the sold date to continue',
    defaultMessage: 'Required when status is SOLD',
    disableWhenNotSold: true
  });
}

function handleInventoryModalStatusChange(){
  const statusEl = document.getElementById('inventoryStatus');
  const soldDateInput = document.getElementById('inventorySoldDate');
  const soldHint = document.getElementById('inventorySoldDateHint');
  if (!statusEl || !soldDateInput) return;
  applySoldDateRules(statusEl.value, soldDateInput, soldHint, {
    soldMessage: 'Enter the sold date to save this item',
    defaultMessage: 'Required when status is SOLD',
    disableWhenNotSold: true
  });
}

function setupOtherInput(visibleId, hiddenId, wrapId, otherInputId){
  const visible=document.getElementById(visibleId);
  const hidden=document.getElementById(hiddenId);
  const wrap=document.getElementById(wrapId);
  const other=document.getElementById(otherInputId);
  if(!visible||!hidden) return;
  function sync(){
    const val=(visible.value||'').trim();
    if(val.toUpperCase()===COLOR_OTHER_TOKEN){
      wrap.style.display='block';
      hidden.value=(other.value||'').trim().toUpperCase();
    } else {
      wrap.style.display='none';
      hidden.value=val.toUpperCase();
      if(other) other.value='';
    }
  }
  visible.addEventListener('input', sync);
  if(other) other.addEventListener('input', ()=>{ hidden.value=(other.value||'').trim().toUpperCase(); });
  sync();
}

function openCaptureModal(){
  cacheCaptureElements();
  if(capEls.modal){
    capEls.modal.style.display='block';
    resetCaptureForm();
    startCaptureCamera();
  }
}
function closeCaptureModal(){
  if(capEls.modal) capEls.modal.style.display='none';
  stopCaptureCamera();
}

async function startCaptureCamera(){
  if(captureState.stream) return;
  try{
    captureState.stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    capEls.vid.srcObject = captureState.stream;
  }catch(err){
    if (capEls.err) capEls.err.textContent = err.message;
  }
}

function stopCaptureCamera(){
  if(captureState.stream){
    captureState.stream.getTracks().forEach(t=>t.stop());
    captureState.stream = null;
  }
}

function resetCaptureForm(){
  captureState.photoDataUrl=null;
  captureState.resizedDataUrl=null;
  captureState.uid=null;
  captureState.md5=null;
  capEls.preview.src='';
  capEls.snapCanvas.style.display='none';
  capEls.btnSnap.style.display='inline-block';
  capEls.btnRetake.style.display='none';
  capEls.btnUse.style.display='none';
  capEls.btnSubmit.disabled=true;
  capEls.pillUid.textContent='';
  capEls.pillMd5.textContent='';
  capEls.err.textContent='';
  capEls.resultCard.style.display='none';
  document.getElementById('CAP_FABRIC').value='';
  document.getElementById('CAP_WORKSTYLE').value='';
  document.getElementById('CAP_COLOR_VISIBLE').value='';
  document.getElementById('CAP_COLOR_OTHER').value='';
  document.getElementById('CAP_VENDOR_VISIBLE').value='';
  document.getElementById('CAP_VENDOR_OTHER').value='';
  document.getElementById('CAP_WHOLESALE').value='';
  document.getElementById('CAP_RETAIL_PREVIEW').value='';
  document.getElementById('CAP_TOTAL_PREVIEW').value='';
  document.getElementById('CAP_QTY').value=1;
  document.getElementById('CAP_DATE_ORDERED').value='';
  document.getElementById('CAP_SOLD_DATE').value='';
  document.getElementById('CAP_STATUS').value='INSTOCK';
  document.getElementById('CAP_SIZE_OTHER').value='';
  document.querySelectorAll('.cap-size-cb').forEach(cb=>cb.checked=false);
  readSizes();
  handleTypeChange();
  handleCaptureStatusChange();
  if (capEls.uploadInput) capEls.uploadInput.value='';
}

function snapCapturePhoto(){
  if(!captureState.stream){
    capEls.err.textContent='Camera not ready.';
    return;
  }
  const video=capEls.vid;
  const canvas=capEls.snapCanvas;
  const ctx=canvas.getContext('2d');
  if(!video.videoWidth){
    capEls.err.textContent='Camera not ready. Try again.';
    return;
  }
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  captureState.photoDataUrl=canvas.toDataURL('image/jpeg',0.92);
  capEls.preview.src=captureState.photoDataUrl;
  canvas.style.display='block';
  capEls.btnSnap.style.display='none';
  capEls.btnRetake.style.display='inline-block';
  capEls.btnUse.style.display='inline-block';
}

function retakeCapture(){
  capEls.btnSnap.style.display='inline-block';
  capEls.btnRetake.style.display='none';
  capEls.btnUse.style.display='none';
  captureState.photoDataUrl=null;
  captureState.resizedDataUrl=null;
  capEls.btnSubmit.disabled=true;
  capEls.preview.src='';
  capEls.pillUid.textContent='';
  capEls.pillMd5.textContent='';
  if (capEls.uploadInput) capEls.uploadInput.value='';
}

function triggerUploadPhoto(){
  if (!capEls.uploadInput) return;
  capEls.uploadInput.value='';
  capEls.uploadInput.click();
}

function handleUploadedPhoto(event){
  const input = event && event.target;
  const file = input && input.files && input.files[0];
  if (!file) return;
  if (!file.type || !file.type.startsWith('image/')){
    if (capEls.err) capEls.err.textContent = 'Please select a valid image file.';
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    const dataUrl = reader.result;
    if (typeof dataUrl !== 'string'){
      if (capEls.err) capEls.err.textContent = 'Unable to read the selected image.';
      return;
    }
    captureState.photoDataUrl = dataUrl;
    captureState.resizedDataUrl = null;
    captureState.uid = null;
    captureState.md5 = null;
    capEls.preview.src = dataUrl;
    capEls.snapCanvas.style.display = 'none';
    capEls.btnSnap.style.display = 'none';
    capEls.btnRetake.style.display = 'inline-block';
    capEls.btnUse.style.display = 'inline-block';
    capEls.btnSubmit.disabled = true;
    if (capEls.pillUid) capEls.pillUid.textContent = '';
    if (capEls.pillMd5) capEls.pillMd5.textContent = '';
    if (capEls.err) capEls.err.textContent = '';
  };
  reader.onerror = () => {
    if (capEls.err) capEls.err.textContent = 'Unable to read the selected image.';
  };
  reader.readAsDataURL(file);
}

function drawToCanvasMax(img,maxW){
  const canvas=capEls.snapCanvas;
  const ctx=canvas.getContext('2d');
  const scale=img.width>maxW ? maxW/img.width : 1;
  canvas.width=Math.round(img.width*scale);
  canvas.height=Math.round(img.height*scale);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/jpeg',0.9);
}

async function useCapturePhoto(){
  if(!captureState.photoDataUrl){
    capEls.err.textContent='Snap a photo first.';
    return;
  }
  const img=new Image();
  img.src=captureState.photoDataUrl;
  await new Promise((resolve,reject)=>{
    img.onload=resolve;
    img.onerror=()=>reject(new Error('Unable to load photo'));
  });
  captureState.resizedDataUrl = drawToCanvasMax(img,1200);
  captureState.uid = generateUID();
  captureState.md5 = md5FromDataUrl(captureState.resizedDataUrl);
  capEls.pillUid.textContent = 'UID: ' + captureState.uid;
  capEls.pillMd5.textContent = 'MD5: ' + captureState.md5.slice(0,10);
  capEls.btnSubmit.disabled=false;
  capEls.btnUse.style.display='none';
  capEls.btnSnap.style.display='inline-block';
}

function generateUID(){
  const base = crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(16)+Math.random().toString(16).slice(2));
  return 'ZM-' + base.replace(/-/g,'').slice(0,8).toUpperCase();
}

function md5FromDataUrl(dataUrl){
  const b64=dataUrl.split(',')[1];
  const bin=atob(b64);
  const bytes=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return md5ArrayBuffer(bytes);
}

function collectCaptureMeta(){
  return {
    'FABRIC':document.getElementById('CAP_FABRIC').value.trim().toUpperCase(),
    'COLOR':document.getElementById('CAP_COLOR').value.trim().toUpperCase(),
    'SIZE':document.getElementById('CAP_SIZE').value.trim().toUpperCase(),
    'ITEM TYPE':document.getElementById('CAP_ITEM_TYPE').value.trim().toUpperCase(),
    'WORK STYLE':document.getElementById('CAP_WORKSTYLE').value.trim().toUpperCase(),
    'WHOLESALE PRICE':document.getElementById('CAP_WHOLESALE').value || '',
    'QTY':document.getElementById('CAP_QTY').value || '',
    'SUPPLIERS':document.getElementById('CAP_VENDOR').value.trim().toUpperCase(),
    'DATE ORDERED':document.getElementById('CAP_DATE_ORDERED').value || '',
    'SOLD DATE':document.getElementById('CAP_SOLD_DATE').value || '',
    'STATUS':document.getElementById('CAP_STATUS').value.trim().toUpperCase()
  };
}

function validateCaptureMeta(meta){
  if(!captureState.resizedDataUrl) throw new Error('Capture and use a photo before uploading.');
  if(!captureState.uid || !captureState.md5) throw new Error('UID/MD5 missing. Click "Use Photo" again.');
  const type=meta['ITEM TYPE'];
  const sizes=document.getElementById('CAP_SIZE').value.split(',').map(s=>s.trim()).filter(Boolean);
  if(type!=='SAREE' && sizes.length===0) throw new Error('Select at least one size or provide custom sizes.');
  const status = meta['STATUS'];
  if(!status) throw new Error('Select a status for the item.');
  if(status === 'SOLD' && !meta['SOLD DATE']) throw new Error('Provide the sold date when status is SOLD.');
}

function computePricesFromWholesale(wholesaleVal){
  const num = Number(wholesaleVal);
  if (!Number.isFinite(num)) return null;
  const retail = ((num/85)*2)+8;
  const total = roundUpToNearest5(Math.round(retail*1.2));
  return {
    retail: Number(retail.toFixed(2)),
    total
  };
}

function roundUpToNearest5(value){
  const rounded = Math.round(value);
  const remainder = rounded % 5;
  return remainder === 0 ? rounded : rounded + (5 - remainder);
}

function updatePricePreview(){
  const wholesaleInput = document.getElementById('CAP_WHOLESALE');
  const retailInput = document.getElementById('CAP_RETAIL_PREVIEW');
  const totalInput = document.getElementById('CAP_TOTAL_PREVIEW');
  if (!wholesaleInput || !retailInput || !totalInput) return;
  const prices = computePricesFromWholesale(wholesaleInput.value);
  if (prices){
    retailInput.value = prices.retail.toFixed(2);
    totalInput.value = prices.total.toFixed(2);
  } else {
    retailInput.value = '';
    totalInput.value = '';
  }
}

async function submitCapture(){
  let overlayShown=false;
  if (capEls.err) capEls.err.textContent='';
  if (capEls.msg) capEls.msg.textContent='';
  try{
    const meta=collectCaptureMeta();
    validateCaptureMeta(meta);
    updatePricePreview();
    const priceInfo = computePricesFromWholesale(meta['WHOLESALE PRICE']);
    setCaptureBusy(true);
    if (capEls.msg) capEls.msg.textContent='Processing capture...';
    showProcessing('Processing...');
    overlayShown=true;
    let sizes=document.getElementById('CAP_SIZE').value.split(',').map(s=>s.trim()).filter(Boolean);
    if(meta['ITEM TYPE']==='SAREE') sizes=[''];
    if(!sizes.length) sizes=[''];
    const nowStr=new Date().toISOString().replace(/[:.TZ-]/g,'');
    const created=[];
    const failures=[];
    for (const size of sizes){
      const variantUid = size ? `${captureState.uid}-${size}` : captureState.uid;
      const codes = await generateCodes(variantUid);
      const metaWithSize = Object.assign({}, meta, { 'SIZE': size });
      if (priceInfo){
        metaWithSize['RETAIL PRICE'] = priceInfo.retail;
        metaWithSize['TOTAL SALE PRICE (USD)'] = priceInfo.total;
      }
      const payload = {
        uid: variantUid,
        md5: captureState.md5,
        meta: metaWithSize,
        photoBase64: dataUrlToBase64(captureState.resizedDataUrl),
        barcodeBase64: dataUrlToBase64(codes.barcodeDataUrl),
        qrBase64: dataUrlToBase64(codes.qrDataUrl),
        filenamePhoto: `${variantUid}_${nowStr}.jpg`,
        filenameBarcode: `${variantUid}_${nowStr}_barcode.png`,
        filenameQR: `${variantUid}_${nowStr}_qr.png`,
        barcodeFolderId: BARCODE_FOLDER_ID,
        barcodeFolderUrl: BARCODE_FOLDER_URL
      };
      try{
        const res = await new Promise((resolve,reject)=>
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .submitCapture(payload)
        );
        if (res && res.ok){
          created.push(res);
        } else {
          const msg = (res && res.message) ? res.message : 'Upload failed';
          failures.push(`${msg}${size ? ` (size ${size})` : ''}`);
        }
      }catch(err){
        failures.push(`${err && err.message ? err.message : 'Upload failed'}${size ? ` (size ${size})` : ''}`);
      }
    }
    if(created.length){
      const last=created[created.length-1];
      capEls.resultCard.style.display='block';
      capEls.resultText.textContent=`Uploaded ${created.length} variant(s).`;
      capEls.rowLink.href = last.rowUrl || '#';
      capEls.imageLink.href = (last.image && last.image.url) || '#';
      capEls.barcodeLink.href = (last.barcode && last.barcode.url) || '#';
      capEls.qrLink.href = (last.qr && last.qr.url) || '#';
      if (capEls.msg) capEls.msg.textContent = `Success! Generated barcode${created.length > 1 ? 's' : ''} and updated Sheets.`;
    } else if (capEls.msg){
      capEls.msg.textContent='';
    }
    if (failures.length){
      capEls.err.textContent = failures.join(' ');
    } else if (!created.length){
      capEls.err.textContent = 'No variants were uploaded.';
    }
  }catch(err){
    if (capEls.err) capEls.err.textContent = err.message || String(err);
  } finally {
    setCaptureBusy(false);
    if (overlayShown) hideProcessing();
  }
}

async function generateCodes(text){
  await drawCode128(capEls.barcodeCanvas,text);
  await drawMiniQR(capEls.qrCanvas,text);
  return {
    barcodeDataUrl: capEls.barcodeCanvas.toDataURL('image/png'),
    qrDataUrl: capEls.qrCanvas.toDataURL('image/png')
  };
}

function dataUrlToBase64(dataUrl){ return dataUrl.split(',')[1]; }
function setCaptureBusy(on){
  if (capEls.btnSubmit) capEls.btnSubmit.disabled = on;
}

async function drawMiniQR(canvas, text){
  const img=new Image();
  img.crossOrigin='anonymous';
  const url='https://quickchart.io/qr?light=ffffff&ecLevel=M&margin=2&size='+canvas.width+'&text='+encodeURIComponent(text);
  await new Promise((resolve,reject)=>{ img.onload=resolve; img.onerror=reject; img.src=url; });
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
}

async function drawCode128(canvas,text){
  if (!window.bwipjs) throw new Error('Barcode library not loaded.');
  const tmp=document.createElement('canvas');
  await bwipjs.toCanvas(tmp,{
    bcid:'code128',
    text:(text||'').toString(),
    includetext:true,
    textxalign:'center',
    scale:3,
    paddingwidth:10,
    paddingheight:10,
    backgroundcolor:'FFFFFF'
  });
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const h=canvas.height-10;
  const scale=Math.min(canvas.width/tmp.width,h/tmp.height);
  const w=Math.round(tmp.width*scale);
  const hh=Math.round(tmp.height*scale);
  const x=Math.floor((canvas.width-w)/2);
  const y=Math.floor((canvas.height-hh)/2);
  ctx.drawImage(tmp,x,y,w,hh);
}

function md5ArrayBuffer(bytes){
  function rotl(x,n){return (x<<n)|(x>>>(32-n));}
  function toHex(x){return ('00000000'+(x>>>0).toString(16)).slice(-8);}
  const len=bytes.length, bitLen=len*8;
  const withOne=new Uint8Array(((len+9+63)&~63));
  withOne.set(bytes,0);
  withOne[len]=0x80;
  const dv=new DataView(withOne.buffer);
  dv.setUint32(withOne.length-8, bitLen>>>0, true);
  dv.setUint32(withOne.length-4, Math.floor(bitLen/4294967296)>>>0, true);
  let a=0x67452301,b=0xefcdab89,c=0x98badcfe,d=0x10325476;
  const K=[0xd76aa478,0xe8c7b756,0x242070db,0xc1bdceee,0xf57c0faf,0x4787c62a,0xa8304613,0xfd469501,0x698098d8,0x8b44f7af,0xffff5bb1,0x895cd7be,0x6b901122,0xfd987193,0xa679438e,0x49b40821,0xf61e2562,0xc040b340,0x265e5a51,0xe9b6c7aa,0xd62f105d,0x02441453,0xd8a1e681,0xe7d3fbc8,0x21e1cde6,0xc33707d6,0xf4d50d87,0x455a14ed,0xa9e3e905,0xfcefa3f8,0x676f02d9,0x8d2a4c8a,0xfffa3942,0x8771f681,0x6d9d6122,0xfde5380c,0xa4beea44,0x4bdecfa9,0xf6bb4b60,0xbebfbc70,0x289b7ec6,0xeaa127fa,0xd4ef3085,0x04881d05,0xd9d4d039,0xe6db99e5,0x1fa27cf8,0xc4ac5665,0xf4292244,0x432aff97,0xab9423a7,0xfc93a039,0x655b59c3,0x8f0ccc92,0xffeff47d,0x85845dd1,0x6fa87e4f,0xfe2ce6e0,0xa3014314,0x4e0811a1,0xf7537e82,0xbd3af235,0x2ad7d2bb,0xeb86d391];
  const S=[7,12,17,22,7,12,17,22,7,12,17,22,7,12,17,22,5,9,14,20,5,9,14,20,5,9,14,20,5,9,14,20,4,11,16,23,4,11,16,23,4,11,16,23,4,11,16,23,6,10,15,21,6,10,15,21,6,10,15,21,6,10,15,21];
  for(let i=0;i<withOne.length;i+=64){
    let aa=a,bb=b,cc=c,dd=d;
    const X=new Array(16);
    for(let j=0;j<16;j++) X[j]=dv.getUint32(i+4*j,true);
    for(let j=0;j<64;j++){
      let f,g;
      if(j<16){ f=(b&c)|((~b)&d); g=j; }
      else if(j<32){ f=(d&b)|(c&(~d)); g=(5*j+1)%16; }
      else if(j<48){ f=b^c^d; g=(3*j+5)%16; }
      else { f=c^(b|(~d)); g=(7*j)%16; }
      const tmp=d;
      d=c;
      c=b;
      const t=(a+f+K[j]+X[g])|0;
      b=(b+((t<<S[j])|(t>>>(32-S[j]))))|0;
      a=tmp;
    }
    a=(a+aa)|0;
    b=(b+bb)|0;
    c=(c+cc)|0;
    d=(d+dd)|0;
  }
  return toHex(a)+toHex(b)+toHex(c)+toHex(d);
}


function cacheBarcodeEls(){
  barcodeEls.modal=document.getElementById('barcodeModal');
  barcodeEls.video=document.getElementById('barcodeVideo');
  barcodeEls.startBtn=document.getElementById('barcodeStartBtn');
  barcodeEls.stopBtn=document.getElementById('barcodeStopBtn');
  barcodeEls.value=document.getElementById('barcodeValue');
  barcodeEls.status=document.getElementById('barcodeScanStatus');
  barcodeEls.message=document.getElementById('barcodeResultMessage');
  barcodeEls.data=document.getElementById('barcodeRowData');
  barcodeEls.resultTable = document.getElementById('barcodeResultTable');
}

function initBarcodeUI(){
  cacheBarcodeEls();
  barcodeEls.startBtn.addEventListener('click', startBarcodeScanner);
  barcodeEls.stopBtn.addEventListener('click', stopBarcodeScanner);
}

function openBarcodeModal(){
  cacheBarcodeEls();
  barcodeEls.modal.style.display='block';
  barcodeEls.data.style.display='none';
  barcodeEls.resultTable.style.display = 'none';
  barcodeEls.value.textContent='';
  startBarcodeScanner();
}

function closeBarcodeModal(){
  barcodeEls.modal.style.display='none';
  stopBarcodeScanner();
}

function startBarcodeScanner(){
  if(!window.ZXing){
    barcodeEls.message.textContent='Barcode library not loaded.';
    return;
  }
  if(!barcodeReader){
    barcodeReader = new ZXing.BrowserMultiFormatReader();
  }
  barcodeEls.startBtn.disabled=true;
  barcodeEls.stopBtn.disabled=false;
  barcodeEls.status.textContent='Scanning...';
  barcodeEls.message.textContent='Aim the camera at the barcode.';
  barcodeReader.decodeFromVideoDevice(undefined,'barcodeVideo',(result)=>{
    if(result){
      handleBarcodeResult(result.getText());
    }
  }).then(controls=>{
    barcodeControls = controls;
  }).catch(err=>{
    barcodeEls.message.textContent = err.message || 'Unable to access camera.';
    barcodeEls.startBtn.disabled=false;
    barcodeEls.stopBtn.disabled=true;
  });
}

function stopBarcodeScanner(){
  if (barcodeControls){
    barcodeControls.stop();
    barcodeControls=null;
  }
  if (barcodeReader) barcodeReader.reset();
  if (barcodeEls.video && barcodeEls.video.srcObject){
    barcodeEls.video.srcObject.getTracks().forEach(t=>t.stop());
    barcodeEls.video.srcObject=null;
  }
  barcodeEls.startBtn.disabled=false;
  barcodeEls.stopBtn.disabled=true;
  barcodeEls.status.textContent='Scanner stopped.';
}

function normalizeBarcodeValue(raw){
  if (!raw) return '';
  const trimmed = raw.trim();
  // Keep only A-Z 0-9 and dashes; drop anything else (commas, slashes, etc.)
  return trimmed.toUpperCase().replace(/[^A-Z0-9-]/g, '');
}

function findLocalBarcodeMatch(value){
  const canon = normalizeBarcodeValue(value);
  if (!canon || !Array.isArray(window.allItems)) return null;
  return window.allItems.find(item => normalizeBarcodeValue(item.id) === canon) || null;
}

function fetchAllItemsAndMatch(canon){
  return new Promise((resolve) => {
    if (!canon) return resolve(null);
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      return resolve(null);
    }
    google.script.run
      .withSuccessHandler(res => {
        const items = Array.isArray(res)
          ? res
          : (res && Array.isArray(res.items) ? res.items : null);
        if (!items) return resolve(null);
        const mapped = items.map(item => typeof mapInventoryItem === 'function' ? mapInventoryItem(item) : item);
        window.allItems = mapped;
        resolve(findLocalBarcodeMatch(canon));
      })
      .withFailureHandler(() => resolve(null))
      .itemGetInventoryItems();
  });
}

async function handleBarcodeResult(text){
  const normalized = normalizeBarcodeValue(text);
  barcodeEls.value.textContent = normalized || text || '';
  stopBarcodeScanner();
  barcodeEls.status.textContent='Barcode detected.';
  barcodeEls.message.textContent='Fetching data...';
  barcodeEls.resultTable.style.display = 'none';
  barcodeEls.data.style.display='none';
  const payload = normalized || text;
  let localHit = findLocalBarcodeMatch(payload);
  if (localHit){
    barcodeEls.message.textContent='Matching record found.';
    renderBarcodeResultTable(localHit);
    return;
  }
  // Try fetching inventory once to satisfy local lookup before server call
  localHit = await fetchAllItemsAndMatch(normalized);
  if (localHit){
    barcodeEls.message.textContent='Matching record found.';
    renderBarcodeResultTable(localHit);
    return;
  }
  google.script.run
    .withSuccessHandler(res=>{
      if(res){
        barcodeEls.message.textContent='Matching record found.';
        const item = mapInventoryItem(res);
        renderBarcodeResultTable(item);
      } else {
        barcodeEls.message.textContent='No record found for this barcode.';
      }
    })
    .withFailureHandler(err=>{
      barcodeEls.message.textContent = err.message || 'Lookup failed.';
    })
    .lookupItemBasic(normalized || text);
}

function renderBarcodeResultTable(item) {
  if (!item) return;
  const priceDisplay = typeof formatCurrencyDisplay === 'function'
    ? formatCurrencyDisplay(item.price || item.totalSalePrice)
    : (item.price || item.totalSalePrice || '');
  const table = barcodeEls.resultTable.querySelector('table');
  table.innerHTML = `
    <thead>
      <tr><th>Attribute</th><th>Value</th></tr>
    </thead>
    <tbody>
      <tr><td>Item ID</td><td>${item.id || ''}</td></tr>
      <tr><td>Item Type</td><td>${item.type || ''}</td></tr>
      <tr><td>Price</td><td>${priceDisplay}</td></tr>
      <tr><td>Size</td><td>${item.size || ''}</td></tr>
      <tr><td>Fabric</td><td>${item.fabric || ''}</td></tr>
      <tr><td>Workstyle</td><td>${item.workstyle || ''}</td></tr>
      <tr><td>Remaining QTY</td><td>${item.remainingQty || 0}</td></tr>
      <tr><td>Status</td><td>${formatStatusLabel(item.status)}</td></tr>
    </tbody>
  `;
  barcodeEls.resultTable.style.display = 'block';
}

function mapInventoryItem(raw) {
  if (!raw) return null;
  const get = (keys) => {
    for (const key of keys) {
      if (raw[key] !== undefined) return raw[key];
      const normKey = key.toUpperCase().replace(/[^A-Z0-9]+/g, '_');
      if (raw[normKey] !== undefined) return raw[normKey];
    }
    return '';
  };
  return {
    id: get(['Item ID', 'UID', 'id', 'uid']),
    type: get(['Item Type', 'type']),
    fabric: get(['FABRIC', 'Item Category', 'fabric']),
    workstyle: get(['WORK STYLE', 'Item Subcategory', 'workstyle']),
    name: get(['Item Name', 'PRODUCT', 'name']),
    imageUrl: get(['IMAGE_URL', 'imageUrl']),
    color: get(['COLOR', 'color']),
    price: get(['TOTAL SALE PRICE (USD)', 'TOTAL SALE PRICE', 'TOTAL_SALE_PRICE_USD', 'totalSalePrice', 'price']),
    purchasedQty: Number(get(['QTY Purchased'])) || 0,
    soldQty: Number(get(['QTY Sold'])) || 0,
    remainingQty: Number(get(['Remaining QTY', 'QTY', 'quantity'])) || 0,
    status: get(['STATUS', 'status']),
    soldDate: get(['SOLD DATE', 'soldDate']),
    size: get(['SIZE', 'size'])
  };
}



function initNavigation() {
  navEls.inventory = document.getElementById('navInventory');
  navEls.summary = document.getElementById('navInventorySummary');
  navEls.dashboard = document.getElementById('navDashboard');
  navEls.suppliers = document.getElementById('navSuppliers');
  navEls.sales = document.getElementById('navSales');
  navEls.shipping = document.getElementById('navShipping');
  navEls.expenses = document.getElementById('navExpenses');

  if (navEls.inventory) {
    navEls.inventory.addEventListener('click', function (e) {
      e.preventDefault();
      showView('inventory');
    });
  }
  if (navEls.summary) {
    navEls.summary.addEventListener('click', function (e) {
      e.preventDefault();
      showView('summary');
    });
  }
  if (navEls.dashboard) {
    navEls.dashboard.addEventListener('click', function (e) {
      e.preventDefault();
      showView('dashboard');
    });
  }
  if (navEls.suppliers) {
    navEls.suppliers.addEventListener('click', function (e) {
      e.preventDefault();
      showView('suppliers');
    });
  }
  if (navEls.sales) {
    navEls.sales.addEventListener('click', function (e) {
      e.preventDefault();
      showView('sales');
    });
  }
  if (navEls.shipping) {
    navEls.shipping.addEventListener('click', function (e) {
      e.preventDefault();
      showView('shipping');
    });
  }
  if (navEls.expenses) {
    navEls.expenses.addEventListener('click', function (e) {
      e.preventDefault();
      showView('expenses');
    });
  }
}

function showView(view) {
  activeView = view;
  const inventory = document.getElementById('inventoryView');
  const summary = document.getElementById('inventorySummaryView');
  const dashboard = document.getElementById('dashboardView');
  const suppliers = document.getElementById('suppliersView');
  const sales = document.getElementById('salesView');
  const shipping = document.getElementById('shippingView');
  const expenses = document.getElementById('expensesView');

  const allViews = [inventory, summary, dashboard, suppliers, sales, shipping, expenses];
  allViews.forEach(v => {
    if (!v) return;
    v.classList.remove('active-view');
    v.style.display = 'none';
  });

  const activeMap = {
    inventory,
    summary,
    dashboard,
    suppliers,
    sales,
    shipping,
    expenses
  };
  const activeEl = activeMap[view];
  if (activeEl) {
    activeEl.style.display = 'block';
    activeEl.classList.add('active-view');
  }

  Object.keys(navEls).forEach(key => {
    if (navEls[key]) {
      navEls[key].classList.toggle('active', key === view);
    }
  });

  if (view === 'dashboard' && !dashboardState.loaded) {
    loadDashboardData();
  }
  if (view === 'suppliers') {
    supEnsureLoaded();
  }
  if (view === 'sales' && !salesState.loaded) {
    initSales();
  }
  if (view === 'shipping' && !shippingState.loaded) {
    initShipping();
  }
  if (view === 'expenses' && !expensesState.loaded) {
    initExpenses();
  }
  if (view === 'summary') {
    if (!summaryPivotRows.length) {
      loadSummaryFiltersAndData();
    } else {
      renderSummaryTable();
    }
  }
}


function bindEnterSearch(inputId, handler, clearHandler) {
  const element = document.getElementById(inputId);
  if (!element) return;
  element.addEventListener('keydown', function (event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      handler();
    } else if (event.key === 'Escape' && typeof clearHandler === 'function') {
      event.preventDefault();
      clearHandler();
    }
  });
}

document.addEventListener('DOMContentLoaded', function () {
  initNavigation();
  showView('inventory');
  loadTypes();
  loadCategories();
  loadSubcategories();
  loadInventoryItems();
  initCaptureUI();
  initBarcodeUI();

  $('#itemType').select2();
  $('#itemCategory').select2();
  $('#itemSubcategory').select2();

  const modalStatusSelect = document.getElementById('inventoryStatus');
  if (modalStatusSelect) {
    populateStatusSelect(modalStatusSelect, 'INSTOCK');
    modalStatusSelect.addEventListener('change', handleInventoryModalStatusChange);
    handleInventoryModalStatusChange();
  }

  const capBtn = document.getElementById('btnOpenCapture');
  if (capBtn) capBtn.addEventListener('click', openCaptureModal);

  const barcodeBtn = document.getElementById('btnOpenBarcode');
  if (barcodeBtn) barcodeBtn.addEventListener('click', openBarcodeModal);
  const printBtn = document.getElementById('btnPrintBarcodes');
  if (printBtn) printBtn.addEventListener('click', openBarcodePrintModal);

  const appShellEl = document.querySelector('.app-shell');
  if (appShellEl) {
    const sidebarToggles = document.querySelectorAll('.sidebar-toggle');
    sidebarToggles.forEach(toggle => {
      toggle.addEventListener('click', function () {
        const collapsed = appShellEl.classList.toggle('sidebar-collapsed');
        sidebarToggles.forEach(btn => btn.setAttribute('aria-expanded', (!collapsed).toString()));
      });
    });
  }

  initSuppliersUI();
  initInventoryBulkUpdateControls();

  bindEnterSearch('searchInput', searchItems, clearSearch);
  bindEnterSearch('summarySearchInput', searchSummaryItems, clearSummarySearch);
  bindEnterSearch('salesSearchInput', searchSales, clearSalesSearch);
  bindEnterSearch('shippingSearchInput', searchShipping, clearShippingSearch);
  bindEnterSearch('expensesSearchInput', searchExpenses, clearExpensesSearch);
});


</script>
<script>
  function sendHeight() {
    const height = document.body.scrollHeight;
    // Sends height to the parent window (Hostinger)
    window.parent.postMessage({ 'height': height }, "*");
  }

  // Send height when the page loads and whenever the window is resized
  window.addEventListener('load', sendHeight);
  window.addEventListener('resize', sendHeight);

  // Optional: Monitor content changes (e.g., loading images in your gallery)
  const observer = new ResizeObserver(sendHeight);
  observer.observe(document.body);
</script>

</body>
</html>


