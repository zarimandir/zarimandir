<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: 'Roboto', sans-serif;
      background: #ffffff;
      color: #1a1a1a;
    }
    body, button, input, select, textarea {
      font-family: 'Roboto', sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: #ffffff;
      color: #1a1a1a;
    }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .gallery-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1.5rem;
    }
    .gallery-logo {
      margin-right: auto;
    }
    .gallery-logo img {
      height: 50px;
      width: auto;
      display: block;
    }
    .category-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
    }
    .category-nav button {
      border: none;
      background: transparent;
      color: #666;
      padding: 0.5rem 0;
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      font-weight: 400;
      transition: color 0.2s ease;
      box-shadow: none;
      border-bottom: 2px solid transparent;
    }
    .category-nav button:hover {
      color: #000;
    }
    .category-nav button.active {
      background: transparent;
      color: #000;
      box-shadow: none;
      transform: none;
      border-bottom-color: #000;
    }
    .nav-placeholder {
      color: #999;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
    }
    .gallery-meta {
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #999;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
      padding: 0;
    }
    .filter-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #666;
    }
    .filter-control select {
      border: none;
      border-bottom: 1px solid #ddd;
      background: transparent;
      border-radius: 0;
      padding: 0.4rem 1.5rem 0.4rem 0;
      font-size: 0.9rem;
      color: #1a1a1a;
      min-width: 140px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 0 top 50%;
      background-size: 0.65em auto;
    }
    .filter-control select:focus {
      outline: none;
      border-bottom-color: #000;
    }
    #galleryArea {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2.5rem 1.5rem;
      margin-top: 1rem;
    }
    .card {
      background: transparent;
      border-radius: 0;
      overflow: visible;
      border: none;
      display: flex;
      flex-direction: column;
      min-height: auto;
      transition: opacity 0.3s ease;
    }
    .card:hover {
      transform: none;
      box-shadow: none;
      opacity: 0.9;
    }
    .image-wrapper {
      position: relative;
      margin-bottom: 1rem;
    }
    .card-images {
      display: flex;
      overflow-x: auto;
      gap: 0;
      scroll-behavior: smooth;
      scroll-snap-type: x mandatory;
      /* Hide scrollbar for cleaner look, but allow scrolling */
      scrollbar-width: none; 
      -ms-overflow-style: none;
    }
    .card-images::-webkit-scrollbar {
      display: none;
    }
    .card-images img {
      width: 100%;
      aspect-ratio: 3/4;
      height: auto;
      object-fit: cover;
      background: #f4f4f4;
      flex-shrink: 0;
      border-radius: 2px;
      scroll-snap-align: start;
      cursor: pointer;
    }
    .dots-container {
      position: absolute;
      bottom: 12px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 6px;
      pointer-events: none;
      z-index: 2;
    }
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.6);
      transition: all 0.2s ease;
      box-shadow: 0 0 2px rgba(255,255,255,0.5);
    }
    .dot.active {
      background-color: #007bff;
      transform: scale(1.2);
      box-shadow: none;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.8);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      font-size: 24px;
      color: #333;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      line-height: 1;
      padding-bottom: 4px;
    }
    .nav-btn:hover {
      background: rgba(255, 255, 255, 1);
    }
    .image-wrapper:hover .nav-btn {
      opacity: 1;
    }
    .nav-btn.prev { left: 8px; }
    .nav-btn.next { right: 8px; }
    @media (hover: none) {
      .nav-btn { display: none; }
    }
    .card-content {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex: 1;
    }
    .item-description {
      margin: 0;
      font-size: 1.0rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #1a1a1a;
      font-weight: 500;
    }
    .card-content .info-line {
      margin: 0;
      font-size: 0.8rem;
      color: #666;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .item-barcode {
      font-size: 0.75rem;
      color: #999;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }
    .status-note {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #F14D4B;
      font-weight: 700;
      margin-top: 0.25rem;
    }
    .empty-state {
      padding: 3rem;
      text-align: center;
      font-size: 1rem;
      color: #666;
      background: transparent;
      border: 1px solid #eee;
      border-radius: 0;
      grid-column: 1 / -1;
    }
    /* Lightbox */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      overflow: hidden; /* Prevent scrolling when not zoomed */
    }
    .lightbox.visible {
      opacity: 1;
    }
    /* Zoomed state for lightbox */
    .lightbox.active-zoom {
      display: block; /* Switch from flex to block to allow scrolling */
      overflow: auto; /* Enable scrolling */
      text-align: center;
    }
    .lightbox img {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      cursor: zoom-in; /* Indicate clickable */
      transition: transform 0.2s ease;
    }
    .lightbox.active-zoom img {
      max-width: none;
      max-height: none;
      object-fit: contain;
      cursor: zoom-out;
      margin: 20px auto; /* Center horizontally and add vertical space */
    }
    .lightbox-close {
      position: fixed; /* Keep close button fixed on screen even when scrolling */
      top: 20px;
      right: 30px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      z-index: 2001;
    }
    @media (max-width: 768px) {
      .app-shell {
        padding: 1.5rem 1rem;
      }
      .gallery-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        border-bottom: none;
        padding-bottom: 0;
      }
      .gallery-meta {
        font-size: 0.7rem;
      }
      .gallery-logo {
        margin-right: 0;
      }
      .category-nav {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        width: 100%;
        border-bottom: 1px solid #eee;
      }
      .category-nav button {
        flex-shrink: 0;
        font-size: 0.75rem;
      }
      .filters {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1rem;
        width: 100%;
      }
      .filter-control {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 130px;
      }
      .filter-control select {
        width: 100%;
        min-width: 0;
      }
      #galleryArea {
        grid-template-columns: repeat(auto-fill, minmax(135px, 1fr));
        gap: 1.5rem 0.75rem;
      }
      .card img {
        height: auto;
        margin-bottom: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <main class="app-shell">
    <div class="gallery-top">
      <div class="gallery-logo">
        <!-- Replace YOUR_LOGO_FILE_ID with the actual file ID of your logo image from the Drive folder -->
        <img src="https://drive.google.com/uc?export=view&id=YOUR_LOGO_FILE_ID" alt="ZariMandir" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <h2 style="display:none; margin:0; font-size:1.8rem; letter-spacing:0.05em;">ZARIMANDIR</h2>
      </div>
      <nav class="category-nav" id="folderMenu">
        <span class="nav-placeholder">Loading item folders…</span>
      </nav>
      <div class="gallery-meta" style="display:none;">
        <span id="galleryCount">Preparing the collection…</span>
      </div>
    </div>
    <section class="filters">
      <div class="filter-control">
        <label for="sizeFilter">Size</label>
        <select id="sizeFilter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="colorFilter">Color</label>
        <select id="colorFilter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="workFilter">Work Style</label>
        <select id="workFilter">
          <option value="">All</option>
        </select>
      </div>
    </section>
    <div id="galleryArea"></div>
  </main>

  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img id="lightbox-img" src="" alt="Zoomed Item" onclick="toggleZoom(event)">
  </div>

  <script>
    const placeholderImage = 'https://via.placeholder.com/400x300?text=No+Image';
    const SELECTORS = {
      galleryArea: 'galleryArea',
      folderMenu: 'folderMenu',
      sizeFilter: 'sizeFilter',
      colorFilter: 'colorFilter',
      workFilter: 'workFilter',
      galleryCount: 'galleryCount'
    };

    const state = {
      folders: [],
      activeIndex: 0,
      selectedSize: '',
      selectedColor: '',
      selectedWork: ''
    };

    function normalizeStatusValue(value) {
      return String(value || '').replace(/\s+/g, '').toUpperCase();
    }

    function setSelectOptions(selectEl, values = []) {
      if (!selectEl) return;
      const normalized = (values || []).map(value => String(value || '').trim()).filter(Boolean);
      const unique = Array.from(new Set(normalized)).sort((a, b) => a.localeCompare(b));
      selectEl.innerHTML = '<option value="">All</option>';
      unique.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectEl.appendChild(option);
      });
    }

    function applyFilters(items = []) {
      return (items || []).filter(item => {
        if (state.selectedSize && item.size !== state.selectedSize) return false;
        if (state.selectedWork && item.workStyle !== state.selectedWork) return false;
        if (state.selectedColor) {
          const target = state.selectedColor.toLowerCase();
          const colorValue = String(item.color || '').toLowerCase();
          if (!colorValue.includes(target)) return false;
        }
        return true;
      });
    }

    function getActiveFolder() {
      if (!state.folders.length) return null;
      const index = Math.max(0, Math.min(state.activeIndex, state.folders.length - 1));
      return state.folders[index];
    }

    function getGalleryGroupKey(item) {
      const uid = String(item.uid || '').trim();
      const baseUid = uid.replace(/[-_ ]?\d{2,3}$/, '').trim();
      if (baseUid) return `UID:${baseUid}`;
      const fileId = String(item.imageFileId || '').trim();
      if (fileId) return `FILE:${fileId}`;
      const imageUrl = String(item.imageUrl || '').trim();
      if (imageUrl) return `URL:${imageUrl}`;
      const itemType = String(item.itemType || '').trim();
      const color = String(item.color || '').trim();
      const work = String(item.workStyle || '').trim();
      return `META:${itemType}|${color}|${work}`;
    }

    function groupItemsForGallery(items = []) {
      const map = new Map();
      (items || []).forEach(item => {
        const key = getGalleryGroupKey(item);
        if (!map.has(key)) {
          map.set(key, { key, items: [], representative: item });
        }
        const entry = map.get(key);
        entry.items.push(item);
        if (!entry.representative.imageUrl && item.imageUrl) {
          entry.representative = item;
        }
      });
      return Array.from(map.values());
    }

    function getSortedSizes(items = []) {
      const availableItems = items.filter(item => normalizeStatusValue(item.status) !== 'SOLD');
      const sizes = Array.from(new Set(availableItems.map(item => String(item.size || '').trim()).filter(Boolean)));
      const getNum = (value) => {
        const match = String(value || '').match(/\d+/);
        return match ? Number(match[0]) : NaN;
      };
      sizes.sort((a, b) => {
        const na = getNum(a);
        const nb = getNum(b);
        if (!Number.isNaN(na) && !Number.isNaN(nb) && na !== nb) return na - nb;
        if (!Number.isNaN(na) && Number.isNaN(nb)) return -1;
        if (Number.isNaN(na) && !Number.isNaN(nb)) return 1;
        return a.localeCompare(b);
      });
      return sizes;
    }

    function renderGallery(folder, groups) {
      const gallery = document.getElementById(SELECTORS.galleryArea);
      if (!gallery) return;
      gallery.innerHTML = '';
      if (!folder || !groups.length) {
        gallery.innerHTML = '<div class="empty-state">No images match the current filters.</div>';
        return;
      }
      groups.forEach(group => {
        const item = group.representative;
        const card = document.createElement('article');
        card.className = 'card';
        
        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'image-wrapper';

        const imgContainer = document.createElement('div');
        imgContainer.className = 'card-images';
        
        // Collect images
        const imagesToRender = [];
        const seenUrls = new Set();
        
        const mainUrl = item.thumbnailUrl || item.imageUrl || placeholderImage;
        imagesToRender.push({ url: mainUrl, alt: item.uid || 'Item' });
        if (item.thumbnailUrl) seenUrls.add(item.thumbnailUrl);
        if (item.imageUrl) seenUrls.add(item.imageUrl);

        group.items.forEach(gItem => {
          if (gItem.additionalImages && gItem.additionalImages.length > 0) {
            gItem.additionalImages.forEach(extra => {
              if (!seenUrls.has(extra.url)) {
                seenUrls.add(extra.url);
                imagesToRender.push({ url: extra.url, alt: 'View' });
              }
            });
          }
        });
        
        // Render images
        imagesToRender.forEach(imgData => {
          const img = document.createElement('img');
          img.src = imgData.url;
          img.alt = imgData.alt;
          img.onclick = () => openLightbox(imgData.url);
          imgContainer.appendChild(img);
        });

        imgWrapper.appendChild(imgContainer);

        // Render dots
        if (imagesToRender.length > 0) {
          const dotsContainer = document.createElement('div');
          dotsContainer.className = 'dots-container';
          for (let i = 0; i < imagesToRender.length; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot' + (i === 0 ? ' active' : '');
            dotsContainer.appendChild(dot);
          }
          imgWrapper.appendChild(dotsContainer);

          // Scroll listener for dots
          imgContainer.addEventListener('scroll', () => {
            const width = imgContainer.clientWidth;
            if (width > 0) {
              const index = Math.round(imgContainer.scrollLeft / width);
              const dots = dotsContainer.children;
              for (let i = 0; i < dots.length; i++) {
                if (i === index) dots[i].classList.add('active');
                else dots[i].classList.remove('active');
              }
            }
          }, { passive: true });

          // Navigation arrows for mouse users
          if (imagesToRender.length > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.className = 'nav-btn prev';
            prevBtn.innerHTML = '&lsaquo;';
            prevBtn.onclick = (e) => {
              e.stopPropagation();
              imgContainer.scrollBy({ left: -imgContainer.clientWidth, behavior: 'smooth' });
            };
            const nextBtn = document.createElement('button');
            nextBtn.className = 'nav-btn next';
            nextBtn.innerHTML = '&rsaquo;';
            nextBtn.onclick = (e) => {
              e.stopPropagation();
              imgContainer.scrollBy({ left: imgContainer.clientWidth, behavior: 'smooth' });
            };
            imgWrapper.appendChild(prevBtn);
            imgWrapper.appendChild(nextBtn);
          }
        }
        
        card.appendChild(imgWrapper);

        const content = document.createElement('div');
        content.className = 'card-content';
        
        // Description: ITEM TYPE + FABRIC + WORK STYLE + "IN" + COLOR
        const descParts = [item.itemType, item.fabric, item.workStyle].filter(Boolean);
        let descText = descParts.join(' ');
        if (item.color) {
          descText += (descText ? ' IN ' : '') + item.color;
        }
        const desc = document.createElement('h3');
        desc.className = 'item-description';
        desc.textContent = descText || 'Item';
        content.appendChild(desc);

        if (item.status) {
          const status = document.createElement('span');
          status.className = 'status-note';
          status.textContent = item.status;
          content.appendChild(status);
        }
        const sizes = getSortedSizes(group.items);
        if (sizes.length) {
          const info = document.createElement('p');
          info.className = 'info-line';
          info.textContent = 'Sizes: ' + sizes.join(', ');
          content.appendChild(info);
        }
        
        const barcode = document.createElement('div');
        barcode.className = 'item-barcode';
        barcode.textContent = item.uid || folder.folderName || '';
        content.appendChild(barcode);

        card.appendChild(content);
        gallery.appendChild(card);
      });
    }

    function updateFilterOptions(folder) {
      if (!folder) return;
      const sizes = Array.from(new Set(folder.items.map(item => item.size).filter(Boolean)));
      const colors = Array.from(new Set(folder.items.map(item => item.color).filter(Boolean)));
      const works = Array.from(new Set(folder.items.map(item => item.workStyle).filter(Boolean)));
      setSelectOptions(document.getElementById(SELECTORS.sizeFilter), sizes);
      setSelectOptions(document.getElementById(SELECTORS.colorFilter), colors);
      setSelectOptions(document.getElementById(SELECTORS.workFilter), works);
      const colorSelect = document.getElementById(SELECTORS.colorFilter);
      const sizeSelect = document.getElementById(SELECTORS.sizeFilter);
      const workSelect = document.getElementById(SELECTORS.workFilter);
      if (sizeSelect) sizeSelect.value = state.selectedSize || '';
      if (colorSelect) colorSelect.value = state.selectedColor || '';
      if (workSelect) workSelect.value = state.selectedWork || '';
    }

    function updateGalleryCount(folder, filteredCount, totalCount) {
      const galleryCount = document.getElementById(SELECTORS.galleryCount);
      if (!galleryCount) return;
      if (!folder) {
        galleryCount.textContent = '0 ITEMS';
        return;
      }
      const total = typeof totalCount === 'number'
        ? totalCount
        : (Array.isArray(folder.items) ? folder.items.length : 0);
      const folderLabel = folder.folderName || 'Untitled';
      if (typeof filteredCount === 'number' && filteredCount !== total) {
        galleryCount.textContent = `${folderLabel} - Showing ${filteredCount} of ${total}`;
      } else {
        galleryCount.textContent = `${folderLabel} - ${total} ITEMS`;
      }
    }

    function updateMenuActiveState() {
      const buttons = document.getElementById(SELECTORS.folderMenu)?.querySelectorAll('button') || [];
      buttons.forEach((button, index) => {
        button.classList.toggle('active', index === state.activeIndex);
      });
    }

    function renderCurrentFolder() {
      const folder = getActiveFolder();
      const filteredItems = applyFilters(folder ? folder.items : []);
      const groupedFiltered = groupItemsForGallery(filteredItems);
      const groupedTotal = groupItemsForGallery(folder ? folder.items : []).length;
      renderGallery(folder, groupedFiltered);
      updateGalleryCount(folder, groupedFiltered.length, groupedTotal);
    }

    function handleFolderSelection(index) {
      state.activeIndex = index;
      const folder = getActiveFolder();
      updateFilterOptions(folder);
      updateMenuActiveState();
      renderCurrentFolder();
    }

    function renderMenu() {
      const menu = document.getElementById(SELECTORS.folderMenu);
      if (!menu) return;
      menu.innerHTML = '';
      if (!state.folders.length) {
        menu.innerHTML = '<span class="nav-placeholder">No item folders found.</span>';
        document.getElementById(SELECTORS.galleryArea).innerHTML = '<div class="empty-state">No inventory found.</div>';
        document.getElementById(SELECTORS.galleryCount).textContent = 'NO ITEMS';
        return;
      }
      state.folders.forEach((folder, index) => {
        const button = document.createElement('button');
        const countLabel = folder.count ? ` (${folder.count})` : '';
        button.type = 'button';
        button.textContent = `${folder.folderName || 'Untitled'}${countLabel}`;
        button.addEventListener('click', () => handleFolderSelection(index));
        menu.appendChild(button);
      });
      updateMenuActiveState();
      const folder = getActiveFolder();
      updateFilterOptions(folder);
      renderCurrentFolder();
    }

    function bindFilterListeners() {
      const sizeSelect = document.getElementById(SELECTORS.sizeFilter);
      const colorSelect = document.getElementById(SELECTORS.colorFilter);
      const workSelect = document.getElementById(SELECTORS.workFilter);

      if (sizeSelect) {
        sizeSelect.addEventListener('change', event => {
          state.selectedSize = event.target.value;
          renderCurrentFolder();
        });
      }
      if (colorSelect) {
        colorSelect.addEventListener('change', event => {
          state.selectedColor = event.target.value;
          renderCurrentFolder();
        });
      }
      if (workSelect) {
        workSelect.addEventListener('change', event => {
          state.selectedWork = event.target.value;
          renderCurrentFolder();
        });
      }
    }

    function handleData(response) {
      const rawFolders = Array.isArray(response.folders) ? response.folders : [];
      
      // Merge folders with the same name to prevent duplicates
      const mergedMap = new Map();
      
      rawFolders.forEach(folder => {
        // Filter out SOLD items
        const validItems = (folder.items || []).filter(item => normalizeStatusValue(item.status) !== 'SOLD');
        
        if (validItems.length === 0) return;

        const name = folder.folderName || 'Untitled';
        const key = name.trim().toUpperCase();
        
        if (!mergedMap.has(key)) {
          mergedMap.set(key, { ...folder, items: [...validItems], count: validItems.length });
        } else {
          const existing = mergedMap.get(key);
          existing.items.push(...validItems);
          existing.count += validItems.length;
        }
      });
      
      state.folders = Array.from(mergedMap.values());
      state.activeIndex = 0;
      state.selectedSize = '';
      state.selectedColor = '';
      state.selectedWork = '';
      renderMenu();
    }

    function handleError(err) {
      const menu = document.getElementById(SELECTORS.folderMenu);
      const gallery = document.getElementById(SELECTORS.galleryArea);
      const count = document.getElementById(SELECTORS.galleryCount);
      if (menu) menu.innerHTML = '';
      if (gallery) gallery.innerHTML = `<div class="empty-state">Failed to load gallery: ${err && err.message ? err.message : 'Unknown error'}</div>`;
      if (count) count.textContent = 'FAILED';
    }

    function init() {
      bindFilterListeners();
      google.script.run
        .withSuccessHandler(handleData)
        .withFailureHandler(handleError)
        .itemGetFoldersWithImages();
    }

    window.addEventListener('load', init);
  </script>

<script>
  function sendHeight() {
    const height = document.body.scrollHeight;
    // Sends height to the parent window (Hostinger)
    window.parent.postMessage({ 'height': height }, "*");
  }

  // Send height when the page loads and whenever the window is resized
  window.addEventListener('load', sendHeight);
  window.addEventListener('resize', sendHeight);

  // Optional: Monitor content changes (e.g., loading images in your gallery)
  const observer = new ResizeObserver(sendHeight);
  observer.observe(document.body);
</script>

</body>
</html>
