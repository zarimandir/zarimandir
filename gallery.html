<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: 'Lato', sans-serif;
      background: #ffffff;
      color: #1a1a1a;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: #ffffff;
      color: #1a1a1a;
    }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .gallery-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1.5rem;
    }
    .gallery-logo {
      margin-right: auto;
    }
    .gallery-logo img {
      height: 50px;
      width: auto;
      display: block;
    }
    .category-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
    }
    .category-nav button {
      border: none;
      background: transparent;
      color: #666;
      padding: 0.5rem 0;
      font-family: 'Lato', sans-serif;
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      font-weight: 400;
      transition: color 0.2s ease;
      box-shadow: none;
      border-bottom: 2px solid transparent;
    }
    .category-nav button:hover {
      color: #000;
    }
    .category-nav button.active {
      background: transparent;
      color: #000;
      box-shadow: none;
      transform: none;
      border-bottom-color: #000;
    }
    .nav-placeholder {
      color: #999;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
    }
    .gallery-meta {
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #999;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
      padding: 0;
    }
    .filter-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #666;
    }
    .filter-control select {
      border: none;
      border-bottom: 1px solid #ddd;
      background: transparent;
      border-radius: 0;
      padding: 0.4rem 1.5rem 0.4rem 0;
      font-size: 0.9rem;
      color: #1a1a1a;
      min-width: 140px;
      font-family: 'Lato', sans-serif;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 0 top 50%;
      background-size: 0.65em auto;
    }
    .filter-control select:focus {
      outline: none;
      border-bottom-color: #000;
    }
    #galleryArea {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2.5rem 1.5rem;
      margin-top: 1rem;
    }
    .card {
      background: transparent;
      border-radius: 0;
      overflow: visible;
      border: none;
      display: flex;
      flex-direction: column;
      min-height: auto;
      transition: opacity 0.3s ease;
    }
    .card:hover {
      transform: none;
      box-shadow: none;
      opacity: 0.9;
    }
    .card img {
      width: 100%;
      aspect-ratio: 3/4;
      height: auto;
      object-fit: cover;
      background: #f4f4f4;
      margin-bottom: 1rem;
    }
    .card-content {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex: 1;
    }
    .card-content h3 {
      margin: 0;
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #1a1a1a;
      font-weight: 600;
    }
    .card-content .info-line {
      margin: 0;
      font-size: 0.8rem;
      color: #666;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .status-note {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #F14D4B;
      font-weight: 700;
      margin-top: 0.25rem;
    }
    .empty-state {
      padding: 3rem;
      text-align: center;
      font-size: 1rem;
      color: #666;
      background: transparent;
      border: 1px solid #eee;
      border-radius: 0;
      grid-column: 1 / -1;
    }
    @media (max-width: 768px) {
      .app-shell {
        padding: 1.5rem 1rem;
      }
      .gallery-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        border-bottom: none;
        padding-bottom: 0;
      }
      .gallery-meta {
        font-size: 0.7rem;
      }
      .gallery-logo {
        margin-right: 0;
      }
      .category-nav {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        width: 100%;
        border-bottom: 1px solid #eee;
      }
      .category-nav button {
        flex-shrink: 0;
        font-size: 0.75rem;
      }
      .filters {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1rem;
        width: 100%;
      }
      .filter-control {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 130px;
      }
      .filter-control select {
        width: 100%;
        min-width: 0;
      }
      #galleryArea {
        grid-template-columns: repeat(auto-fill, minmax(135px, 1fr));
        gap: 1.5rem 0.75rem;
      }
      .card img {
        height: auto;
        margin-bottom: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <main class="app-shell">
    <div class="gallery-top">
      <div class="gallery-logo">
        <!-- Replace YOUR_LOGO_FILE_ID with the actual file ID of your logo image from the Drive folder -->
        <img src="https://drive.google.com/uc?export=view&id=YOUR_LOGO_FILE_ID" alt="ZariMandir" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <h2 style="display:none; margin:0; font-family:'Playfair Display',serif; font-size:1.8rem; letter-spacing:0.05em;">ZARIMANDIR</h2>
      </div>
      <nav class="category-nav" id="folderMenu">
        <span class="nav-placeholder">Loading item folders…</span>
      </nav>
      <div class="gallery-meta" style="display:none;">
        <span id="galleryCount">Preparing the collection…</span>
      </div>
    </div>
    <section class="filters">
      <div class="filter-control">
        <label for="sizeFilter">Size</label>
        <select id="sizeFilter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="colorFilter">Color</label>
        <select id="colorFilter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="workFilter">Work Style</label>
        <select id="workFilter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="statusFilter">Status</label>
        <select id="statusFilter">
          <option value="">All</option>
        </select>
      </div>
    </section>
    <div id="galleryArea"></div>
  </main>

  <script>
    const placeholderImage = 'https://via.placeholder.com/400x300?text=No+Image';
    const SELECTORS = {
      galleryArea: 'galleryArea',
      folderMenu: 'folderMenu',
      sizeFilter: 'sizeFilter',
      colorFilter: 'colorFilter',
      workFilter: 'workFilter',
      statusFilter: 'statusFilter',
      galleryCount: 'galleryCount'
    };

    const state = {
      folders: [],
      activeIndex: 0,
      selectedSize: '',
      selectedColor: '',
      selectedWork: '',
      selectedStatus: ''
    };

    function normalizeStatusValue(value) {
      return String(value || '').replace(/\s+/g, '').toUpperCase();
    }

    function setSelectOptions(selectEl, values = []) {
      if (!selectEl) return;
      const normalized = (values || []).map(value => String(value || '').trim()).filter(Boolean);
      const unique = Array.from(new Set(normalized)).sort((a, b) => a.localeCompare(b));
      selectEl.innerHTML = '<option value="">All</option>';
      unique.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectEl.appendChild(option);
      });
    }

    function applyFilters(items = []) {
      return (items || []).filter(item => {
        if (state.selectedSize && item.size !== state.selectedSize) return false;
        if (state.selectedWork && item.workStyle !== state.selectedWork) return false;
        if (state.selectedColor) {
          const target = state.selectedColor.toLowerCase();
          const colorValue = String(item.color || '').toLowerCase();
          if (!colorValue.includes(target)) return false;
        }
        if (state.selectedStatus) {
          const statusValue = normalizeStatusValue(item.status);
          if (statusValue !== state.selectedStatus) return false;
        }
        return true;
      });
    }

    function getActiveFolder() {
      if (!state.folders.length) return null;
      const index = Math.max(0, Math.min(state.activeIndex, state.folders.length - 1));
      return state.folders[index];
    }

    function getGalleryGroupKey(item) {
      const uid = String(item.uid || '').trim();
      const baseUid = uid.replace(/[-_ ]?\d{2,3}$/, '').trim();
      if (baseUid) return `UID:${baseUid}`;
      const fileId = String(item.imageFileId || '').trim();
      if (fileId) return `FILE:${fileId}`;
      const imageUrl = String(item.imageUrl || '').trim();
      if (imageUrl) return `URL:${imageUrl}`;
      const itemType = String(item.itemType || '').trim();
      const color = String(item.color || '').trim();
      const work = String(item.workStyle || '').trim();
      return `META:${itemType}|${color}|${work}`;
    }

    function groupItemsForGallery(items = []) {
      const map = new Map();
      (items || []).forEach(item => {
        const key = getGalleryGroupKey(item);
        if (!map.has(key)) {
          map.set(key, { key, items: [], representative: item });
        }
        const entry = map.get(key);
        entry.items.push(item);
        if (!entry.representative.imageUrl && item.imageUrl) {
          entry.representative = item;
        }
      });
      return Array.from(map.values());
    }

    function getSortedSizes(items = []) {
      const availableItems = items.filter(item => normalizeStatusValue(item.status) !== 'SOLD');
      const sizes = Array.from(new Set(availableItems.map(item => String(item.size || '').trim()).filter(Boolean)));
      const getNum = (value) => {
        const match = String(value || '').match(/\d+/);
        return match ? Number(match[0]) : NaN;
      };
      sizes.sort((a, b) => {
        const na = getNum(a);
        const nb = getNum(b);
        if (!Number.isNaN(na) && !Number.isNaN(nb) && na !== nb) return na - nb;
        if (!Number.isNaN(na) && Number.isNaN(nb)) return -1;
        if (Number.isNaN(na) && !Number.isNaN(nb)) return 1;
        return a.localeCompare(b);
      });
      return sizes;
    }

    function renderGallery(folder, groups) {
      const gallery = document.getElementById(SELECTORS.galleryArea);
      if (!gallery) return;
      gallery.innerHTML = '';
      if (!folder || !groups.length) {
        gallery.innerHTML = '<div class="empty-state">No images match the current filters.</div>';
        return;
      }
      groups.forEach(group => {
        const item = group.representative;
        const card = document.createElement('article');
        card.className = 'card';
        const img = document.createElement('img');
        img.src = item.thumbnailUrl || item.imageUrl || placeholderImage;
        img.alt = item.uid || folder.folderName || 'Inventory item';
        card.appendChild(img);
        const content = document.createElement('div');
        content.className = 'card-content';
        const title = document.createElement('h3');
        title.textContent = item.uid || folder.folderName || 'Item';
        content.appendChild(title);
        if (item.status) {
          const status = document.createElement('span');
          status.className = 'status-note';
          status.textContent = item.status;
          content.appendChild(status);
        }
        const sizes = getSortedSizes(group.items);
        if (sizes.length) {
          const info = document.createElement('p');
          info.className = 'info-line';
          info.textContent = 'Sizes: ' + sizes.join(', ');
          content.appendChild(info);
        }
        card.appendChild(content);
        gallery.appendChild(card);
      });
    }

    function updateFilterOptions(folder) {
      if (!folder) return;
      const sizes = Array.from(new Set(folder.items.map(item => item.size).filter(Boolean)));
      const colors = Array.from(new Set(folder.items.map(item => item.color).filter(Boolean)));
      const works = Array.from(new Set(folder.items.map(item => item.workStyle).filter(Boolean)));
      const statuses = Array.from(new Set(folder.items.map(item => normalizeStatusValue(item.status)).filter(Boolean)));
      setSelectOptions(document.getElementById(SELECTORS.sizeFilter), sizes);
      setSelectOptions(document.getElementById(SELECTORS.colorFilter), colors);
      setSelectOptions(document.getElementById(SELECTORS.workFilter), works);
      setSelectOptions(document.getElementById(SELECTORS.statusFilter), statuses);
      const colorSelect = document.getElementById(SELECTORS.colorFilter);
      const sizeSelect = document.getElementById(SELECTORS.sizeFilter);
      const workSelect = document.getElementById(SELECTORS.workFilter);
      if (sizeSelect) sizeSelect.value = state.selectedSize || '';
      if (colorSelect) colorSelect.value = state.selectedColor || '';
      if (workSelect) workSelect.value = state.selectedWork || '';
      const statusSelect = document.getElementById(SELECTORS.statusFilter);
      if (statusSelect) statusSelect.value = state.selectedStatus || '';
    }

    function updateGalleryCount(folder, filteredCount, totalCount) {
      const galleryCount = document.getElementById(SELECTORS.galleryCount);
      if (!galleryCount) return;
      if (!folder) {
        galleryCount.textContent = '0 ITEMS';
        return;
      }
      const total = typeof totalCount === 'number'
        ? totalCount
        : (Array.isArray(folder.items) ? folder.items.length : 0);
      const folderLabel = folder.folderName || 'Untitled';
      if (typeof filteredCount === 'number' && filteredCount !== total) {
        galleryCount.textContent = `${folderLabel} - Showing ${filteredCount} of ${total}`;
      } else {
        galleryCount.textContent = `${folderLabel} - ${total} ITEMS`;
      }
    }

    function updateMenuActiveState() {
      const buttons = document.getElementById(SELECTORS.folderMenu)?.querySelectorAll('button') || [];
      buttons.forEach((button, index) => {
        button.classList.toggle('active', index === state.activeIndex);
      });
    }

    function renderCurrentFolder() {
      const folder = getActiveFolder();
      const filteredItems = applyFilters(folder ? folder.items : []);
      const groupedFiltered = groupItemsForGallery(filteredItems);
      const groupedTotal = groupItemsForGallery(folder ? folder.items : []).length;
      renderGallery(folder, groupedFiltered);
      updateGalleryCount(folder, groupedFiltered.length, groupedTotal);
    }

    function handleFolderSelection(index) {
      state.activeIndex = index;
      const folder = getActiveFolder();
      updateFilterOptions(folder);
      updateMenuActiveState();
      renderCurrentFolder();
    }

    function renderMenu() {
      const menu = document.getElementById(SELECTORS.folderMenu);
      if (!menu) return;
      menu.innerHTML = '';
      if (!state.folders.length) {
        menu.innerHTML = '<span class="nav-placeholder">No item folders found.</span>';
        document.getElementById(SELECTORS.galleryArea).innerHTML = '<div class="empty-state">No inventory found.</div>';
        document.getElementById(SELECTORS.galleryCount).textContent = 'NO ITEMS';
        return;
      }
      state.folders.forEach((folder, index) => {
        const button = document.createElement('button');
        const countLabel = folder.count ? ` (${folder.count})` : '';
        button.type = 'button';
        button.textContent = `${folder.folderName || 'Untitled'}${countLabel}`;
        button.addEventListener('click', () => handleFolderSelection(index));
        menu.appendChild(button);
      });
      updateMenuActiveState();
      const folder = getActiveFolder();
      updateFilterOptions(folder);
      renderCurrentFolder();
    }

    function bindFilterListeners() {
      const sizeSelect = document.getElementById(SELECTORS.sizeFilter);
      const colorSelect = document.getElementById(SELECTORS.colorFilter);
      const workSelect = document.getElementById(SELECTORS.workFilter);
      const statusSelect = document.getElementById(SELECTORS.statusFilter);

      if (sizeSelect) {
        sizeSelect.addEventListener('change', event => {
          state.selectedSize = event.target.value;
          renderCurrentFolder();
        });
      }
      if (colorSelect) {
        colorSelect.addEventListener('change', event => {
          state.selectedColor = event.target.value;
          renderCurrentFolder();
        });
      }
      if (workSelect) {
        workSelect.addEventListener('change', event => {
          state.selectedWork = event.target.value;
          renderCurrentFolder();
        });
      }
      if (statusSelect) {
        statusSelect.addEventListener('change', event => {
          state.selectedStatus = normalizeStatusValue(event.target.value);
          renderCurrentFolder();
        });
      }
    }

    function handleData(response) {
      const rawFolders = Array.isArray(response.folders) ? response.folders : [];
      
      // Merge folders with the same name to prevent duplicates
      const mergedMap = new Map();
      
      rawFolders.forEach(folder => {
        const name = folder.folderName || 'Untitled';
        const key = name.trim().toUpperCase();
        
        if (!mergedMap.has(key)) {
          mergedMap.set(key, { ...folder, items: [...folder.items] });
        } else {
          const existing = mergedMap.get(key);
          existing.items.push(...folder.items);
          existing.count += folder.count;
        }
      });
      
      state.folders = Array.from(mergedMap.values());
      state.activeIndex = 0;
      state.selectedSize = '';
      state.selectedColor = '';
      state.selectedWork = '';
      state.selectedStatus = '';
      renderMenu();
    }

    function handleError(err) {
      const menu = document.getElementById(SELECTORS.folderMenu);
      const gallery = document.getElementById(SELECTORS.galleryArea);
      const count = document.getElementById(SELECTORS.galleryCount);
      if (menu) menu.innerHTML = '';
      if (gallery) gallery.innerHTML = `<div class="empty-state">Failed to load gallery: ${err && err.message ? err.message : 'Unknown error'}</div>`;
      if (count) count.textContent = 'FAILED';
    }

    function init() {
      bindFilterListeners();
      google.script.run
        .withSuccessHandler(handleData)
        .withFailureHandler(handleError)
        .itemGetFoldersWithImages();
    }

    window.addEventListener('load', init);
  </script>

<script>
  function sendHeight() {
    const height = document.body.scrollHeight;
    // Sends height to the parent window (Hostinger)
    window.parent.postMessage({ 'height': height }, "*");
  }

  // Send height when the page loads and whenever the window is resized
  window.addEventListener('load', sendHeight);
  window.addEventListener('resize', sendHeight);

  // Optional: Monitor content changes (e.g., loading images in your gallery)
  const observer = new ResizeObserver(sendHeight);
  observer.observe(document.body);
</script>

</body>
</html>
